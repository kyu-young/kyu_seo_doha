<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Îö±ÏàúÏù¥ Ìé∏ÏßëÍ∏∞">
  <meta name="theme-color" content="#007AFF">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="img/MainImage.png">
  <title>Îö±ÏàúÏù¥Ïùò ÏóëÏÖÄ Ìé∏ÏßëÍ∏∞</title>
  <style>
    /* üçé 2025 iOS Design System */
    :root {
      /* iOS System Colors */
      --ios-blue: #007AFF;
      --ios-purple: #AF52DE;
      --ios-pink: #FF2D55;
      --ios-red: #FF3B30;
      --ios-orange: #FF9500;
      --ios-green: #34C759;
      --ios-teal: #5AC8FA;
      
      /* System Grays */
      --ios-gray: #8E8E93;
      --ios-gray2: #AEAEB2;
      --ios-gray3: #C7C7CC;
      --ios-gray4: #D1D1D6;
      --ios-gray5: #E5E5EA;
      --ios-gray6: #F2F2F7;
      
      /* Semantic Colors */
      --bg: #F2F2F7;
      --bg-secondary: #FFFFFF;
      --panel: rgba(255, 255, 255, 0.7);
      --panel-solid: #FFFFFF;
      --accent: var(--ios-blue);
      --accent-2: var(--ios-purple);
      --border: var(--ios-gray5);
      --text: #000000;
      --text-secondary: #3C3C43;
      --text-tertiary: var(--ios-gray);
      --muted: var(--ios-gray);
      --good: var(--ios-green);
      --warn: var(--ios-orange);
      
      /* Glassmorphism */
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.3);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      
      /* Shadows */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.08);
      --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.1);
    }
    
    * { 
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body { height: 100%; }
    
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Apple SD Gothic Neo", "Noto Sans KR", "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 15px;
      line-height: 1.5;
    }
    .topbar {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 18px; border-bottom: 1px solid var(--border);
      background: var(--panel); position: sticky; top: 0; z-index: 10;
    }
    .topbar .title { font-weight: 700; letter-spacing: -0.2px; }
    .topbar .spacer { flex: 1; }
    button, .btn {
      appearance: none; border: 0; cursor: pointer;
      padding: 10px 14px; border-radius: 10px; font-weight: 600;
      background: var(--accent); color: #fff; transition: transform .05s ease, opacity .2s;
    }
    .btn { display: inline-flex; align-items: center; justify-content: center; line-height: 1.2; font-size: 14px; text-decoration: none; }
    .btn.primary, button.primary { background: var(--accent); color: #fff; border: 1px solid var(--accent); }
    .btn.secondary, button.secondary { background: #fff; color: var(--accent); border: 1px solid var(--accent); }
    .btn.warning { background: var(--warn); color: #fff; border: 1px solid var(--warn); }
    .btn.success { background:#10b981; color:#fff; border:1px solid #10b981; }
    .btn.danger { background:#ef4444; color:#fff; border:1px solid #ef4444; }
    .btn.toolbar { font-size:12px; padding:8px 12px; gap:6px; }
    .btn.toggle { background:#fff; color:#374151; border:1px solid var(--border); }
    .btn.toggle[aria-pressed="true"] { background:#ecfdf5; color:#047857; border-color:#a7f3d0; }
    button:hover { opacity: .95; }
    button:active { transform: translateY(1px); }

    .container { display: grid; grid-template-columns: 320px 1fr; gap: 0; height: calc(100vh - 62px); }
    .sidebar {
      border-right: 1px solid var(--border); background: #fff; overflow: hidden; display: flex; flex-direction: column;
    }
    .sidebar .search {
      padding: 12px; border-bottom: 1px solid var(--border);
    }
    .sidebar .status { padding: 10px 12px; border-bottom: 1px solid var(--border); background:#fff; position: relative; z-index: 1; display:flex; align-items:center; justify-content: space-between; gap:10px; }
    .status-chip { background:#eef2ff; color:#4f46e5; font-weight:700; font-size:12px; padding:4px 10px; border-radius:999px; letter-spacing:-0.2px; }
    .status-badge { display:inline-flex; align-items:center; gap:4px; background:#111827; color:#fff; font-weight:800; font-size:12px; padding:4px 8px; border-radius:10px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .status-badge.total { background:#111827; color:#fff; }
    .status-badge.target { background:#ecfdf5; color:#047857; border:1px solid #a7f3d0; box-shadow:none; }
    .status-badge.changed { background:#fdf2f8; color:#be185d; border:1px solid #fbcfe8; box-shadow:none; }
    .status-unit { opacity:.9; font-weight:700; font-size:12px; }
    .sidebar input[type="text"] {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      font-size: 14px; outline: none;
    }
    .list { overflow: auto; padding: 8px; }
    .item { padding: 10px 12px; border-radius: 10px; margin: 6px 4px; border: 1px solid var(--border); background: #fff; cursor: pointer; position: relative; }
    .item { cursor: grab; user-select: none; }
    .item:hover { background: #fafafa; }
    .item.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(139,92,246,.15) inset; }
    .item.changed { position: relative; }
    .item.soft-del { background:#fef2f2; border-color:#fecaca; }
    .item .name { font-weight: 700; font-size: 14px; }
    .item .url { font-size: 12px; color: var(--muted); word-break: break-all; }
    .item .badges { margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap; }
    .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: #f3f4f6; color: var(--muted); border: 1px solid var(--border); }
    .item.dragging { opacity: .6; }
    .drop-placeholder { height: 8px; border: 1px dashed var(--accent); border-radius: 6px; margin: 4px; }
    .item .actions { margin-top: 8px; display: flex; gap: 6px; }
    .btn-mini { font-size: 11px; padding: 4px 8px; border-radius: 999px; }
    .icon-btn { appearance:none; border:0; background:transparent; padding:6px; border-radius:8px; cursor:pointer; }
    .icon-btn:hover { background:#f3f4f6; }

    /* Row overlay delete icon */
    .del-ico { position:absolute; right:8px; top:8px; appearance:none; border:0; background:transparent; padding:4px; border-radius:6px; display:none; cursor:pointer; }
    .del-ico:hover { background:#f3f4f6; }
    .item:hover .del-ico, .item.active .del-ico { display:inline-flex; }
    .undo-ico { position:absolute; right:8px; top:8px; appearance:none; border:0; background:transparent; padding:4px; border-radius:6px; display:none; cursor:pointer; }
    .undo-ico:hover { background:#f3f4f6; }
    .del-ico { color:#ef4444; }
    .undo-ico { color:#6b7280; }
    .item.soft-del:hover .del-ico { display:none; }
    .item.soft-del:hover .undo-ico, .item.soft-del.active .undo-ico { display:inline-flex; }

    /* Segmented control for TRUE/FALSE */
    .seg { display: inline-flex; background:#f3f4f6; border-radius: 10px; padding: 4px; gap: 4px; }
    .seg-btn { appearance:none; border:0; padding:8px 12px; border-radius:8px; background:transparent; color:#374151; cursor:pointer; font-weight:700; font-size:13px; }
    .seg-btn.active[data-val="true"] { background:#ecfdf5; color:#047857; border:1px solid #a7f3d0; }
    .seg-btn.active[data-val="false"] { background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; }
    .badge.true { background: #ecfdf5; color: var(--good); border-color: #a7f3d0; }
    .badge.done { background: #eef2ff; color: #4f46e5; border-color: #c7d2fe; }
    .badge.comment { background: #ecfdf5; color: #059669; border-color: #a7f3d0; }
    .badge.warn { background: #fff7ed; color: #d97706; border-color: #fed7aa; }
    .badge.danger { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }

    .editor { display: grid; grid-template-columns: 1fr 1fr; height: 100%; }
    .pane { padding: 16px; overflow: auto; }
    .pane + .pane { border-left: 1px solid var(--border); background: #fff; }
    .section { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; margin-bottom: 12px; }
    .section h3 { margin: 0 0 10px; font-size: 14px; }
    label { font-weight: 700; font-size: 13px; display: inline-block; margin-bottom: 6px; }
    textarea, input[type="text"] {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); outline: none; resize: vertical; min-height: 44px;
      font-size: 14px; line-height: 1.5; background: #fff;
    }
    textarea.big { min-height: 120px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .col { flex: 1; min-width: 0; }
    .right-actions { display: flex; gap: 8px; align-items: center; }
    .hint { color: var(--muted); font-size: 12px; }

    .preview-head { display:flex; align-items:center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .preview {
      border: 1px dashed var(--border); border-radius: 12px; overflow: hidden; background: #f9fafb; height: calc(100% - 48px);
    }
    iframe { width: 100%; height: 100%; border: 0; background: #fff; }
    .reader { width: 100%; height: 100%; overflow: auto; background: #fff; border: 0; padding: 16px; }
    .reader h1, .reader h2, .reader h3 { margin: 12px 0 8px; }
    .reader p { margin: 6px 0; line-height: 1.6; }
    .reader a { color: var(--accent-2); text-decoration: underline; }
    .toolbox { padding: 16px; }
    .tool-card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; }
    .tool-card h4 { margin: 0 0 8px; font-size:13px; color:#374151; display:flex; align-items:center; justify-content:space-between; cursor:pointer; user-select:none; }
    .tool-card h4:hover { color:#8b5cf6; }
    .tool-card h4:hover .tool-card-toggle { color:#8b5cf6; }
    .tool-card-toggle { width:16px; height:16px; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:10px; transition:transform .2s, color .2s; }
    .tool-card.collapsed .tool-card-toggle { transform:rotate(-90deg); }
    .tool-card-body { overflow:hidden; transition:max-height .25s ease, opacity .2s ease; }
    .tool-card.collapsed .tool-card-body { max-height:0 !important; opacity:0; }
    .tool-row { display:flex; align-items:center; justify-content: space-between; gap:10px; padding:8px 0; border-top:1px solid #f3f4f6; }
    .tool-row:first-of-type { border-top:0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:#6b7280; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .btn-xs { appearance:none; border:1px solid #e5e7eb; background:#fff; color:#374151; padding:6px 10px; font-size:12px; border-radius:8px; cursor:pointer; }
    .btn-xs:hover { background:#f9fafb; }
    .btn-xs.active { background:#111827; color:#fff; border-color:#111827; }
    :root[data-theme="dark"] .btn-xs.active { background:#374151; color:#f9fafb; border-color:#374151; }
    .icon-btn { appearance:none; border:1px solid #e5e7eb; background:#fff; color:#374151; border-radius:8px; padding:6px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
    .icon-btn:hover { background:#f9fafb; }
    .icon-btn.disabled { opacity:.5; pointer-events:none; }
    /* Clear GPT button */
    #clearGptBtn:hover { background:#fee2e2; color:#ef4444; }
    /* Loading spinner */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spinner { display:inline-block; width:14px; height:14px; border:2px solid currentColor; border-right-color: transparent; border-radius:50%; animation: spin .8s linear infinite; vertical-align: -2px; }
    .btn-rec { background:#f59e0b; color:#fff; border:1px solid #f59e0b; }
    .btn-rec.active { background:#d97706; border-color:#d97706; color:#fff; }
    :root[data-theme="dark"] .btn-rec { background:#d97706; border-color:#d97706; color:#fff; }
    :root[data-theme="dark"] .btn-rec.active { background:#b45309; border-color:#b45309; }
    /* copy toast */
    .toast { position:fixed; left:50%; bottom:24px; transform:translate(-50%,20px) scale(.96); background:rgba(17,24,39,.96); color:#fff; padding:12px 16px; border-radius:12px; box-shadow:0 6px 22px rgba(0,0,0,.18); z-index:999999; opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease; display:none; font-weight:700; letter-spacing:-.2px; }
    .toast.show { display:block; opacity:1; transform:translate(-50%,0) scale(1); }
    /* Disabled nickname styling */
    #myNickInput[disabled] { background:#f3f4f6; color:#6b7280; border-color:#e5e7eb; cursor:not-allowed; }
    #myNickInput[disabled]::placeholder { color:#9ca3af; font-style: italic; }
    /* Drag & Drop highlight */
    .drop-active { outline: 2px dashed var(--accent); outline-offset: -10px; background: #f9fafb; }
    .drop-box { border:2px dashed #d1d5db; border-radius:12px; padding:16px; text-align:center; background:#fff; color:#374151; max-width: 520px; }
    .drop-title { font-weight:800; margin-top:8px; }
    .drop-sub { font-size:12px; color:#6b7280; margin-top:6px; }
    .drop-box svg { opacity:.7; }
    /* Spellcheck UI */
    .spell-panel { margin-top:10px; border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fafafa; max-height:200px; overflow:auto; }
    .spell-item { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding:8px; border-top:1px solid #f3f4f6; }
    .spell-item:first-of-type { border-top:0; }
    .spell-msg { font-size:13px; color:#374151; }
    .spell-context { font-size:12px; color:#6b7280; margin-top:4px; }
    .spell-apply { appearance:none; border:1px solid #e5e7eb; background:#fff; color:#111827; padding:6px 10px; font-size:12px; border-radius:8px; cursor:pointer; }
    .spell-apply:hover { background:#f9fafb; }
    .spell-btn { appearance:none; border:1px solid var(--border); background:#fff; color:#374151; padding:6px 10px; font-size:12px; border-radius:999px; display:inline-flex; align-items:center; gap:6px; cursor:pointer; }
    .spell-btn:hover { background:#f9fafb; border-color:#d1d5db; }
    .spell-btn[disabled] { opacity:.6; cursor:not-allowed; }
    .spell-btn .ico { width:14px; height:14px; opacity:.85; }
    /* Review panel */
    .review-card { margin-top:10px; border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fff; display:none; }
    .rev-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:6px 0; }
    .rev-left { display:flex; align-items:center; gap:8px; color:#374151; font-size:12px; }
    .rev-dot { width:8px; height:8px; border-radius:999px; background:#10b981; }
    .rev-pill { font-size:11px; font-weight:800; padding:3px 8px; border-radius:999px; border:1px solid transparent; }
    .rev-pass { color:#047857; background:#ecfdf5; border-color:#a7f3d0; }
    .rev-fail { color:#b91c1c; background:#fee2e2; border-color:#fecaca; }
    .btns-inline { margin-left:auto; display:flex; align-items:center; gap:8px; }

    .empty { height: 100%; display: grid; place-items: center; color: var(--muted); }
    .filelabel { color: var(--muted); font-size: 13px; }
    /* Inline edit button on input */
    .input-wrap { position: relative; }
    .input-wrap .icon-inline-btn { position:absolute; right:8px; top:50%; transform:translateY(-50%); appearance:none; border:1px solid #e5e7eb; background:#fff; color:#374151; padding:6px; border-radius:8px; cursor:pointer; }
    .input-wrap .icon-inline-btn:hover { background:#f9fafb; }
    .icon-16 { width:16px; height:16px; opacity:.85; }
    /* Dirty field highlight */
    .input-dirty { border-color:#f59e0b !important; background:#fffbeb !important; box-shadow:0 0 0 3px rgba(245,158,11,.15); }
    .seg-dirty { box-shadow:0 0 0 3px rgba(245,158,11,.15) inset; }

    /* Theme floating toggle */
    .theme-fab { position: fixed; right: 16px; bottom: 16px; z-index: 9999; appearance:none; border:1px solid var(--border); background:#fff; color:#374151; width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,.15); cursor:pointer; }
    .theme-fab:hover { background:#f9fafb; }
    .theme-fab[aria-pressed="true"] { background:#111827; color:#f9fafb; }

    /* Dark mode support */
    :root[data-theme="dark"] {
      --bg: #0f172a;
      --panel: #0b1220;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --accent: #8b5cf6;
      --accent-2: #ec4899;
    }
    :root[data-theme="dark"] body {
      background: linear-gradient(120deg, #0b1220, var(--bg));
      color: var(--text);
    }
    :root[data-theme="dark"] .sidebar { background: var(--panel); }
    :root[data-theme="dark"] .pane + .pane { background: var(--panel); }
    :root[data-theme="dark"] .item { background: var(--panel); border-color: var(--border); }
    :root[data-theme="dark"] .item:hover { background: #0f172a; }
    :root[data-theme="dark"] .badge { background: #111827; color: var(--muted); border-color: var(--border); }
    :root[data-theme="dark"] .badge.true { background:#0b3a2e; color:#34d399; border-color:#065f46; }
    :root[data-theme="dark"] .badge.done { background:#111827; color:#a5b4fc; border-color:#374151; }
    :root[data-theme="dark"] .badge.comment { background:#0b3a2e; color:#34d399; border-color:#065f46; }
    :root[data-theme="dark"] .badge.warn { background:#3b2a0a; color:#fbbf24; border-color:#92400e; }
    :root[data-theme="dark"] .badge.danger { background:#3b0a0a; color:#fca5a5; border-color:#7f1d1d; }
    :root[data-theme="dark"] .status { background: var(--panel); border-color: var(--border); }
    :root[data-theme="dark"] .status-chip { background:#1f2937; color:#a5b4fc; }
    :root[data-theme="dark"] .status-badge.total { background:#374151; color:#f9fafb; }
    :root[data-theme="dark"] .status-badge.target { background:#064e3b; color:#a7f3d0; border-color:#065f46; }
    :root[data-theme="dark"] .status-badge.changed { background:#3b0a1f; color:#f9a8d4; border-color:#831843; }
    :root[data-theme="dark"] .section { background: var(--panel); border-color: var(--border); }
    :root[data-theme="dark"] textarea, :root[data-theme="dark"] input[type="text"] { background:#0f172a; color: var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .spell-panel { background:#0f172a; border-color: var(--border); }
    :root[data-theme="dark"] .review-card { background:#0b1220; border-color: var(--border); }
    :root[data-theme="dark"] .btn.secondary, :root[data-theme="dark"] .btn.toolbar.secondary { background: transparent; color: var(--accent); border-color: var(--accent); }
    :root[data-theme="dark"] .btn.toggle { background: transparent; color:#e5e7eb; border-color: var(--border); }
    :root[data-theme="dark"] .btn.toggle[aria-pressed="true"] { background:#064e3b; color:#a7f3d0; border-color:#065f46; }
    :root[data-theme="dark"] .theme-fab { background:#0b1220; color:#e5e7eb; border-color:#1f2937; box-shadow:0 6px 18px rgba(0,0,0,.4); }
    :root[data-theme="dark"] .theme-fab:hover { background:#111827; }
    :root[data-theme="dark"] .preview { background:#0f172a; border-color: var(--border); }
    :root[data-theme="dark"] .toolbox { background:transparent; }
    :root[data-theme="dark"] .tool-card { background: var(--panel); border-color: var(--border); }
    :root[data-theme="dark"] .tool-row { border-color: var(--border); }
    :root[data-theme="dark"] .mono { color: var(--muted); }
    :root[data-theme="dark"] .btn-xs { background: transparent; color: var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .input-dirty { border-color:#f59e0b !important; background:#3b2f0a !important; box-shadow:0 0 0 3px rgba(245,158,11,.25); }
    :root[data-theme="dark"] .seg-dirty { box-shadow:0 0 0 3px rgba(245,158,11,.25) inset; }
    /* Dark: inputs and inline edit button */
    :root[data-theme="dark"] textarea, :root[data-theme="dark"] input[type="text"] { background:#0f172a; color: var(--text); border-color: var(--border); }
    :root[data-theme="dark"] #myNickInput[disabled] { background:#111827; color:#9ca3af; border-color:#374151; }
    :root[data-theme="dark"] #myNickInput[disabled]::placeholder { color:#6b7280; }
    :root[data-theme="dark"] .input-wrap .icon-inline-btn { background:transparent; color:var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .input-wrap .icon-inline-btn:hover { background:#111827; }
    /* Dark: badges & chips */
    :root[data-theme="dark"] .badge { background:#111827; color:#e5e7eb; border-color:#374151; }
    :root[data-theme="dark"] .badge.true { background:#064e3b; color:#34d399; border-color:#065f46; }
    :root[data-theme="dark"] .badge.done { background:#1f2937; color:#a5b4fc; border-color:#374151; }
    :root[data-theme="dark"] .badge.comment { background:#064e3b; color:#34d399; border-color:#065f46; }
    :root[data-theme="dark"] .badge.warn { background:#3b2a0a; color:#fbbf24; border-color:#92400e; }
    :root[data-theme="dark"] .badge.danger { background:#3b0a0a; color:#fca5a5; border-color:#7f1d1d; }
    :root[data-theme="dark"] .status-chip { background:#1f2937; color:#a5b4fc; }
    :root[data-theme="dark"] .status-badge.total { background:#374151; color:#f9fafb; }
    :root[data-theme="dark"] .status-badge.target { background:#064e3b; color:#a7f3d0; border-color:#065f46; }
    /* Dark: TRUE/FALSE segmented */
    :root[data-theme="dark"] .seg { background:#111827; }
    :root[data-theme="dark"] .seg-btn { color:#e5e7eb; }
    :root[data-theme="dark"] .seg-btn.active[data-val="true"] { background:#064e3b; color:#34d399; border-color:#065f46; }
    :root[data-theme="dark"] .seg-btn.active[data-val="false"] { background:#3b0a0a; color:#fca5a5; border-color:#7f1d1d; }
    /* Dark: spell/controls */
    :root[data-theme="dark"] .spell-btn { background:#0f172a; color:var(--text); border-color:var(--border); }
    :root[data-theme="dark"] .spell-btn:hover { background:#111827; border-color:#374151; }
    :root[data-theme="dark"] .spell-panel { background:#0f172a; border-color:#374151; }
    /* Dark: review pills */
    :root[data-theme="dark"] .rev-pass { color:#34d399; background:#064e3b; border-color:#065f46; }
    :root[data-theme="dark"] .rev-fail { color:#fca5a5; background:#3b0a0a; border-color:#7f1d1d; }
    /* Dark: URL modal chips */
    :root[data-theme="dark"] .chip { background:transparent; color:var(--text); border-color: var(--border); }
    :root[data-theme="dark"] .chip.active.true { background:#064e3b; color:#34d399; border-color:#065f46; }
    :root[data-theme="dark"] .chip.active.false { background:#3b0a0a; color:#fca5a5; border-color:#7f1d1d; }
    :root[data-theme="dark"] .chip.active[id="ufAll"] { background:#374151; color:#f9fafb; border-color:#374151; }
    :root[data-theme="dark"] .chip.toggle.active { background:#111827; color:#e5e7eb; border-color:#374151; }
    /* Dark: overlay action icons */
    :root[data-theme="dark"] .del-ico:hover, :root[data-theme="dark"] .undo-ico:hover { background:#1f2937; }
    :root[data-theme="dark"] .undo-ico { color:#9ca3af; }
    :root[data-theme="dark"] .drop-placeholder { border-color:#8b5cf6; }
    
    /* üì± Mobile Responsive Styles - ÏôÑÎ≤ΩÌïú UX */
    @media (max-width: 768px) {
      /* Í∏∞Î≥∏ Î†àÏù¥ÏïÑÏõÉ: Ï†ÑÏ≤¥ ÌôîÎ©¥ ÌôúÏö© */
      body { overflow: hidden; }
      .container { 
        grid-template-columns: 1fr; 
        height: calc(100vh - 62px); 
        height: calc(100dvh - 62px); /* ÎèôÏ†Å viewport height (Î™®Î∞îÏùº Ï£ºÏÜåÏ∞Ω Í≥†Î†§) */
      }
      
      /* üçé iOS Style Sidebar */
      .sidebar { 
        display: none; 
        border-right: 0; 
      }
      .sidebar.mobile-open { 
        display: flex; 
        position: fixed; 
        top: 0; 
        left: 0; 
        right: 0; 
        bottom: 0; 
        z-index: 100; 
        background: var(--bg);
        -webkit-overflow-scrolling: touch;
        padding-top: env(safe-area-inset-top, 0);
        animation: slideInFromLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @keyframes slideInFromLeft {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .sidebar .list { 
        -webkit-overflow-scrolling: touch;
        padding-bottom: 100px;
      }
      .sidebar .search {
        background: rgba(255, 255, 255, 0.8) !important;
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 0.5px solid var(--ios-gray5) !important;
        padding: 16px !important;
      }
      .sidebar .search input {
        border-radius: 12px !important;
        background: var(--ios-gray6) !important;
        border: none !important;
        padding: 10px 14px !important;
        font-size: 16px !important;
      }
      
      /* ÏóêÎîîÌÑ∞ ÏòÅÏó≠: ÏÑ∏Î°ú Î∞∞Ïπò + Ïä§ÌÅ¨Î°§ Í∞ÄÎä• */
      .editor { 
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: none !important;
        height: 100%;
        overflow-y: auto !important;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 100px; /* FAB Î≤ÑÌäº Í≥µÍ∞Ñ ÌôïÎ≥¥ */
      }
      
      /* Pane: ÏÑ∏Î°ú Î∞∞Ïπò, ÎÜíÏù¥ ÏûêÎèô, ÎÇ¥Ïö©ÎßåÌÅº ÎäòÏñ¥ÎÇ® */
      .pane { 
        padding: 16px; 
        overflow-y: visible !important;
        overflow-x: hidden;
        height: auto !important;
        min-height: 0 !important;
        flex-shrink: 0;
      }
      .pane + .pane { 
        border-left: 0; 
        border-top: 1px solid var(--border); 
      }
      
      /* Toolbox: ÎÜíÏù¥ Ï†úÌïú ÏóÜÏùå, ÎÇ¥Ïö© Ï†ÑÏ≤¥ ÌëúÏãú */
      .toolbox {
        overflow: visible !important;
        height: auto !important;
      }
      
      /* üçé iOS Style Topbar - Ïª¥Ìå©Ìä∏ & ÎØ∏ÎãàÎ©Ä */
      .topbar { 
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        padding: calc(env(safe-area-inset-top, 0px) + 10px) 16px 10px 16px !important;
        gap: 12px !important; 
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 0.5px solid var(--ios-gray5);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        min-height: 52px;
      }
      .topbar .title { 
        font-size: 16px !important; 
        font-weight: 700 !important;
        letter-spacing: -0.4px;
        color: var(--text);
        white-space: nowrap;
      }
      .topbar .spacer { 
        flex: 1 !important;
        min-width: 10px;
      }
      .topbar .filelabel { 
        font-size: 11px !important;
        color: var(--text-tertiary) !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
      }
      
      /* ÏÉÅÎã® Î≤ÑÌäºÎì§ Ïà®Í∏∞Í≥† Î©îÎâ¥ Î≤ÑÌäºÏúºÎ°ú ÎåÄÏ≤¥ */
      .topbar .btn.toolbar {
        display: none !important;
      }
      
      /* Î©îÎâ¥ Î≤ÑÌäº (Ïö∞Ï∏° ÏÉÅÎã®) */
      #mobileMenuBtn {
        display: flex !important;
        align-items: center;
        justify-content: center;
        width: 36px !important;
        height: 36px !important;
        padding: 0 !important;
        min-height: 36px !important;
        border-radius: 10px !important;
        background: var(--ios-gray6) !important;
        color: var(--text) !important;
        border: none !important;
      }
      
      /* üçé iOS Style Buttons */
      .btn.toolbar { 
        font-size: 13px !important; 
        padding: 10px 14px !important; 
        min-height: 44px;
        touch-action: manipulation;
        border-radius: 12px !important;
        background: var(--panel-solid) !important;
        color: var(--ios-blue) !important;
        font-weight: 600 !important;
        letter-spacing: -0.2px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
        border: 0.5px solid var(--ios-gray5) !important;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .btn.toolbar:active { 
        transform: scale(0.96);
        background: var(--ios-gray6) !important;
      }
      .btn.toolbar.primary {
        background: var(--ios-blue) !important;
        color: #fff !important;
        border: none !important;
        box-shadow: 0 2px 12px rgba(0, 122, 255, 0.25) !important;
      }
      .btn.toolbar.primary:active {
        background: #0051D5 !important;
      }
      .btn.toolbar svg { 
        width: 14px; 
        height: 14px; 
      }
      button, .btn { 
        padding: 10px 16px !important; 
        font-size: 15px !important; 
        min-height: 48px;
        touch-action: manipulation;
        border-radius: 14px !important;
        font-weight: 600 !important;
        letter-spacing: -0.3px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      button:active, .btn:active {
        transform: scale(0.96);
      }
      
      /* üçé Submit Segment (TRUE/FALSE Î≤ÑÌäº) */
      .seg-row {
        gap: 8px !important;
      }
      .seg-row button {
        flex: 1 !important;
        padding: 12px !important;
        font-size: 14px !important;
        border-radius: 12px !important;
        background: var(--ios-gray6) !important;
        color: var(--text-secondary) !important;
        border: 0.5px solid var(--ios-gray5) !important;
      }
      .seg-row button.active {
        background: var(--ios-blue) !important;
        color: #fff !important;
        border-color: var(--ios-blue) !important;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2) !important;
      }
      .seg-row button:active {
        transform: scale(0.96);
      }
      
      /* üçé iOS Style Sections & Cards */
      .section { 
        padding: 16px; 
        margin-bottom: 16px;
        border-radius: 18px !important;
        background: var(--panel-solid) !important;
        border: 0.5px solid var(--ios-gray5) !important;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04) !important;
      }
      .section h3 { 
        font-size: 15px; 
        font-weight: 700;
        letter-spacing: -0.3px;
        color: var(--text);
        margin-bottom: 12px !important;
      }
      .tool-card { 
        padding: 14px; 
        margin-bottom: 14px;
        border-radius: 16px !important;
        background: var(--panel-solid) !important;
        border: 0.5px solid var(--ios-gray5) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03) !important;
      }
      .tool-card h4 {
        font-size: 14px !important;
        font-weight: 600 !important;
        letter-spacing: -0.2px !important;
        color: var(--text) !important;
      }
      
      /* üçé iOS Style Form Elements */
      label { 
        font-size: 13px; 
        font-weight: 600;
        letter-spacing: -0.2px;
        color: var(--text);
      }
      textarea, input[type="text"] { 
        font-size: 14px !important; /* ÏùΩÍ∏∞ Ï¢ãÏùÄ ÌÅ¨Í∏∞ */
        padding: 10px 12px !important; 
        line-height: 1.4;
        -webkit-appearance: none;
        border-radius: 12px !important;
        background: var(--panel-solid) !important;
        border: 0.5px solid var(--ios-gray5) !important;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04) !important;
        transition: all 0.2s;
        color: var(--text) !important;
      }
      textarea:focus, input[type="text"]:focus { 
        outline: none !important;
        border-color: var(--ios-blue) !important;
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1),
                    inset 0 1px 2px rgba(0, 0, 0, 0.04) !important;
      }
      textarea { 
        resize: vertical; 
        min-height: 100px;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Î≥∏Î¨∏/GPT ÎãµÎ≥Ä ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï */
      #bodyInput, #gptInput {
        font-size: 14px !important;
        line-height: 1.5 !important;
      }
      
      /* üçé iOS Style Preview Section */
      .preview-head {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 10px !important;
      }
      .preview-head .hint {
        font-size: 12px !important;
      }
      .preview-head .right-actions {
        width: 100% !important;
        margin-left: 0 !important;
      }
      .preview-head #openNewTab {
        width: 100% !important;
        justify-content: center !important;
        background: var(--ios-blue) !important;
        color: #fff !important;
        border: none !important;
        padding: 12px 16px !important;
        font-size: 14px !important;
        font-weight: 600 !important;
        box-shadow: 0 2px 12px rgba(0, 122, 255, 0.25) !important;
      }
      .preview-head #openNewTab:active {
        transform: scale(0.98) !important;
      }
      .preview { 
        height: 250px; 
        -webkit-overflow-scrolling: touch;
        border-radius: 16px !important;
        border: 0.5px solid var(--ios-gray5) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
      }
      
      /* Î™®Îã¨: Ï†ÑÏ≤¥ ÌôîÎ©¥ ÌôúÏö© */
      .modal-card { 
        width: 96vw; 
        max-width: 96vw;
        max-height: 85vh; 
        max-height: 85dvh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .modal-body { 
        padding: 12px; 
      }
      .url-list-box { 
        height: 180px; 
        font-size: 12px; 
        line-height: 1.6;
        -webkit-overflow-scrolling: touch;
      }
      
      /* üçé iOS Style Items (List) */
      .item { 
        padding: 14px; 
        margin: 8px 12px; 
        min-height: 72px;
        border-radius: 16px !important;
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(0, 122, 255, 0.08);
        background: var(--panel-solid) !important;
        border: 0.5px solid var(--ios-gray5) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03) !important;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .item:active { 
        transform: scale(0.98);
        background: var(--ios-gray6) !important;
      }
      .item.active {
        background: rgba(0, 122, 255, 0.08) !important;
        border-color: var(--ios-blue) !important;
        box-shadow: 0 2px 12px rgba(0, 122, 255, 0.15) !important;
      }
      .item .name { 
        font-size: 15px; 
        line-height: 1.4;
        font-weight: 600;
        letter-spacing: -0.3px;
        color: var(--text);
      }
      .item .url { 
        font-size: 12px; 
        margin-top: 6px;
        color: var(--text-tertiary);
        line-height: 1.3;
      }
      .badge { 
        font-size: 11px; 
        padding: 4px 8px;
        border-radius: 8px !important;
        font-weight: 600;
        letter-spacing: -0.1px;
      }
      
      /* üçé iOS Style FAB Buttons */
      .theme-fab { 
        right: 16px; 
        bottom: env(safe-area-inset-bottom, 16px);
        bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
        width: 54px; 
        height: 54px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 
                    0 2px 8px rgba(0, 0, 0, 0.08),
                    inset 0 1px 1px rgba(255, 255, 255, 0.5);
        border: 0.5px solid rgba(255, 255, 255, 0.8);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .theme-fab:active {
        transform: scale(0.92);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }
      .theme-fab svg {
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
      }
      
      .mobile-sidebar-toggle { 
        display: block; 
        position: fixed; 
        left: 16px; 
        bottom: env(safe-area-inset-bottom, 16px);
        bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
        z-index: 99; 
        width: 54px; 
        height: 54px; 
        border-radius: 50%;
        background: var(--ios-blue) !important;
        color: #fff; 
        border: 0;
        box-shadow: 0 8px 32px rgba(0, 122, 255, 0.35),
                    0 2px 8px rgba(0, 122, 255, 0.25);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mobile-sidebar-toggle:active {
        transform: scale(0.92);
        box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
      }
      .mobile-sidebar-toggle svg {
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
      }
      
      .mobile-sidebar-toggle .badge-count {
        position: absolute;
        top: -6px;
        right: -6px;
        background: var(--ios-red);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        min-width: 24px;
        height: 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 6px;
        box-shadow: 0 2px 8px rgba(255, 59, 48, 0.4),
                    0 0 0 2px var(--bg);
        border: 2px solid var(--bg);
      }
      
      /* Ïπ©/ÌÉ≠ Î≤ÑÌäº: ÌÑ∞Ïπò ÏµúÏ†ÅÌôî */
      .chip, .main-tab {
        min-height: 40px !important;
        padding: 10px 14px !important;
        font-size: 13px !important;
        touch-action: manipulation;
      }
      
      /* üçé iOS Style Overlay - Îçî ÏßÑÌïòÍ≥† Î™ÖÌôïÌïòÍ≤å */
      .mobile-overlay { 
        display: none; 
        position: fixed; 
        inset: 0; 
        background: rgba(0, 0, 0, 0.65); /* 40% ‚Üí 65%Î°ú ÏßÑÌïòÍ≤å! */
        z-index: 99; 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        animation: fadeIn 0.25s ease-out;
        transition: opacity 0.25s ease-out;
      }
      .mobile-overlay.show { 
        display: block; 
        opacity: 1;
      }
      @keyframes fadeIn {
        from { 
          opacity: 0; 
          backdrop-filter: blur(0);
          -webkit-backdrop-filter: blur(0);
        }
        to { 
          opacity: 1; 
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        }
      }
      
      /* üçé Mobile Menu Modal */
      .mobile-menu-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 200;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        animation: fadeIn 0.2s ease-out;
      }
      .mobile-menu-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--panel-solid);
        border-radius: 20px 20px 0 0;
        padding: env(safe-area-inset-bottom, 20px) 0 20px 0;
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      .mobile-menu-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 20px 16px 20px;
        border-bottom: 0.5px solid var(--ios-gray5);
      }
      .mobile-menu-header h3 {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: -0.4px;
        margin: 0;
      }
      .mobile-menu-header .close-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: var(--ios-gray6);
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .mobile-menu-header .close-btn:active {
        transform: scale(0.9);
      }
      .mobile-menu-items {
        padding: 8px 12px;
      }
      .mobile-menu-item {
        width: 100%;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 16px;
        margin-bottom: 8px;
        border: none;
        border-radius: 14px;
        background: var(--ios-gray6);
        color: var(--text);
        font-size: 16px;
        font-weight: 600;
        letter-spacing: -0.3px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .mobile-menu-item:active {
        transform: scale(0.97);
        background: var(--ios-gray5);
      }
      .mobile-menu-item svg {
        color: var(--ios-blue);
      }
      
      /* Ïä§ÌÅ¨Î°§Î∞î Ïà®ÍπÄ (ÍπîÎÅîÌïú UI) */
      .editor::-webkit-scrollbar,
      .sidebar .list::-webkit-scrollbar,
      .pane::-webkit-scrollbar { 
        display: none; 
      }
      
      /* Toolbox: Î™®Î∞îÏùºÏóêÏÑú Ïä§ÌÅ¨Î°§ Í∞ÄÎä• */
      .toolbox { 
        overflow-y: visible; 
      }
      
      /* Îç∞Ïä§ÌÅ¨ÌÜ±ÏóêÏÑúÎßå ÌÜ†Í∏Ä Î≤ÑÌäº Ïà®ÍπÄ */
      @media (min-width: 769px) { 
        .mobile-sidebar-toggle { 
          display: none; 
        } 
      }
    }
  </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Note: For best save UX, open this file in Chrome. -->
</head>
<body>
    <div class="topbar">
    <div class="title">Îö±ÏàúÏù¥ Ìé∏ÏßëÍ∏∞</div>
    <span class="filelabel" id="fileLabel">ÌååÏùº ÎØ∏ÏÑ†ÌÉù</span>
    <div class="spacer"></div>
    
    <!-- Î™®Î∞îÏùº Î©îÎâ¥ Î≤ÑÌäº (Î™®Î∞îÏùºÏóêÏÑúÎßå ÌëúÏãú) -->
    <button id="mobileMenuBtn" class="btn" title="Î©îÎâ¥" style="display:none;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
        <circle cx="12" cy="6" r="1.5" fill="currentColor"/>
        <circle cx="12" cy="18" r="1.5" fill="currentColor"/>
      </svg>
    </button>
    
    <!-- Îç∞Ïä§ÌÅ¨ÌÜ± Î≤ÑÌäºÎì§ (Î™®Î∞îÏùºÏóêÏÑú Ïà®ÍπÄ) -->
    <button id="openBtn" class="btn primary toolbar" title="ÌååÏùº Ïó¥Í∏∞">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h5l2 2h11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      ÌååÏùº Ïó¥Í∏∞
    </button>
    
    <button class="btn secondary toolbar" id="saveBtn" title="Ï†ÄÏû•">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2"/><path d="M7 3v6h8V3" stroke="currentColor" stroke-width="2"/><path d="M7 18h10" stroke="currentColor" stroke-width="2"/></svg>
      Ï†ÄÏû•
    </button>
    <button class="btn secondary toolbar" id="saveAsBtn" title="Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•
    </button>
    <button class="btn toolbar toggle" id="autoSaveBtn" title="1Î∂ÑÎßàÎã§ ÏûêÎèô Ï†ÄÏû•" aria-pressed="false" disabled>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 8v5l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2"/></svg>
      ÏûêÎèô Ï†ÄÏû•
    </button>
    <button id="urlManagerBtn" class="btn secondary toolbar" title="URL Í¥ÄÎ¶¨" disabled>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 1 7-7l1 1m-4 10a5 5 0 0 1-7 7l-1-1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      URL Í¥ÄÎ¶¨
    </button>
    <button class="btn success toolbar" id="submitConfirmBtn" title="Ïª®Ìéå Ï†úÏ∂ú" disabled>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12l4 4L19 6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Ïª®Ìéå Ï†úÏ∂ú
    </button>
    <button class="btn warning toolbar" id="applyConfirmBtn" title="Ïª®Ìéå Î∞òÏòÅ" disabled>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14m7-7H5" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
      Ïª®Ìéå Î∞òÏòÅ
    </button>
  </div>
  <div class="container">
    <aside class="sidebar">
      <div class="search">
        <input type="text" id="searchInput" placeholder="Ïπ¥ÌéòÎ™Ö ÎòêÎäî URL Í≤ÄÏÉâ" style="width:100%;" />
      </div>
      <div class="status" style="flex-direction: column; align-items: stretch; gap:8px;">
        <div style="display:flex; align-items:center; justify-content: space-between; width:100%; gap:10px;">
          <span class="status-chip">Ï†ÑÏ≤¥</span>
          <span class="status-badge total"><span id="totalCountNum">0</span><span class="status-unit">Í±¥</span></span>
        </div>
        <div style="display:flex; align-items:center; justify-content: space-between; width:100%; gap:10px;">
          <span class="status-chip">ÎãµÎ≥Ä Ï†úÏ∂ú ÎåÄÏÉÅ</span>
          <span class="status-badge target"><span id="targetCountNum">0</span><span class="status-unit">Í±¥</span></span>
        </div>
        <div style="display:flex; align-items:center; justify-content: space-between; width:100%; gap:10px;">
          <span class="status-chip">ÎØ∏Ï†ÄÏû• Î≥ÄÍ≤Ω ÎåÄÏÉÅ</span>
          <span class="status-badge changed"><span id="changedCountNum">0</span><span class="status-unit">Í±¥</span></span>
        </div>
      </div>
      <div class="list" id="itemList"></div>
    </aside>
    <main class="editor">
      <section class="pane" id="leftPane">
        <div class="empty" id="emptyStateLeft">
          <div>
            <div class="drop-box" id="dropHint">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 16V4m0 0l-4 4m4-4l4 4M6 20h12a2 2 0 002-2v-3a2 2 0 00-2-2h-1.5" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <div class="drop-title">Ïó¨Í∏∞Ïóê ÏóëÏÖÄ ÌååÏùºÏùÑ ÎÅåÏñ¥Îã§ ÎÜìÏïÑ Ïó¥Í∏∞</div>
              <div class="drop-sub">.xlsx/.xls ÏßÄÏõê ¬∑ ÎòêÎäî ÏÉÅÎã® 'ÌååÏùº Ïó¥Í∏∞' Î≤ÑÌäº ÏÇ¨Ïö©</div>
            </div>
            <div class="drop-sub" style="text-align:center; margin-top:12px;">Ï¢åÏ∏° Î™©Î°ùÏóêÏÑú Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>
          </div>
        </div>
        <div id="editorPanel" style="display:none;">
          <div class="section">
            <div class="row" style="justify-content: space-between;">
              <div class="hint" id="rowInfo"></div>
              <div class="right-actions">
                <div class="seg" id="submitSeg">
                  <button type="button" class="seg-btn" data-val="true">TRUE</button>
                  <button type="button" class="seg-btn" data-val="false">FALSE</button>
                </div>
              </div>
            </div>
          </div>
          <div class="section">
            <div class="row">
              <div class="col">
                <label>Ïπ¥ÌéòÎ™Ö</label>
                <input type="text" id="cafeInput" placeholder="Ïπ¥ÌéòÎ™Ö ÏàòÏ†ï" />
              </div>
              <div class="col">
                <label>ÎÇòÏùò ÎãâÎÑ§ÏûÑ</label>
                <div class="input-wrap">
                  <input type="text" id="myNickInput" placeholder="ÎÇòÏùò ÎãâÎÑ§ÏûÑ" disabled />
                  <button type="button" id="nickEditBtn" class="icon-inline-btn" title="ÎãâÎÑ§ÏûÑ ÏàòÏ†ï">
                    <svg class="icon-16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 20h9" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/><path d="M16.5 3.5l4 4L8 20H4v-4L16.5 3.5z" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="section">
            <label>Ï†úÎ™©</label>
            <textarea id="titleInput" placeholder="Ï†úÎ™© Ìé∏Ïßë(Ï†ÄÏû•ÏùÄ gpt/Ï†úÏ∂úÎßå)"></textarea>
          </div>
          <div class="section">
            <label>Î≥∏Î¨∏ÎÇ¥Ïö©</label>
            <textarea id="bodyInput" class="big" placeholder="Î≥∏Î¨∏ Ìé∏Ïßë(Ï†ÄÏû•ÏùÄ gpt/Ï†úÏ∂úÎßå)"></textarea>
          </div>
          <div class="section">
            <label>Î∏åÎûúÎìú</label>
            <input type="text" id="brandInput" placeholder="Î∏åÎûúÎìú ÏûÖÎ†•" />
          </div>
          <div class="section">
              <div class="row spell-head" style="justify-content: space-between; align-items:center; margin-bottom:12px;">
               <label>GPT ÎãµÎ≥Ä</label>
               <div class="btns-inline">
                  <button type="button" id="spellCheckBtn" class="spell-btn" title="ÎßûÏ∂§Î≤ï Í≤ÄÏÇ¨">
                    <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h10M4 11h8M4 15h6" stroke="#374151" stroke-width="2" stroke-linecap="round"/><path d="M21 16l-3 3-2-2" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    ÎßûÏ∂§Î≤ï
                  </button>
                  <button type="button" id="reviewBtn" class="spell-btn" title="Í≤ÄÏàò">
                    <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Í≤ÄÏàò
                  </button>
                  <button type="button" id="kwBtn" class="spell-btn" title="ÌÇ§ÏõåÎìú Í≤ÄÏàò">
                    <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 4H6a2 2 0 00-2 2v5m7-7l7 7m-7-7v5a2 2 0 002 2h5" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    ÌÇ§ÏõåÎìú
                  </button>
               </div>
              </div>
             <div style="position:relative;">
               <textarea id="gptInput" class="big" placeholder="Ïó¨Í∏∞Ïóê GPT ÎãµÎ≥ÄÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî" style="padding-right:40px;"></textarea>
               <button type="button" id="clearGptBtn" title="ÎãµÎ≥Ä ÎπÑÏö∞Í∏∞" aria-label="ÎãµÎ≥Ä ÎπÑÏö∞Í∏∞" style="position:absolute; right:8px; bottom:8px; appearance:none; border:0; background:transparent; color:#9ca3af; padding:4px; border-radius:6px; cursor:pointer; display:none; transition:all .15s;">
                 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
               </button>
             </div>
            <div id="spellPanel" class="spell-panel" style="display:none;"></div>
            <div id="reviewPanel" class="review-card"></div>
            <div id="kwPanel" class="review-card"></div>
          </div>
        </div>
      </section>
      <section class="pane">
        <div class="preview-head">
          <div>
            <div class="hint" id="urlInfo">ÎØ∏Î¶¨Î≥¥Í∏∞</div>
            <div class="hint" id="blockNote" style="display:none; color:#ef4444;">ÎÑ§Ïù¥Î≤Ñ Ïπ¥ÌéòÎäî Î≥¥ÏïàÏ†ïÏ±ÖÏúºÎ°ú ÎÇ¥Ïû• ÎØ∏Î¶¨Î≥¥Í∏∞Í∞Ä Ï∞®Îã®Îê† Ïàò ÏûàÏäµÎãàÎã§. ÏÉà ÌÉ≠ Ïó¥Í∏∞Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.</div>
          </div>
          <div class="right-actions">
            <a id="openNewTab" class="btn secondary toolbar" href="#" target="_blank" rel="noopener" title="ÏÉà ÌÉ≠ Ïó¥Í∏∞">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 3h7v7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 14L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M21 14v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              ÏÉà ÌÉ≠ Ïó¥Í∏∞
            </a>
          </div>
        </div>
        <div class="preview" id="previewContainer">
          <div class="toolbox" id="toolbox">
            <div class="tool-card">
              <h4>
                <span>ÏÜåÎ¨∏ Í∏∞Ìöç Ïª®ÌéåÏö© Î™®ÎãàÌÑ∞ÎßÅ ÌéòÏù¥ÏßÄ</span>
                <span class="tool-card-toggle">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
              </h4>
              <div class="tool-card-body">
                <div class="tool-row">
                  <span class="mono">Google Sheets</span>
                  <a class="btn secondary toolbar" href="https://docs.google.com/spreadsheets/d/1RhT1bOZIZhTwlZ5R3oNxc1zgkd8Of-shj8Qfb0j94UU/edit?gid=0#gid=0" target="_blank" rel="noopener" title="Î™®ÎãàÌÑ∞ÎßÅ ÏãúÌä∏ Ïó¥Í∏∞">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 3h7v7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 14L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M21 14v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Î∞îÎ°úÍ∞ÄÍ∏∞
                  </a>
                </div>
              </div>
            </div>
            <div class="tool-card">
              <h4>
                <span>üë§ Í≥ÑÏ†ïÎ≥Ñ ÏûëÏóÖ ÌòÑÌô©</span>
                <span class="tool-card-toggle">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
              </h4>
              <div class="tool-card-body">
                <div id="accountStats" style="max-height:200px; overflow:auto;"></div>
              </div>
            </div>
            <div class="tool-card">
              <h4>
                <span>üìç Ïπ¥Ìéò Î∂ÑÌè¨</span>
                <span class="tool-card-toggle">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
              </h4>
              <div class="tool-card-body">
                <div id="cafeDistribution" style="max-height:250px; overflow:auto;"></div>
              </div>
            </div>
            <div class="tool-card">
              <h4>
                <span>ÌîÑÎ¶¨ÏÖã</span>
                <span class="tool-card-toggle">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
              </h4>
              <div class="tool-card-body">
                <div class="tool-row" style="gap:8px; flex-wrap:wrap;">
                  <input id="presetSearch" type="text" placeholder="Í≤ÄÏÉâ" class="input" style="flex:1; min-width:140px;"/>
                  <button id="presetUploadXlsx" class="btn secondary toolbar">ÏóÖÎ°úÎìú(.xlsx)</button>
                  <input type="file" id="presetFileXlsx" accept=".xlsx,.xls" style="display:none;"/>
                  <button id="presetExportJson" class="btn secondary toolbar">ÎÇ¥Î≥¥ÎÇ¥Í∏∞(JSON)</button>
                </div>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin:8px 0;">
                  <div id="presetTabs" style="display:flex; gap:6px; flex-wrap:wrap;">
                    <button class="btn-xs" data-brand="kids">ÏóòÎ¶¨ÌïòÏù¥ÌÇ§Ï¶à</button>
                    <button class="btn-xs" data-brand="hi">ÏóòÎ¶¨ÌïòÏù¥</button>
                    <button class="btn-xs" data-brand="mbe">Ïó†Î≤†Ïä§Ìä∏</button>
                  </div>
                  <div id="presetRecControls" style="display:none;"></div>
                </div>
                <div id="presetList" style="display:flex; flex-direction:column; gap:10px; max-height:420px; overflow:auto;"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Removed floating preset panel; preset tools moved into toolbox card -->

  <!-- Mobile sidebar toggle -->
  <div id="mobileOverlay" class="mobile-overlay"></div>
  <button id="mobileSidebarToggle" class="mobile-sidebar-toggle" title="Î™©Î°ù Î≥¥Í∏∞" aria-label="Î™©Î°ù Î≥¥Í∏∞" style="display:none;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span id="mobileItemCount" class="badge-count" style="display:none;">0</span>
  </button>
  
  <!-- üçé Mobile Menu Modal -->
  <div id="mobileMenuModal" class="mobile-menu-modal" style="display:none;">
    <div class="mobile-menu-content">
      <div class="mobile-menu-header">
        <h3>Î©îÎâ¥</h3>
        <button id="closeMobileMenu" class="close-btn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="mobile-menu-items">
        <button id="mobileOpenBtn" class="mobile-menu-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h5l2 2h11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>ÌååÏùº Ïó¥Í∏∞</span>
        </button>
        <button id="mobileSaveBtn" class="mobile-menu-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2"/><path d="M7 3v6h8V3" stroke="currentColor" stroke-width="2"/><path d="M7 18h10" stroke="currentColor" stroke-width="2"/></svg>
          <span>Ï†ÄÏû•</span>
        </button>
        <button id="mobileSaveAsBtn" class="mobile-menu-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span>Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•</span>
        </button>
        <button id="mobileUrlBtn" class="mobile-menu-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 1 7-7l1 1m-4 10a5 5 0 0 1-7 7l-1-1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>URL Ï†ïÎ¶¨</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Floating theme toggle (moon/sun) -->
  <button id="themeFab" class="theme-fab" title="ÌÖåÎßà Ï†ÑÌôò" aria-pressed="false" aria-label="ÌÖåÎßà Ï†ÑÌôò">
    <svg id="themeIconSun" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    <svg id="themeIconMoon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" />
  <input type="file" id="libXlsxInput" accept=".js" style="display:none" />
  <input type="file" id="libFsInput" accept=".js" style="display:none" />
  <div id="copyToast" class="toast">Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§</div>
  <!-- Hidden submit sink and form for CORS-free Apps Script POST -->
  <iframe id="submitSink" name="submitSink" style="display:none;"></iframe>
  <form id="submitForm" action="https://script.google.com/macros/s/AKfycbzeeeejbtXqmD-BTK79wO6I24q7QolcgXwfFB2uYKCFjb9NVt1ZMTuHWdHaGD-gFxN6-w/exec" method="POST" target="submitSink" style="display:none;">
    <input type="hidden" name="token" id="submitToken" />
    <textarea name="rows" id="submitRows" style="display:none;"></textarea>
  </form>

  <!-- URL Manager Modal -->
  <style>
    .modal-ov { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:10000; }
    .modal-ov.show { display:flex; }
    .modal-card { width:min(800px, 92vw); background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden; }
    .modal-head { padding:14px 16px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; }
    .modal-head h3 { margin:0; font-size:16px; }
    .modal-body { padding:12px 16px; }
    .modal-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px; justify-content:space-between; }
    .chip-group { display:flex; gap:8px; align-items:center; }
    .chip { appearance:none; border:1px solid #e5e7eb; background:#fff; color:#374151; padding:6px 12px; border-radius:999px; font-weight:700; font-size:12px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    .chip.active.true { background:#ecfdf5; color:#047857; border-color:#a7f3d0; }
    .chip.active.false { background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
    .chip.active[id="ufAll"] { background:#111827; color:#fff; border-color:#111827; }
    .chip.toggle.active { background:#f3f4f6; color:#111827; border-color:#d1d5db; }
    .count-pill { display:inline-flex; align-items:center; gap:6px; background:#111827; color:#fff; padding:6px 10px; border-radius:12px; font-weight:800; font-size:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .count-pill .num { font-size:13px; }
    .url-list-box { border:1px solid #e5e7eb; border-radius:10px; height:300px; overflow:auto; padding:10px; background:#fafafa; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .modal-foot { padding:12px 16px; border-top:1px solid #e5e7eb; display:flex; align-items:center; justify-content:flex-end; gap:8px; }
    /* Main tabs */
    .main-tabs { display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid #e5e7eb; padding-bottom:0; }
    .main-tab { appearance:none; border:0; background:transparent; color:#6b7280; padding:10px 16px; font-weight:600; font-size:14px; cursor:pointer; border-bottom:2px solid transparent; transition:all .2s; }
    .main-tab.active { color:#8b5cf6; border-bottom-color:#8b5cf6; }
    .main-tab:hover { color:#374151; }
    /* Account cafe list */
    .account-section { margin-bottom:16px; }
    .account-header { font-weight:700; font-size:13px; color:#374151; padding:8px 0; display:flex; align-items:center; gap:6px; }
    .cafe-link { display:flex; align-items:center; justify-content:space-between; padding:8px 12px; margin:4px 0; border-radius:8px; background:#f9fafb; border:1px solid #e5e7eb; text-decoration:none; color:#374151; transition:all .15s; }
    .cafe-link:hover { background:#f3f4f6; border-color:#d1d5db; }
    .cafe-url { font-family:ui-monospace,monospace; font-size:12px; color:#6b7280; }
    .cafe-count { font-size:11px; font-weight:700; color:#8b5cf6; background:#f3f4f6; padding:2px 8px; border-radius:999px; }
    .cafe-count.warn { color:#ef4444; background:#fee2e2; }
  </style>
  <div class="modal-ov" id="urlModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3>URL Í¥ÄÎ¶¨</h3>
      </div>
      <div class="modal-body">
        <!-- Main Tabs -->
        <div class="main-tabs">
          <button type="button" id="urlListTab" class="main-tab active">URL Ï†ïÎ¶¨</button>
          <button type="button" id="accountCafeTab" class="main-tab">Í≥ÑÏ†ïÎ≥Ñ Ïπ¥Ìéò</button>
          <button type="button" id="deletePendingTab" class="main-tab">ÏÇ≠Ï†ú ÎåÄÍ∏∞</button>
        </div>
        
        <!-- URL List View -->
        <div id="urlListView">
          <!-- 1) Ï†úÏ∂ú ÏÉÅÌÉú ÌÉ≠ -->
          <div class="modal-row" style="margin-bottom:12px;">
            <div class="chip-group" style="flex:1;">
              <button type="button" id="ufAll" class="chip" style="flex:1; justify-content:center; background:#f3f4f6; color:#111827; border-color:#d1d5db;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Ï†ÑÏ≤¥
              </button>
              <button type="button" id="ufTrue" class="chip true active" style="flex:1; justify-content:center;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Ï†úÏ∂ú ÎåÄÏÉÅ (TRUE)
              </button>
              <button type="button" id="ufFalse" class="chip false" style="flex:1; justify-content:center;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                ÎØ∏Ï†úÏ∂ú (FALSE)
              </button>
            </div>
          </div>
          <!-- 2) ÌïÑÌÑ∞ ÏòµÏÖò -->
          <div class="modal-row" style="align-items:center; margin-bottom:8px;">
            <div style="display:flex; align-items:center; gap:4px; color:#6b7280; font-size:12px; font-weight:600;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              ÌïÑÌÑ∞:
            </div>
            <div class="chip-group">
              <button type="button" id="exChip" class="chip toggle active">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 12H4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                ÏûëÏóÖ ÏôÑÎ£å Ï†úÏô∏
              </button>
              <button type="button" id="hasGptChip" class="chip toggle">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                ÎãµÎ≥Ä ÏûàÏùå
              </button>
            </div>
            <div style="margin-left:auto; color:#6b7280; font-size:13px; font-weight:600;">
              <span id="urlCountNum">0</span>Í±¥
            </div>
          </div>
          <div class="url-list-box" id="urlListBox" style="white-space: pre-line; line-height: 1.6;"></div>
        </div>

        <!-- Account Cafe View -->
        <div id="accountCafeView" style="display:none;">
          <div class="url-list-box" id="accountCafeBox" style="white-space:normal; line-height:1.6;"></div>
        </div>

        <!-- Delete Pending View -->
        <div id="deletePendingView" style="display:none;">
          <div class="modal-row" style="align-items:center; margin-bottom:12px;">
            <div style="display:flex; align-items:center; gap:4px; color:#ef4444; font-size:13px; font-weight:600;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-1 0v14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V6m3 4v8m4-8v8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              ÏÇ≠Ï†ú ÏòàÏ†ï Ìï≠Î™©:
            </div>
            <div style="margin-left:auto; color:#6b7280; font-size:13px; font-weight:600;">
              <span id="deletePendingCountNum">0</span>Í±¥
            </div>
          </div>
          <div class="url-list-box" id="deletePendingBox" style="white-space: pre-line; line-height: 1.6; background:#fef2f2; border-color:#fecaca;"></div>
          <div style="margin-top:12px; padding:10px; background:#fef2f2; border:1px solid #fecaca; border-radius:10px; font-size:12px; color:#991b1b;">
            <div style="font-weight:700; margin-bottom:4px;">üí° Íµ¨Í∏Ä ÏãúÌä∏ÏóêÏÑú ÏÇ≠Ï†úÌïòÎäî Î∞©Î≤ï:</div>
            <div>1. <strong>Î™©Î°ù Î≥µÏÇ¨</strong> Î≤ÑÌäº ÌÅ¥Î¶≠ (ÌòïÏãù: url1|url2|url3)</div>
            <div>2. Íµ¨Í∏Ä ÏãúÌä∏ÏóêÏÑú <strong>URL Ïó¥ Ï†ÑÏ≤¥ ÏÑ†ÌÉù</strong></div>
            <div>3. <strong>Ìé∏Ïßë ‚Üí Ï∞æÍ∏∞ Î∞è Î∞îÍæ∏Í∏∞</strong> Ïó¥Í∏∞</div>
            <div>4. Ï∞æÏùÑ Ìï≠Î™©Ïóê <strong>Î∂ôÏó¨ÎÑ£Í∏∞</strong>, Î∞îÍøÄ Ìï≠Î™©ÏùÄ <strong>ÎπÑÏõåÎë†</strong></div>
            <div>5. <strong>‚úÖ Ï†ïÍ∑úÏãù ÏÇ¨Ïö©</strong> <strong>‚úÖ ÏàòÏãù ÎÇ¥ Í≤ÄÏÉâ</strong> <strong>‚úÖ ÎßÅÌÅ¨ ÎÇ¥ÏóêÏÑúÎèÑ Í≤ÄÏÉâ</strong> Ï≤¥ÌÅ¨</div>
            <div>6. <strong>Î™®Îëê Î∞îÍæ∏Í∏∞</strong> ÌÅ¥Î¶≠ ‚Üí URL ÏùºÍ¥Ñ ÏÇ≠Ï†ú ÏôÑÎ£å</div>
            <div style="margin-top:6px; padding-top:6px; border-top:1px solid #fecaca;">
              ‚ö†Ô∏è Ïó¨Í∏∞ÏÑú <strong>Ï†ÄÏû• Î≤ÑÌäº</strong>ÏùÑ ÎàÑÎ•¥Î©¥ Î°úÏª¨ÏóêÏÑúÎèÑ ÏÇ≠Ï†úÎê©ÎãàÎã§
            </div>
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn secondary" id="copyUrlListBtn">Î™©Î°ù Î≥µÏÇ¨</button>
        <button class="btn primary" id="urlModalClose2">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- Unsaved changes modal -->
  <div class="modal-ov" id="unsavedModal">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="unsavedTitle">
      <div class="modal-head">
        <h3 id="unsavedTitle">ÎØ∏Ï†ÄÏû• Î≥ÄÍ≤ΩÏù¥ ÏûàÏùå</h3>
      </div>
      <div class="modal-body">
        <div style="font-size:14px; color:#374151; line-height:1.6;">
          Îã§Î•∏ ÌååÏùºÏùÑ Ïó¥Í∏∞ Ï†ÑÏóê ÌòÑÏû¨ Î≥ÄÍ≤Ω ÎÇ¥Ïö©ÏùÑ Ï†ÄÏû•Ìï¥ÏïºÌï®.<br/>
          Ï†ÄÏû• ÎòêÎäî Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•ÏùÑ ÏôÑÎ£åÌïú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn secondary" id="unsavedSaveAsBtn">Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•</button>
        <button class="btn primary" id="unsavedSaveBtn">Ï†ÄÏû•</button>
        <button class="btn" id="unsavedCancelBtn" style="background:#e5e7eb; color:#111827; border:1px solid #e5e7eb;">Ï∑®ÏÜå</button>
      </div>
    </div>
  </div>

  <script>
    // üçé Safari Compatibility Check
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    
    console.log('üåê Browser:', isSafari ? 'Safari' : 'Other');
    console.log('üì± Platform:', isIOS ? 'iOS' : 'Desktop');
    
    // Register Service Worker for PWA (only on HTTPS)
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('‚úÖ PWA Service Worker registered'))
          .catch(err => console.log('‚ö†Ô∏è Service Worker registration failed:', err));
      });
    }
    
    // Safari localStorage fallback
    let storageAvailable = true;
    try {
      localStorage.setItem('test', '1');
      localStorage.removeItem('test');
    } catch(e) {
      console.warn('‚ö†Ô∏è localStorage not available, using memory storage');
      storageAvailable = false;
    }

    // State
    let workbook = null;           // XLSX workbook
    let worksheetName = null;      // active sheet name (Î¶¨Ïä§Ìä∏_fix Ïö∞ÏÑ†)
    let ws = null;                 // worksheet object
    let header = [];               // header row as array
    let rows = [];                 // all rows (AOA)
    let map = {};                  // column index map
    let items = [];                // sidebar entries [{rowIdx, cafe, url, title, body, gpt, submit, remark}]
    let activeIndex = -1;          // items index
    let modified = new Map();      // rowIdx (1-based in Excel) -> { gpt, submit }
    let deletedRows = new Set();   // deleted row indices (1-based)
    let selectedRows = new Set();  // multi-select rows (1-based)
    const undoStack = [];          // operations stack for undo, e.g., {type:'delete', rows:[rowIdx,...]}
    let fileHandle = null;         // FileSystemFileHandle when available
    let openedFilename = "";
    let pendingDroppedFile = null; // File object awaiting open after save
    let pendingDroppedHandle = null; // FileSystemFileHandle captured from DnD (if available)
    let autoSaveTimer = null;       // setInterval id for auto-save
    let _dndPlaceholder = null;     // single placeholder element for list reordering
    let _isReordering = false;      // drag-reorder in progress
    let _orderDirty = false;        // order changed since last save
    let _spellState = { textSnapshot: '', matches: [] };
    let _spellAbort = null; // AbortController for in-flight spell checks

    // ---- Preset state ----
    const DEFAULT_PRESETS = { kids: [], hi: [], mbe: [] };
    let userPresets = null; // { kids:[], hi:[], mbe:[] }
    let activePresetBrand = 'hi';

    function getEffectivePresets(){
      const up = userPresets || {};
      return {
        kids: Array.from(new Set([...(up.kids||[])])).filter(Boolean),
        hi:   Array.from(new Set([...(up.hi||[])])).filter(Boolean),
        mbe:  Array.from(new Set([...(up.mbe||[])])).filter(Boolean),
        rec:  []
      };
    }

    function _extractContextForTokens(){
      const it = (activeIndex>=0)?items[activeIndex]:null;
      const title = String(it?.title||'');
      const body  = String(it?.body||'');
      const brandKey = inferPresetBrandKey(it);
      // Îß§Ïö∞ Îã®Ïàú Í≥ºÎ™© ÌÉêÏßÄ(ÌÇ§ÏõåÎìú)
      const subjMap = [
        {k:'Íµ≠Ïñ¥', r:/(Íµ≠Ïñ¥|Î¨∏Ìï¥Î†•|ÎèÖÌï¥|ÌïúÏûê)/},
        {k:'ÏàòÌïô', r:/(ÏàòÌïô|Ïó∞ÏÇ∞|ÏÇ¨Í≥†Î†•|1031|Ìå©ÌÜ†)/},
        {k:'ÏòÅÏñ¥', r:/(ÏòÅÏñ¥|ÌååÎãâÏä§|ORT|ÏõêÏÑú|Î≥¥Ïπ¥|ÏâêÎèÑÏûâ)/},
        {k:'Í≥ºÌïô', r:/(Í≥ºÌïô|ÌÉêÍµ¨|Ïã§Ìóò)/},
        {k:'ÌïúÍµ≠ÏÇ¨', r:/(ÌïúÍµ≠ÏÇ¨|ÌïúÏûê)/}
      ];
      const src = (title+'\n'+body);
      let subj=''; for (const s of subjMap){ if (s.r.test(src)) { subj=s.k; break; } }
      // ÏãúÎ¶¨Ï¶à ÌõÑÎ≥¥(Î∏åÎûúÎìúÎ≥Ñ Í∑úÏπô ÏµúÏÜåÌôî Î≤ÑÏ†Ñ)
      const seriesByBrand = {
        kids: ['Í∏∞Ï†ÅÏùò Í≥ÑÏÇ∞Î≤ï','Í∏∞Ï†ÅÏùò ÎèÖÌï¥Î†•','Í∏∞Ï†ÅÏùò ÌååÎãâÏä§','Í∏∞Ï†ÅÏùò ÏÇ¨Ïù¥Ìä∏ÏõåÎìú','ÏóòÎ¶¨Íµ¨Íµ¨','Ïó∞ÏÇ∞ÏïÑÏùºÎûúÎìú','ÌîÑÎ¶¨ÎØ∏ÏóÑ Î∂ÅÌÅ¥ÎüΩ'],
        hi:   ['ÏòÅÏû¨ÏÇ¨Í≥†Î†• 1031 ÏãúÎ¶¨Ï¶à','ÌïòÏù¥Ïó∞ÏÇ∞ Ïï±','Ïä§ÎßàÌä∏ÌååÎãâÏä§','ORT Ïò•Ïä§Ìè¨Îìú Î¶¨Îî©','Î¨∏Ìï¥Î†•ÏùÑ Î∂ÄÌÉÅÌï¥'],
        mbe:  ['Ï§ëÌïôÏòÅÎ¨∏Î≤ï 3800Ï†ú','Î∞±Ïã† Í≥ºÌïô','ÌïòÏù¥ÌÉë','Í∞úÎÖêÏõêÎ¶¨','RPM']
      };
      const sArr = seriesByBrand[brandKey]||seriesByBrand.hi; const series = sArr[Math.floor(Math.random()*sArr.length)];
      return { brandKey, subj, series, src };
    }

    function _applyTokens(t, ctx){
      let out = String(t||'');
      out = out.replaceAll('{Í≥ºÎ™©}', ctx.subj||'');
      out = out.replaceAll('{ÏãúÎ¶¨Ï¶à}', ctx.series||'');
      // ÎßàÏä§ÌÇπÏùÄ Í∏∞Ï°¥ Î°úÏßÅ Ïû¨ÏÇ¨Ïö©
      out = out.replaceAll('{brand_mask}', maskBrandRandom(ctx.brandKey||'hi'));
      // Í∏àÏπô ÏπòÌôò
      out = out.replace(/[¬∑]/g,'ÏôÄ').replace(/[\/\-]/g,' ');
      return out;
    }

    function buildRecommendations(n){
      const it = (activeIndex>=0)?items[activeIndex]:null;
      const ctx = _buildRichContext(it);
      // ÌîÑÎ¶¨ÏÖã Í∏∞Î∞ò ÌÇ§ÏõåÎìú¬∑ÎßêÌà¨ ÌïôÏäµ(Í∞ÑÎã® Ïä§ÏΩîÏñ¥): Ï†úÎ™©/Î≥∏Î¨∏ ÌÇ§ÏõåÎìú Îß§Ïπ≠ ÎπÑÏú®Ïù¥ ÎÜíÏùÄ Î¨∏Ïû•Ïóê Í∞ÄÏÇ∞Ï†ê
      const data=getEffectivePresets();
      const poolRaw=[...(data.kids||[]), ...(data.hi||[]), ...(data.mbe||[])];
      const src = (String(it?.title||'')+'\n'+String(it?.body||''));
      const tokens = Array.from(new Set(src.split(/[^\p{L}0-9]+/u).filter(Boolean).map(x=>x.toLowerCase())));
      function scoreByTokens(s){
        const words = String(s||'').toLowerCase().split(/[^\p{L}0-9]+/u).filter(Boolean);
        let hit=0; for (const w of words){ if (tokens.includes(w)) hit++; }
        // Í≥ºÎ™©¬∑Î∏åÎûúÎìú ÌûåÌä∏ Í∞ÄÏÇ∞
        const subjHint = ctx.subj? (new RegExp(ctx.subj.toLowerCase()).test(String(s).toLowerCase())?1:0) : 0;
        const brandHint = /ÏóòÎ¶¨|Ïó†Î≤†/.test(String(s)) ? 0.5 : 0; // ÏßÄÎÇòÏπú Ïã§Î™ÖÏùÄ ÌõÑÏ≤òÎ¶¨ÏóêÏÑú Î™®ÏûêÏù¥ÌÅ¨ Ï≤òÎ¶¨
        // Ï¶êÍ≤®Ï∞æÍ∏∞/ÏÇ¨Ïö©Îüâ Î≥¥Ï†ï(Îçú Ïì¥ Í≤É Ïö∞ÏÑ†)
        const base = - (getPresetUseCount(s)||0) + (isPresetFavorite(s)?2:0);
        return base + hit*0.2 + subjHint*0.6 + brandHint*0.2;
      }
      poolRaw.sort((a,b)=> scoreByTokens(b)-scoreByTokens(a));
      const out=[]; const need=n||3;
      const variants=['vague','teacher','vague2','teacher2','blend'];
      let guard=0;
      while (out.length<need && guard<40){
        guard++;
        const v = variants[Math.floor(Math.random()*variants.length)];
        // ÌîÑÎ¶¨ÏÖã ÎßêÌà¨/Íµ¨Î•º ÏùºÎ∂Ä ÏÑûÍ∏∞: ÏÉÅÏúÑ NÍ∞ú ÌíÄÏóêÏÑú ÎûúÎç§ Ïù∏Ïö©
        let seed = poolRaw[Math.floor(Math.random()*Math.min(12, poolRaw.length))]||'';
        seed = seed.replace(/[¬∑\-']/g,' ').replace(/\s{2,}/g,' ').trim().slice(0,120);
        const s = _generateRecommendation(ctx, v, seed);
        if (!s) continue;
        // Ï§ëÎ≥µ/Ïú†ÏÇ¨ Î∞©ÏßÄ
        const norm = s.replace(/\s+/g,' ').trim();
        if (out.some(x=>x.replace(/\s+/g,' ').trim()===norm)) continue;
        // Î¨∏Ïû• ÎÇ¥ Î∞òÎ≥µ Íµ¨Ï†à Ï†úÍ±∞(Í∞ôÏùÄ Î¨∏Ïû•/Íµ¨Í∞Ä Îëê Î≤à Ïù¥ÏÉÅ Î∞òÎ≥µÎêòÎ©¥ ÌïòÎÇòÎßå Ïú†ÏßÄ)
        let dedup = s.replace(/(\S.{0,25}?)(?:\s*\1\b)+/g, '$1');
        dedup = dedup.replace(/(\bÏ°∞Í∏àÏî© ÎÇòÏïÑÏßÄÎäî Í≤å Î≥¥Ïó¨Ïöî\^\^|\bÏöîÏ¶òÏóî ÌòºÏûê ÏºúÍ≥† ÌïòÎçîÎùºÍµ¨Ïöî„Öé„Öé)/g, '$1');
        out.push(dedup);
      }
      return out.slice(0, need);
    }

    // ----- Advanced recommendation generator (rule-based) -----
    function _rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function _brandFromAgeTokens(src){
      const s = String(src||'');
      const y7 = /(7\s*ÏÑ∏|7\s*ÏÇ¥|ÏòàÎπÑÏ¥à)/.test(s);
      const elemLow = /(Ï¥à\s*[1-3]|Ï†ÄÌïôÎÖÑ)/.test(s);
      const elem = /(Ï¥à\s*[1-6]|Ï¥àÎì±|\b(?:1[0-9]|[8-9])\s*ÏÑ∏)/.test(s);
      const mid = /(Ï§ë\s*[1-3]|ÏòàÎπÑÏ§ë)/.test(s);
      if (y7) return 'kids+hi';
      if (mid) return 'mbe';
      if (elem || elemLow) return 'hi';
      return '';
    }
    function _cleanForbidden(v, brandKey){
      let s=String(v||'');
      s=s.replace(/[¬∑\-']/g,' ');
      const forbidWords=['Í≤åÏûÑ','Í±∞Î∂ÄÍ∞ê','Í∑†Ìòï','ÏÑ±Ï∑®Í∞ê'];
      if (brandKey==='hi') forbidWords.push('ÏßÄÎ©¥ÌïôÏäµÏßÄ');
      for (const w of forbidWords){ s=s.replace(new RegExp(w,'g'),''); }
      s=s.replace(/\s{2,}/g,' ').trim();
      return s;
    }
    function _ensureLength150(s){
      // Î™©Ìëú 150¬±10, ÎÑàÎ¨¥ ÏßßÏúºÎ©¥ ÏïàÏ†Ñ ÌëúÌòÑ Ìïú Í∞ú Ï∂îÍ∞Ä, Í∏∏Î©¥ Î∂ÄÏÇ¨/Ï§ëÎ≥µ Í≥µÎ∞± Ï†úÍ±∞
      const lenNoSp = (String(s||'').replace(/\s+/g,'').length);
      if (lenNoSp<140){
        const endPool=['Ï°∞Í∏àÏî© ÎÇòÏïÑÏßÄÎäî Í≤å Î≥¥Ïó¨Ïöî^^','ÏöîÏ¶òÏóî ÌòºÏûê ÏºúÍ≥† ÌïòÎçîÎùºÍµ¨Ïöî„Öé„Öé','ÏÉùÍ∞ÅÎ≥¥Îã§ Ïû¨ÎØ∏ÏûàÍ≤å Îî∞ÎùºÍ∞ÄÏöî','ÏäµÍ¥ÄÏ≤òÎüº Ï±ôÍ∏∞Îãà Ìé∏ÌïòÎÑ§Ïöî'];
        s = (s + ' ' + _rand(endPool)).trim();
      } else if (lenNoSp>160){
        s = s.replace(/Ï†ïÎßê|ÏïÑÏ£º|ÎÑàÎ¨¥|ÏóÑÏ≤≠|ÏßÑÏßú/g,'').replace(/\s{2,}/g,' ').trim();
      }
      return s;
    }
    function _teacherByBrandSubject(brandKey, subj){
      if (brandKey==='mbe'){
        if (subj==='ÏàòÌïô') return 'ÎØºÏ†ïÎ≤îÏå§';
        if (subj==='ÏòÅÏñ¥') return 'Î∞ïÏòÅÏïÑÏå§';
        if (subj==='Í≥ºÌïô') return 'Ïû•ÌíçÏå§';
        if (subj==='Íµ≠Ïñ¥') return 'Ïú†ÌòÑÏßÑÏå§';
      }
      if (brandKey==='hi'){
        if (subj==='ÏàòÌïô') return 'Í∂åÏßÄÎØºÏå§';
        if (subj==='ÏòÅÏñ¥') return 'Ï°∞ÏßÄÏòÅÏå§';
        if (subj==='Íµ≠Ïñ¥') return 'ÎßπÏßÄÌòÑÏå§';
        if (subj==='Í≥ºÌïô') return 'Ïò§Ìà¨Ïå§';
      }
      return '';
    }
    function _brandMaskFor(key){ return maskBrandRandom(key); }
    function _buildRichContext(it){
      const base=_extractContextForTokens();
      // ÎÇòÏù¥/ÌïôÎÖÑ Í∏∞Î∞ò Î≥¥Ï†ï
      const byAge=_brandFromAgeTokens(base.src);
      let brandKey=base.brandKey;
      if (byAge==='kids+hi') brandKey='kids';
      else if (byAge) brandKey=(byAge||brandKey)||'hi';
      // ÎåÄÌëú ÏÜåÍµ¨ ÌíÄ(Í∞ÑÎã®)
      const points={
        kids:['ÌîÑÎ¶¨ÎØ∏ÏóÑ Î∂ÅÌÅ¥ÎüΩ','Î∞òÏùëÌòï ÎèôÌôî','ÎÜÄÏù¥Ï≤òÎüº Î∞∞Ïö∞Îäî ÌïúÍ∏Ä','Í∏∞Ï†ÅÏùò ÏãúÎ¶¨Ï¶à','ÏóòÎ¶¨Íµ¨Íµ¨','Ïó∞ÏÇ∞ÏïÑÏùºÎûúÎìú','Îß§Ï£º ÌôîÏÉÅÏàòÏóÖ'],
        hi:['ÏùºÎåÄÏùº ÌïôÏäµÍ¥ÄÎ¶¨','ÍµêÍ≥º Ïó∞Í≥Ñ Í∞ïÏùò','ÌïòÏù¥Ïó∞ÏÇ∞ Ïï±','Ïä§ÎßàÌä∏ÌååÎãâÏä§','ÏòÅÏñ¥ÎèÑÏÑúÍ¥Ä','Ïä§ÏúóÌÉÄÏûÑ'],
        mbe:['Ï∂úÌåêÏÇ¨Î≥Ñ Í∞ïÏùò','ÏßàÎ¨∏ Í≤åÏãúÌåê','Ï§ëÌïôÏòÅÎ¨∏Î≤ï 3800Ï†ú','ÌïòÏù¥ÌÉë','Î∞±Ïã† Í≥ºÌïô','ÏûêÍ∏∞Ï£ºÎèÑ ÏäµÍ¥Ä']
      };
      const subj=base.subj;
      const teacher=_teacherByBrandSubject(brandKey, subj);
      const mask=_brandMaskFor(brandKey);
      const endPool=[
        'ÏöîÏ¶òÏóî ÌòºÏûê ÏºúÍ≥† ÌïòÎçîÎùºÍµ¨Ïöî„Öé„Öé','ÏÉùÍ∞ÅÎ≥¥Îã§ Ïû¨ÎØ∏ÏûàÍ≤å Îî∞ÎùºÍ∞ÄÏÑú Î≥¥Í∏∞ Ï¢ãÏïÑÏöî','ÏäµÍ¥ÄÏ≤òÎüº Ï±ôÍ∏∞ÎãàÍπå Ï†ÄÎèÑ Ìé∏Ìï¥Ïöî^^',
        'Ï°∞Í∏àÏî© ÎÇòÏïÑÏßÄÎäî Í≤å Î≥¥Ïó¨ÏÑú ÎßåÏ°±Ïä§Îü¨ÏõåÏöî','Ï≤òÏùåÏóî Ïñ¥ÏÉâÌñàÎäîÎç∞ Ïù¥Ï†úÎäî ÏûêÏó∞Ïä§ÎüΩÎÑ§Ïöî'
      ];
      // ÌäπÏàòÏÉÅÌô© Î≥¥Ï†ï(7ÏÑ∏/ÏòàÎπÑÏ¥à, Ï¥à6/ÏòàÎπÑÏ§ë)
      const s=base.src;
      const special={ k7: /(7\s*ÏÑ∏|7\s*ÏÇ¥|ÏòàÎπÑÏ¥à)/.test(s), g6: /(Ï¥à\s*6|6ÌïôÎÖÑ|ÏòàÎπÑÏ§ë)/.test(s) };
      return { brandKey, subj, teacher, mask, points, endPool, special };
    }
    function _genVague(ctx){
      const p1=_rand(ctx.points[ctx.brandKey]||[]);
      const p2=_rand(ctx.points[ctx.brandKey]||[]);
      const openers=[
        'Ï≤òÏùåÏóî ÎßùÏÑ§ÏòÄÎäîÎç∞','Î∂ÄÎã¥ ÏóÜÏù¥ ÏãúÏûëÌñàÎäîÎç∞','Íæ∏Ï§ÄÌûà ÌïòÎã§ Î≥¥Îãà','ÏöîÏ¶ò Î≥¥Î©¥','Ï°∞Í∏àÏî© ÏùµÏàôÌï¥ÏßÄÎ©¥ÏÑú',
        'ÎßâÏÉÅ Ìï¥Î≥¥Îãà','ÏãúÍ∞Ñ Ï†ïÌï¥ÎëêÍ≥† ÌïòÎã§ Î≥¥Îãà','ÏßßÍ≤åÎùºÎèÑ Îß§Ïùº Ïù¥Ïñ¥Í∞ÄÎãà','ÏûêÏ£º ÏºúÎ≥¥Í≤å ÎêòÎçîÎùºÍµ¨Ïöî','ÏöîÏ¶òÏùÄ Î∂ÑÏúÑÍ∏∞Í∞Ä Îã¨ÎùºÏ°åÏñ¥Ïöî'
      ];
      let s=`${_rand(openers)} ${ctx.mask}Î°ú Ïù¥Ïñ¥Í∞ÄÍ≥† ÏûàÏñ¥Ïöî. `;
      if (ctx.subj) s+=`${ctx.subj}Îäî `;
      s+= (p1?`${p1} ÏúÑÏ£ºÎ°ú Î≥¥Í≥†, `:'') + (p2&&p2!==p1?`${p2}ÎèÑ Í∞ÄÎÅî Í≥ÅÎì§Ïù¥Í≥† ÏûàÏñ¥Ïöî.`:'') ;
      const ends=[...ctx.endPool,
        'Ï†ÄÎèÑ ÌïúÍ≤∞ ÎßàÏùåÏù¥ Ìé∏Ìï¥Ï°åÏñ¥Ïöî','ÎπÑÏä∑Ìïú Ìå®ÌÑ¥ÏúºÎ°ú Íæ∏Ï§ÄÌûà Í∞ÄÍ≥† ÏûàÏñ¥Ïöî','Î∂ÄÎã¥ ÏóÜÏù¥ Ïù¥Ïñ¥Í∞ÄÍ∏∞ Ï¢ãÏïÑÏöî',
        'ÏòàÏ†ÑÎ≥¥Îã§ Ìõ®Ïî¨ ÏàòÏõîÌï¥Ï°åÏñ¥Ïöî','Ï°∞Í∏àÏî© Îã¨ÎùºÏßÄÎäî Í≤å Î≥¥Ïó¨Ïöî^^'
      ];
      s+=' '+_rand(ends);
      return _ensureLength150(_cleanForbidden(s, ctx.brandKey));
    }
    function _genTeacher(ctx){
      if (!ctx.teacher){ return _genVague(ctx); }
      const p=_rand(ctx.points[ctx.brandKey]||[]);
      const openers=[ 'ÏÑ§Î™Ö Î™ÖÌôïÌï¥ÏÑú', 'ÌïµÏã¨Îßå ÏΩï ÏßëÏñ¥Ï§òÏÑú', 'ÏïÑÏù¥ ÎààÎÜíÏù¥Ïóê ÎßûÏ∂∞Ï§òÏÑú', 'ÏòàÏãúÍ∞Ä ÎßéÏïÑÏÑú', 'Ïä§ÌÖùÏù¥ ÏûòÍ≤å ÎÇòÎâòÏñ¥ ÏûàÏñ¥ÏÑú' ];
      let s=`${ctx.teacher} Í∞ïÏùòÍ∞Ä ${_rand(openers)} Ï¢ãÏïÑÏöî. `;
      s+=`${ctx.mask}ÏóêÏÑú `+(ctx.subj||'Í≥ºÎ™©')+` ÌùêÎ¶Ñ Ïû°ÏïÑÏ£ºÍ≥†`+(p?`, ${p}ÏùÄ Î≥¥Ï°∞Î°ú ÏÇ¥Ïßù.`:'') ;
      const ends=[...ctx.endPool,'Í∏àÎ∞© Ï†ÅÏùëÌïòÎçîÎùºÍµ¨Ïöî','ÌòºÏûê ÏºúÍ≥† Î≥¥Îäî ÎÇ†Ïù¥ ÎäòÏóàÏñ¥Ïöî','Î∂ÄÎã¥ ÏóÜÏù¥ Îî∞ÎùºÍ∞ÄÏöî'];
      s+=' '+_rand(ends);
      return _ensureLength150(_cleanForbidden(s, ctx.brandKey));
    }
    function _applySpecial(ctx, text){
      let s=text;
      if (ctx.special.k7 && ctx.brandKey==='kids'){
        // Í∏∞Ï†ÅÏùò ÏãúÎ¶¨Ï¶à + Ï¥àÎì± Í∞ïÏùòÎèÑ Í∞ôÏù¥ Ïó¥Î¶º
        s = `${ctx.mask}Î°ú ÏãúÏûëÌñàÎäîÎç∞ Ï¥àÎì± Í∞ïÏùòÎèÑ Í∞ôÏù¥ Ïó¥Î†§ÏÑú Í∞ÄÎÅî ÌôúÏö©Ìï¥Ïöî. Í∏∞Ï†ÅÏùò ÏãúÎ¶¨Ï¶àÎèÑ Í≥ÅÎì§Ïù¥Îãà ÌùêÎ¶ÑÏù¥ Ï¢ãÏïÑÏöî. `+s;
      }
      if (ctx.special.g6 && ctx.brandKey==='hi'){
        s = s + ` Ï§ëÎì± Ïù∏Í∞ïÎèÑ Í∞ôÏù¥ Ïó¥Î†§ÏÑú ÎØ∏Î¶¨ ÎßõÎ≥¥ÎìØ ÏòàÏäµÌï¥Î≥¥Îäî Ï§ëÏù¥ÏóêÏöî`;
        s = s.replace('ÎßõÎ≥¥ÎìØ','Í∞ÄÎ≥çÍ≤å');
      }
      return _ensureLength150(_cleanForbidden(s, ctx.brandKey));
    }
    function _generateRecommendation(ctx, variant, seed){
      let s='';
      switch(variant){
        case 'vague': s=_genVague(ctx); break;
        case 'teacher': s=_genTeacher(ctx); break;
        case 'vague2': s=_genVague(ctx); break;
        case 'teacher2': s=_genTeacher(ctx); break;
        default: s=_genVague(ctx); break;
      }
      // ÌîÑÎ¶¨ÏÖã ÎßêÌà¨/Íµ¨Î•º ÏûêÏó∞Ïä§Î†à Ìïú Íµ¨Ï†à Ìï©ÏÑ±(Î∂ÄÎã¥ ÏóÜÎäî Ìïú Î¨∏Ïû• ÏàòÏ§Ä)
      if (seed && Math.random()<0.7){
        const parts = seed.split(/[.!?~]+/).map(x=>x.trim()).filter(Boolean);
        const tail = parts.length ? parts[Math.floor(Math.random()*parts.length)] : '';
        if (tail && tail.length>8){
          // ÎèôÏùº Íµ¨Ï†àÏù¥ Ïù¥ÎØ∏ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏúºÎ©¥ Í±¥ÎÑàÎúÄ
          if (!new RegExp(tail.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).test(s)){
            s = (s + ' ' + tail).trim();
          }
        }
      }
      s=_applySpecial(ctx, s);
      // Ï¥àÏûÖ Í∏àÏßÄÏñ¥Íµ¨ ÌöåÌîº: "Ï†ÄÌù¨ ÏßëÏùÄ", "Ï†ÄÌù¨ ÏïÑÏù¥Îäî" Ï†úÍ±∞
      s=s.replace(/^\s*(Ï†ÄÌù¨\s*ÏßëÏùÄ|Ï†ÄÌù¨\s*ÏïÑÏù¥Îäî)/,'');
      // Í∏∏Ïù¥ Î≥¥Ï†ï
      s=_ensureLength150(s);
      return s;
    }
    function loadPresetsFromStorage(){
      try {
        const raw = localStorage.getItem('reply_presets_v1');
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (obj && (obj.kids||obj.hi||obj.mbe)) userPresets = obj;
      } catch(_){}
    }
    function savePresetsToStorage(){
      try { if (userPresets) localStorage.setItem('reply_presets_v1', JSON.stringify(userPresets)); } catch(_){ }
    }

    // Favorites & usage counts
    function _loadFavSet(){ try{ return new Set(JSON.parse(localStorage.getItem('reply_preset_fav_v1')||'[]')); }catch(_){ return new Set(); } }
    function _saveFavSet(set){ try{ localStorage.setItem('reply_preset_fav_v1', JSON.stringify(Array.from(set))); }catch(_){ } }
    function _loadUseMap(){ try{ return new Map(Object.entries(JSON.parse(localStorage.getItem('reply_preset_use_v1')||'{}'))); }catch(_){ return new Map(); } }
    function _saveUseMap(map){ try{ localStorage.setItem('reply_preset_use_v1', JSON.stringify(Object.fromEntries(map))); }catch(_){ } }
    const _favSet=_loadFavSet();
    const _useMap=_loadUseMap();
    function isPresetFavorite(s){ return _favSet.has(s); }
    function togglePresetFavorite(s){ if (_favSet.has(s)) _favSet.delete(s); else _favSet.add(s); _saveFavSet(_favSet); }
    function getPresetUseCount(s){ const v=_useMap.get(s); return v?Number(v):0; }
    function incPresetUseCount(s){ const v=getPresetUseCount(s)+1; _useMap.set(s, v); _saveUseMap(_useMap); }
    let _pendingPresetUses = [];
    function _normalizeSimple(t){ return String(t||'').replace(/\s+/g,' ').trim(); }
    function markPresetPendingUse(baseKey, insertedText, rowIdx){
      _pendingPresetUses.push({ base: String(baseKey||''), inserted: String(insertedText||''), rowIdx: Number(rowIdx||0) });
    }
    function processPendingPresetUses(){
      if (!_pendingPresetUses.length) return;
      try {
        for (const rec of _pendingPresetUses){
          const rowIdx = rec.rowIdx;
          const base = rec.base;
          const insNorm = _normalizeSimple(rec.inserted);
          if (!base || !insNorm) continue;
          const it = items.find(x=>x && x.rowIdx===rowIdx);
          if (!it) continue;
          const gNorm = _normalizeSimple(it.gpt||'');
          if (gNorm.includes(insNorm)) {
            incPresetUseCount(base);
          }
        }
      } catch(_){ }
      _pendingPresetUses = [];
      try { renderPresetList(); } catch(_){ }
    }

    function maskBrandRandom(brandKey){
      const map = {
        kids: ['ÏóòÎ¶¨Ìïò*ÌÇ§Ï¶à','ÏóòÎ¶¨*Ïù¥ÌÇ§Ï¶à','ÏóòÎ¶¨XÏù¥ÌÇ§Ï¶à','ÏóòÎ¶¨ÌïòXÌÇ§Ï¶à','ÏóòÎ¶¨„ÖéÏù¥ÌÇ§Ï¶à'],
        hi:   ['ÏóòÎ¶¨Ìïò*','ÏóòÎ¶¨*Ïù¥','ÏóòÎ¶¨XÏù¥','ÏóòÎ¶¨ÌïòX','ÏóòÎ¶¨„ÖéÏù¥'],
        mbe:  ['Ïó†Î≤†*Ìä∏','Ïó†*Ïä§Ìä∏','Ïó†Î≤†XÌä∏','Ïó†Î≤†„ÖÖÌä∏','Ïó†Î≤†Ïä§X'],
      };
      const arr = map[brandKey]||map.hi; return arr[Math.floor(Math.random()*arr.length)];
    }
    function inferPresetBrandKey(it){
      const b = String((it&&it.brand)||'').trim();
      if (/Ïó†Î≤†/.test(b)) return 'mbe';
      if (/ÌÇ§Ï¶à$/.test(b)) return 'kids';
      if (/ÏóòÎ¶¨Ìïò/.test(b)) return 'hi';
      return 'hi';
    }
    function renderPresetTabs(){
      const cont = document.getElementById('presetTabs'); if (!cont) return;
      const btns = cont.querySelectorAll('[data-brand]');
      btns.forEach(btn=>{
        const k=btn.getAttribute('data-brand');
        btn.classList.toggle('active', k===activePresetBrand);
        btn.setAttribute('aria-pressed', String(k===activePresetBrand));
        btn.onclick=()=>{ activePresetBrand=k; renderPresetTabs(); renderPresetList(); };
      });
      const isDoneRow = (activeIndex>=0 && String(items[activeIndex]?.remark||'').trim()==='ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å');
      btns.forEach(btn=>{ if (isDoneRow) btn.setAttribute('disabled','true'); else btn.removeAttribute('disabled'); });
    }
    function renderPresetList(){
      const list=document.getElementById('presetList'); if (!list) return;
      const sInput=document.getElementById('presetSearch');
      const raw=(sInput && sInput.value) ? sInput.value.trim() : '';
      const terms = raw? raw.split(',').map(v=>v.trim()).filter(Boolean):[];
      const data=getEffectivePresets();
      const arr = (data[activePresetBrand]||[]).filter(s=>{
        if (!terms.length) return true;
        const hay = String(s||'');
        return terms.every(t=> hay.includes(t));
      });
      list.innerHTML='';
      const isDoneRow = (activeIndex>=0 && String(items[activeIndex]?.remark||'').trim()==='ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å');
      if (!arr.length){ list.innerHTML = '<div class="hint">ÌîÑÎ¶¨ÏÖãÏùÑ ÏóÖÎ°úÎìúÌï¥ Ï£ºÏÑ∏Ïöî</div>'; return; }
      for (const s of arr){
        const card=document.createElement('div');
        card.className='preset-card';
        card.style.border='1px solid var(--border)'; card.style.borderRadius='12px'; card.style.padding='10px 12px'; card.style.background='var(--panel,#fafafa)';
        card.style.cursor = isDoneRow ? 'not-allowed' : 'pointer'; card.style.display='flex'; card.style.alignItems='flex-start'; card.style.gap='10px';
        card.onmouseenter=()=>{ card.style.boxShadow='0 2px 8px rgba(0,0,0,.06)'; card.style.background='var(--card-hover,#f9fafb)'; };
        card.onmouseleave=()=>{ card.style.boxShadow='none'; card.style.background='var(--panel,#fafafa)'; };
        const fav=document.createElement('button'); fav.title='Ï¶êÍ≤®Ï∞æÍ∏∞'; fav.style.border='none'; fav.style.background='transparent'; fav.style.cursor='pointer'; fav.style.lineHeight='1'; fav.textContent='‚òÖ'; fav.style.fontSize='14px'; fav.style.color= isPresetFavorite(s)?'#f59e0b':'#d1d5db';
        const txt=document.createElement('div'); txt.textContent=s; txt.style.flex='1'; txt.style.whiteSpace='pre-wrap'; txt.style.lineHeight='1.5'; txt.style.fontSize='14px';
        const cnt=document.createElement('span'); cnt.className='badge'; cnt.style.background='#111827'; cnt.style.color='#fff'; cnt.style.borderRadius='10px'; cnt.style.padding='2px 8px'; cnt.style.fontSize='11px'; cnt.textContent=String(getPresetUseCount(s)||0);
        card.appendChild(fav); card.appendChild(txt); card.appendChild(cnt);
        card.onclick=()=>{ if (isDoneRow) return; insertPreset(s); };
        fav.onclick=(e)=>{ e.stopPropagation(); togglePresetFavorite(s); renderPresetList(); };
        list.appendChild(card);
      }
      // Ï¶êÍ≤®Ï∞æÍ∏∞ Ïö∞ÏÑ†, ÏÇ¨Ïö©Îüâ ÎÇ¥Î¶ºÏ∞®Ïàú
      const cards=Array.from(list.children);
      cards.sort((a,b)=>{
        const sa=a.querySelector('div')?.textContent||'';
        const sb=b.querySelector('div')?.textContent||'';
        const fa=isPresetFavorite(sa)?1:0; const fb=isPresetFavorite(sb)?1:0;
        if (fa!==fb) return fb-fa;
        return (getPresetUseCount(sb)||0)-(getPresetUseCount(sa)||0);
      });
      list.replaceChildren(...cards);
    }
    function insertPreset(tmpl){
      const ta=document.getElementById('gptInput'); if (!ta) return;
      const it = (activeIndex>=0)?items[activeIndex]:null;
      const k = activePresetBrand || inferPresetBrandKey(it);
      // ÏÑ†ÌÉùÌïú ÌÉ≠Ïùò Î∏åÎûúÎìúÎ°ú ÌòÑÏû¨ Ìñâ Î∏åÎûúÎìúÎ•º ÏûêÎèô Î≥ÄÍ≤Ω
      if (it) {
        const brandName = (k==='kids') ? 'ÏóòÎ¶¨ÌïòÏù¥ÌÇ§Ï¶à' : (k==='mbe' ? 'Ïó†Î≤†Ïä§Ìä∏' : 'ÏóòÎ¶¨ÌïòÏù¥');
        it.brand = brandName;
        const bi=document.getElementById('brandInput'); if (bi){ bi.value = brandName; }
        updateModifiedForCurrent();
      }
      const masked = tmpl.replaceAll('{brand_mask}', maskBrandRandom(k));
      let out = masked.replace(/[¬∑]/g,'ÏôÄ').replace(/[\/-]/g,' ');
      const start=ta.selectionStart||0, end=ta.selectionEnd||0; const prev=ta.value;
      ta.value = prev.slice(0,start) + out + prev.slice(end);
      ta.focus(); ta.setSelectionRange(start+out.length, start+out.length);
      applyChanges();
      // Ï†ÄÏû• Ïãú Ïã§Ï†ú ÏÇ¨Ïö©ÏúºÎ°ú Ïπ¥Ïö¥Ìä∏ (ÏßÄÏõ†Îã§ Î≥µÏõê Î∞©ÏßÄ)
      try { const it2=(activeIndex>=0)?items[activeIndex]:null; markPresetPendingUse(tmpl, out, it2?it2.rowIdx:0); } catch(_){ }
    }
    (function(){ const t=document.getElementById('presetTabs'); if (t) renderPresetTabs(); })();
    (function(){ const s=document.getElementById('presetSearch'); if (s) s.addEventListener('input', renderPresetList); })();
    (function(){ const u=document.getElementById('presetUploadXlsx'); const f=document.getElementById('presetFileXlsx'); if (u&&f){ u.onclick=()=>f.click(); f.onchange=handlePresetXlsx; }})();
    (function(){ const e=document.getElementById('presetExportJson'); if (e){ e.onclick=exportPresetJson; }})();
    (function(){ const r=document.getElementById('presetRegenIcon'); if (r){ r.onclick=()=>{ if (r.classList.contains('disabled')) return; if (activePresetBrand!=='rec') { activePresetBrand='rec'; renderPresetTabs(); } renderPresetList(); }; }})();
    (function(){ const c=document.getElementById('clearGptBtn'); if (c){ c.onclick=()=>{ const ta=document.getElementById('gptInput'); if (!ta) return; ta.value=''; applyChanges(); }; }})();

    async function handlePresetXlsx(){
      try {
        const f = document.getElementById('presetFileXlsx').files?.[0]; if (!f) return;
        await ensureXLSX();
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array' });
        const mapNames = new Map([
          ['ÏóòÎ¶¨ÌïòÏù¥ÌÇ§Ï¶à','kids'], ['ÏóòÎ¶¨ÌïòÏù¥','hi'], ['Ïó†Î≤†Ïä§Ìä∏','mbe'],
          ['kids','kids'], ['hi','hi'], ['mbe','mbe']
        ]);
        const out = { kids:[], hi:[], mbe:[] };
        for (const sn of wb.SheetNames){
          const key = mapNames.get(sn.trim()); if (!key) continue;
          const wsLocal = wb.Sheets[sn]; if (!wsLocal) continue;
          const aoa = XLSX.utils.sheet_to_json(wsLocal, { header:1, defval:"", blankrows:false });
          if (!aoa?.length) continue;
          for (let r=1; r<aoa.length; r++){
            const v = String(aoa[r]?.[0]||'').trim();
            if (!v) continue;
            out[key].push(v);
          }
        }
        for (const k of ['kids','hi','mbe']){
          const uniq = Array.from(new Set(out[k].map(s=>s.trim()).filter(Boolean)));
          out[k] = uniq.map(s=> s.replace(/[¬∑]/g,'ÏôÄ').replace(/[\/-]/g,' '));
        }
        userPresets = out; savePresetsToStorage();
        renderPresetTabs(); renderPresetList();
        try { showToast('ÌîÑÎ¶¨ÏÖãÏùÑ Î∂àÎü¨ÏôîÏñ¥Ïöî'); } catch(_) {}
      } catch(e){ alert('ÌîÑÎ¶¨ÏÖã Î∂àÎü¨Ïò§Í∏∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî. ' + (e?.message||e)); }
    }
    function exportPresetJson(){
      const data = userPresets || { kids:[], hi:[], mbe:[] };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='reply_presets.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

     // ---- Dynamic loader (fallback for CDN load failures) ----
     const XLSX_CANDIDATES = [
       "https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js",
       "https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js",
       "https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js",
       "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js"
     ];
     const FS_CANDIDATES = [
       "https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js",
       "https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js",
       "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"
     ];

     function loadScript(src) {
       return new Promise((resolve, reject) => {
         const s = document.createElement('script');
         s.src = src; s.async = true;
         s.onload = () => resolve(true);
         s.onerror = () => reject(new Error('load fail: '+src));
         document.head.appendChild(s);
       });
     }
     function injectScriptFromBlob(content) {
       return new Promise((resolve, reject) => {
         try {
           const blob = new Blob([content], { type: 'text/javascript' });
           const url = URL.createObjectURL(blob);
           const s = document.createElement('script');
           s.src = url; s.onload = () => { URL.revokeObjectURL(url); resolve(true); };
           s.onerror = () => { URL.revokeObjectURL(url); reject(new Error('blob inject fail')); };
           document.head.appendChild(s);
         } catch(e) { reject(e); }
       });
     }
     async function loadScriptSequential(urls) {
       for (const u of urls) {
         try { await loadScript(u); return true; } catch(e) {}
       }
       return false;
     }
     async function tryPickLocalLibrary(hiddenInputId, title) {
       // Prefer showOpenFilePicker when available (inside user gesture)
       try {
         if (window.showOpenFilePicker) {
           const [h] = await window.showOpenFilePicker({
             types: [{ description: title || 'JavaScript Library', accept: { 'text/javascript': ['.js'] } }],
             multiple: false,
           });
           const f = await h.getFile();
           const txt = await f.text();
           await injectScriptFromBlob(txt);
           return true;
         }
       } catch(e) {}
       // Fallback: hidden input
       return new Promise((resolve) => {
         const input = document.getElementById(hiddenInputId);
         const handler = async (ev) => {
           input.removeEventListener('change', handler);
           const f = ev.target.files && ev.target.files[0];
           if (!f) { resolve(false); return; }
           try {
             const txt = await f.text();
             await injectScriptFromBlob(txt);
             resolve(true);
           } catch(e){ resolve(false); }
         };
         input.addEventListener('change', handler);
         alert('Ïô∏Î∂Ä CDN Ï†ëÍ∑ºÏù¥ Ï†úÌïúÎêòÏñ¥ Î°úÏª¨ JS ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º ÏÑ†ÌÉùÌï©ÎãàÎã§.\nxlsx.full.min.js ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.');
         input.click();
       });
     }
     async function ensureXLSX() {
       if (window.XLSX) return;
       await loadScriptSequential(XLSX_CANDIDATES);
       if (!window.XLSX) {
         const ok = await tryPickLocalLibrary('libXlsxInput', 'XLSX (SheetJS)');
         if (!ok || !window.XLSX) throw new Error('XLSX library not available');
       }
     }
     async function ensureFileSaver() {
       if (window.saveAs) return;
       await loadScriptSequential(FS_CANDIDATES);
       if (!window.saveAs) {
         const ok = await tryPickLocalLibrary('libFsInput', 'FileSaver');
         if (!ok || !window.saveAs) throw new Error('FileSaver library not available');
       }
     }

    const colAliases = {
      cafe: ["Ïπ¥ÌéòÎ™Ö"],
      url: ["URL","Url","url","ÎßÅÌÅ¨"],
      gpt: ["gpt ÎãµÎ≥Ä","GPT ÎãµÎ≥Ä","GPT","GPTÎãµÎ≥Ä"],
      submit: ["ÎãµÎ≥Ä Ï†úÏ∂ú","ÎãµÎ≥ÄÏ†úÏ∂ú"],
      title: ["Ï†úÎ™©"],
      body: ["Î≥∏Î¨∏ÎÇ¥Ïö©","Î≥∏Î¨∏"],
      confirm: ["ÌôïÏù∏ Í≥ÑÏ†ï","ÌôïÏù∏Í≥ÑÏ†ï"],
      brand: ["Î∏åÎûúÎìú"],
      mynick: ["ÎÇòÏùò ÎãâÎÑ§ÏûÑ","ÎÇòÏùòÎãâÎÑ§ÏûÑ"],
    };

    // Keyword list (maintain here). Duplicates are removed at runtime.
    const KEYWORD_LIST_RAW = [
      'ÏßÄÎ©¥ÍµêÏû¨','ÌôîÏÉÅÏàòÏóÖ','ÌååÎãâÏä§','Ï∫êÎ¶≠ÌÑ∞','ÌïúÍ∏Ä ÎñºÍ∏∞','Î†àÎ≤®ÌÖåÏä§Ìä∏','ÌïôÏäµÍ¥ÄÎ¶¨Ïå§','Î∞õÏïÑÏì∞Í∏∞','Ïó∞ÏÇ∞','Î∂ÅÌÅ¥ÎüΩ','ÏóòÎ¶¨Íµ¨Íµ¨','Ïó∞ÏÇ∞ÏïÑÏùºÎûúÎìú','Ìå©ÌÜ†','Í∏∞Ï†ÅÏùò ÏãúÎ¶¨Ï¶à','Í∏∞Ï†ÅÏùò Í≥ÑÏÇ∞Î≤ï','Í∏∞Ï†ÅÏùò ÎèÖÌï¥Î†•','Í∏∞Ï†ÅÏùò ÌååÎãâÏä§','Í∏∞Ï†ÅÏùò ÏÇ¨Ïù¥Ìä∏ÏõåÎìú','Î™∏ÏúºÎ°ú Î∞∞Ïö∞Îäî ÌïúÍ∏Ä','ÎÜÄÏù¥Î°ú Î∞∞Ïö∞Îäî ÌïúÍ∏Ä','Î∞òÏùëÌòï ÎèôÌôî','ÏÇ¨Í≥†Î†• ÏàòÌïô','ÏÇ¨Í≥†Î†•','ÏÜåÎßàÌÅêÎ∏å','Ìå®ÌÑ¥Î∏îÎ°ù','Îß§Ìä∏Î¶≠Ïä§','Ïó∞ÏÇ∞ÎßÅ','ÌÉêÍµ¨ ÏΩîÎî©','ÎîîÏ¶àÎãà ÏòÅÏñ¥ÏòÅÏÉÅ','ÏòÅÏñ¥ÎèÑÏÑúÍ¥Ä','ÏòÅÏñ¥ÏòÅÏÉÅÍ¥Ä','ÏòÅÏñ¥ÏõêÏÑú','ÌçºÎ¶¨Î¶¨','ORT Ïò•Ïä§Ìè¨Îìú ÏõêÏÑúÎ¶¨Îî©','ÏßÄÎ©¥ ÍµêÏû¨ Ï†ïÍ∏∞ Î∞∞ÏÜ°','Ï†ïÍ∏∞ Î∞∞ÏÜ°','Îß§Ï£º ÌôîÏÉÅÏàòÏóÖ','ÌïúÍ∏Ä ÌôîÏÉÅÏàòÏóÖ','ÏàòÌïô ÌôîÏÉÅÏàòÏóÖ','ÎèÖÏÑú ÌôîÏÉÅÏàòÏóÖ','Ïä§ÌÜ†Î¶¨ÌÖîÎßÅ','ÌïôÎ∂ÄÎ™® Ï†ÑÌôî ÏÉÅÎã¥','ÏïåÎ¶ºÌÜ°','ÌîºÎìúÎ∞±','Í∞úÎ≥Ñ ÎßûÏ∂§ Í¥ÄÎ¶¨','ÏùºÎåÄÏùº Î∞ÄÏ∞© Í¥ÄÎ¶¨','ÌïôÏäµ Ïô∏ Í∏∞Îä• Ï∞®Îã®','Î¨¥ÏßÄÍ∞úÏ†¨','ÏÑ†Î¨º','Ï¥àÎì±ÏûÖÌïô ÎßàÏä§ÌÑ∞ÌÅ¥ÎûòÏä§','Ïò§ÎäòÏùò ÌïôÏäµ ÏôÑÎ£å','ÎÜÄÏù¥Ìòï ÎàÑÎ¶¨ÌïôÏäµ','Î∂ÅÌÅ¥ÎüΩ','Ï†ÄÌïôÎÖÑ Ï†ÑÏö© ÌôîÎ©¥','Í≥ºÎ™©Î≥Ñ Í≥ÑÌöç','ÏùºÎåÄÏùº','ÎßûÏ∂§ ÏßÄÎèÑ','Ï∂úÌåêÏÇ¨Î≥Ñ ÍµêÍ≥º Ïó∞Í≥Ñ Í∞ïÏùò','Í∂åÏßÄÎØºÏå§','ÎîîÎî§Îèå Í∏∞Î≥∏','ÎîîÎî§Îèå Í∏∞Ïùë','ÏµúÏÉÅÏúÑÏàòÌïô','Ï°∞ÏßÄÏòÅÏå§','Ï¥àÎì±ÏòÅÎ¨∏Î≤ï777','Ïä§ÎßàÌä∏ÌååÎãâÏä§','ÎßπÏßÄÌòÑÏå§','ÎøåÎ¶¨ÍπäÏùÄ Ï¥àÎì±Íµ≠Ïñ¥','Î¨∏Ìï¥Î†•ÏùÑÎ∂ÄÌÉÅÌï¥','Ïò§Ìà¨Ïå§','Ïú†ÏÑùÌõàÏå§','Î∞±Ï†ê','ÌÉêÍµ¨ÏòÅÏÉÅ','ÏÇ¨Î¨ºÍ∂ÅÏù¥','ÌóàÌåù','ÏàòÌñâÌèâÍ∞Ä ÎåÄÎπÑ','ÌÉêÍµ¨ÌôúÎèô','Ïñ¥Î¨∏Ìöå ÌïúÏûê Í∏âÏàò','1031 ÏãúÎ¶¨Ï¶à','ÍµêÍ≥ºÏÑú Ï∂úÌåêÏÇ¨Î≥Ñ Í∞ïÏùò','ÌïòÏù¥Ïó∞ÏÇ∞ Ïï±','ÏóòÎ¶¨ÌÜµÌï©ÏòÅÏñ¥ Ïï±','ORT','Ïò•Ïä§Ìè¨Îìú','Ï†êÌîÑÏàòÌïô Ïï±','ÌïôÎ∂ÄÎ™® Ïï± Ïó∞Îèô','Ïä§ÏúóÌÉÄÏûÑ','Ïã§ÏãúÍ∞Ñ ÌÉúÎèÑ Í¥ÄÎ¶¨','ÏùåÏÑ± ÏïàÎÇ¥','ÏûêÍ∏∞Ï£ºÎèÑ ÏäµÍ¥Ä','ÎàÑÏ†Å Í≥µÎ∂ÄÏãúÍ∞Ñ Í≤ΩÏüÅ','ÏÉÅÌíà','ÌïôÏäµ Ïô∏ Í∏∞Îä• Ï∞®Îã®','AIÏä§ÎßàÌä∏Îß§Ïì∞','ÏåçÎë•Ïù¥ Î¨∏Ï†ú','Ï†êÌîÑÏàòÌïô','ÎîîÏ¶àÎãà Î™®ÏÖòÏä§ÌÜ†Î¶¨','ÏòÅÏñ¥Ïä§ÌÜ†Î¶¨Î∂Å','Ïù∏Í∏∞ÎèôÏöî','Íµ¨Ïó∞ÎèôÌôî','Ï∞ΩÏûëÎèôÌôî','ÏóòÎ¶¨Ïä§ÎèÑÏø†','ÏÇ¨ÏûêÏàòÌïôÏò§ÎîîÏÑ∏Ïù¥','ÏòÅÏñ¥ÎèÑÏÑúÍ¥Ä','AIÎ†àÌÖå','Ï∂îÏ≤ú ÎèÑÏÑú','ÎèÖÏÑú ÌÄ¥Ï¶à','ÏóòÎ¶¨ÏâêÎèÑÏûâÎû©','Ïä§ÌîºÌÇπ Ïó∞Ïäµ','Î≥¥Ïπ¥ÎßàÏä§ÌÑ∞','ÏòÅÏñ¥ Îã®Ïñ¥ Í≥µÎ∂Ä','ÎòëÎòë ÌïúÏûêÎÇòÎùº','ÎèÑÏ†ÑÌïúÏûêÏôï','Ïã†ÎπÑÌïúARÏûêÏó∞Í¥ÄÏ∞∞','ARÌÉúÏñëÍ≥ÑÍ¥ÄÏ∞∞','ÏÇ¨Í≥ºÏïîÍ∏∞ÎßàÏä§ÌÑ∞','ÏóòÎ¶¨Î∞õÏïÑÏì∞Í∏∞','ÌÜµÌï©Í≥ºÎ™©','Î∂ÅÌÅ¥ÎüΩ','ÍµêÍ≥ºÏÑú Ï∂úÌåêÏÇ¨Î≥Ñ Í∞ïÏùò','Í≥ºÎ™©Î≥Ñ Í∞ïÏÇ¨ ÏÑ†ÌÉù','ÏàòÌïô Í∞ïÏùò','ÎØºÏ†ïÎ≤îÏå§','Í∞úÎÖêÏõêÎ¶¨','RPM','ÏóêÏù¥Í∏â','ÏµúÏÉÅÏúÑ','Î∏îÎûôÎùºÎ≤®','ÏòÅÏñ¥ Í∞ïÏùò','Î∞ïÏòÅÏïÑÏå§','Ï§ëÌïôÏòÅÎ¨∏Î≤ï 3800Ï†ú','ÌååÌä∏Î≥Ñ Í∞ïÏùò','Í≥ºÌïô Í∞ïÏùò','Ïû•ÌíçÏå§','Î∞±Ïã†','ÌïòÏù¥ÌÉë','Ìã∞Ï≤òÏä§','Íµ≠Ïñ¥ Í∞ïÏùò','Ïú†ÌòÑÏßÑÏå§','ÌîÑÎùºÏûÑ ÌäπÎ™©Î∞ò','ÏãúÌóòÍ∏∞Í∞Ñ ÌäπÍ∞ï','ÏßàÎ¨∏ Í≤åÏãúÌåê','Ïã§ÏãúÍ∞Ñ ÏßàÏùòÏùëÎãµ','ÌïúÍµ≠ÏÇ¨Îä•Î†•ÏãúÌóò Í∞ïÏùò','Ïñ¥Î¨∏Ìöå ÌïúÏûê ÎåÄÎπÑ Í∞ïÏùò','Ï°±Î≥¥Îã∑Ïª¥','ÌïôÍµê Í∏∞Ï∂úÎ¨∏Ï†ú','Ïä§ÏúóÌÉÄÏûÑ','Ïã§ÏãúÍ∞Ñ ÌÉúÎèÑ Í¥ÄÎ¶¨','ÏùåÏÑ± ÏïàÎÇ¥','ÏûêÍ∏∞Ï£ºÎèÑ ÏäµÍ¥Ä','ÎàÑÏ†Å Í≥µÎ∂ÄÏãúÍ∞Ñ Í≤ΩÏüÅ','ÏÉÅÌíà','ÌïôÏäµ Ïô∏ Í∏∞Îä• Ï∞®Îã®','ÏùºÎåÄÏùº ÌïôÏäµÍ¥ÄÎ¶¨','AIÏä§ÎßàÌä∏Îß§Ïì∞','ÏåçÎë•Ïù¥ Î¨∏Ï†ú'
    ];
    function getKeywordList(){
      const seen = new Set();
      const out = [];
      for (const k of KEYWORD_LIST_RAW){
        const s = String(k||'').trim();
        if (!s) continue;
        if (seen.has(s)) continue;
        seen.add(s); out.push(s);
      }
      return out;
    }

    function findColIndex(header, aliases) {
      const norm = header.map(h => String(h||"").trim());
      for (const a of aliases) {
        const i = norm.indexOf(a);
        if (i !== -1) return i;
      }
      // partial includes fallback
      for (let i=0;i<norm.length;i++) {
        for (const a of aliases) {
          if (a && norm[i].includes(a)) return i;
        }
      }
      return -1;
    }

    function pickSheetName(wb) {
      if (wb.SheetNames.includes("Î¶¨Ïä§Ìä∏_fix")) return "Î¶¨Ïä§Ìä∏_fix";
      return wb.SheetNames[0];
    }

    function sheetToAOA(ws) {
      return XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false, defval: "" });
    }

    function buildIndexMap() {
      map = {
        cafe: findColIndex(header, colAliases.cafe),
        url: findColIndex(header, colAliases.url),
        gpt: findColIndex(header, colAliases.gpt),
        submit: findColIndex(header, colAliases.submit),
        title: findColIndex(header, colAliases.title),
        body: findColIndex(header, colAliases.body),
        confirm: findColIndex(header, colAliases.confirm),
        brand: findColIndex(header, colAliases.brand),
        mynick: findColIndex(header, colAliases.mynick),
      };
    }

    function friendlyCafe(raw, url) {
      const s = String(raw||"").trim();
      if (s) return s;
      try { const m = String(url||"").match(/https?:\/\/([^\/]+)/); return m ? m[1] : "(ÎØ∏Ï†ï)"; } catch { return "(ÎØ∏Ï†ï)"; }
    }

    function rebuildItems() {
      items = [];
      const remarkIdx = findColIndex(header, ["ÎπÑÍ≥†"]);
      const myNickIdx = findColIndex(header, ["ÎÇòÏùò ÎãâÎÑ§ÏûÑ","ÎÇòÏùòÎãâÎÑ§ÏûÑ"]);
      for (let r = 1; r < rows.length; r++) { // r=0 header
        const row = rows[r] || [];
        const cafe = row[map.cafe] ?? "";
        const url = row[map.url] ?? "";
        const title = row[map.title] ?? "";
        const body = row[map.body] ?? "";
        const gpt = row[map.gpt] ?? "";
        const submitRaw = row[map.submit];
        const submit = normalizeSubmit(submitRaw);
        const remark = remarkIdx >= 0 ? (row[remarkIdx] ?? "") : "";
        const confirm = (map.confirm !== undefined && map.confirm >= 0) ? (row[map.confirm] ?? "") : "";
        const mynick = myNickIdx >= 0 ? (row[myNickIdx] ?? "") : "";
        const brand = (map.brand !== undefined && map.brand >= 0) ? (row[map.brand] ?? "") : "";
        const rec = { rowIdx: r+1, cafe, url, title, body, brand, gpt, submit, remark };
        // stable uid for drag/sort tracking
        rec.uid = `${r+1}-${String(url||'')}-${String(title||'').slice(0,20)}`;
        rec.confirm = confirm;
        rec.myNick = mynick;
        // keep originals to detect revert
        rec.initialGpt = gpt;
        rec.initialSubmit = submit;
        rec.initialCafe = cafe;
        rec.initialBrand = brand;
        rec.initialMyNick = mynick;
        items.push(rec); // Excel row index = r+1
      }
    }

    function normalizeSubmit(val) {
      if (typeof val === 'boolean') return val;
      const s = String(val||"").trim().toUpperCase();
      return s === "TRUE" || s === "1" || s === "YES" || s === "Y";
    }

    function renderList(filter="") {
      const list = document.getElementById('itemList');
      // Clean any leftover placeholder from previous renders
      try { if (_dndPlaceholder && _dndPlaceholder.parentElement) { _dndPlaceholder.parentElement.removeChild(_dndPlaceholder); } } catch(_){}
      // Preserve scroll position (relative) to avoid jumps during frequent re-renders
      const prevScrollTop = list.scrollTop;
      const maxBefore = Math.max(1, list.scrollHeight - list.clientHeight);
      const prevRatio = prevScrollTop / maxBefore;
      list.innerHTML = "";
      const raw = filter.trim().toLowerCase();
      const terms = raw ? raw.split(',').map(v=>v.trim()).filter(Boolean) : [];
      items.forEach((it, idx) => {
        if (terms.length){
          const hay = (it.cafe+" "+it.url+" "+(it.title||'')+" "+(it.gpt||'')).toLowerCase();
          const ok = terms.every(t=> hay.includes(t));
          if (!ok) return;
        }
        const el = document.createElement('div');
        const changed = modified.has(it.rowIdx);
        const soft = deletedRows.has(it.rowIdx);
        el.className = 'item'+(idx===activeIndex?' active':'')+(changed?' changed':'')+(soft?' soft-del':'');
        el.setAttribute('data-index', String(idx));
        el.setAttribute('draggable', ((!terms.length) && !soft) ? 'true' : 'false');
        el.addEventListener('click', (ev) => {
          if (_isReordering) return;
          if (!(ev.target && ev.target.classList && ev.target.classList.contains('selbox'))) {
            selectIndex(idx);
          }
        });
        const remarkBadge = (txt)=> {
          if (txt==='ÏûëÏóÖ ÏôÑÎ£å') return '<span class="badge done">ÏûëÏóÖ ÏôÑÎ£å</span>';
          if (txt==='ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å') return '<span class="badge comment">ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å</span>';
          if (txt==='Ïπ¥Ìéò Í∞ÄÏûÖÌïÑÏöî') return '<span class="badge danger">Ïπ¥ÌéòÍ∞ÄÏûÖÌïÑÏöî</span>';
          return '';
        };
        el.innerHTML = `
          <div class="name">${escapeHtml(friendlyCafe(it.cafe, it.url))}</div>
          <div class="url">${escapeHtml(it.url||'')}</div>
          <div class="badges">
            <span class="badge ${it.submit?'true':''}">${it.submit?'Ï†úÏ∂ú TRUE':'Ï†úÏ∂ú FALSE'}</span>
            ${remarkBadge(String(it.remark||'').trim())}
            ${changed? '<span class="badge warn">ÎØ∏Ï†ÄÏû• Î≥ÄÍ≤Ω</span>': ''}
          </div>
          <button class="del-ico" data-act="del" title="ÏÇ≠Ï†ú" aria-label="ÏÇ≠Ï†ú" ${soft?'style="display:none"':''}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-1 0v14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V6m3 4v8m4-8v8" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>`;
        const undoBtn = document.createElement('button');
        undoBtn.className='undo-ico'; undoBtn.setAttribute('title','ÎêòÎèåÎ¶¨Í∏∞'); undoBtn.setAttribute('aria-label','ÎêòÎèåÎ¶¨Í∏∞');
        if (!soft) undoBtn.style.display='none';
        undoBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5V1L7 6l5 5V7c3.309 0 6 2.691 6 6a6 6 0 0 1-6 6c-2.206 0-4.151-1.193-5.195-2.969" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        el.appendChild(undoBtn);
        const delBtn = el.querySelector('[data-act="del"]');
        if (delBtn) delBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); softDeleteRow(it.rowIdx); });
        if (undoBtn) undoBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); undoDeleteRow(it.rowIdx); });
        // Drag handlers
        el.addEventListener('dragstart', (e)=>{
          if ((terms.length>0) || soft) { e.preventDefault(); return; }
          _isReordering = true;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          try { e.dataTransfer.setData('text/plain', String(idx)); } catch(_){ }
          // ensure placeholder initial position
          if (_dndPlaceholder && _dndPlaceholder.parentElement){ try { _dndPlaceholder.parentElement.removeChild(_dndPlaceholder); } catch(_){} }
        });
        el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); _isReordering = false; if (_dndPlaceholder && _dndPlaceholder.parentElement){ _dndPlaceholder.parentElement.removeChild(_dndPlaceholder); } });
        // Let drop bubble to the list container handler
        list.appendChild(el);
      });
      // Restore scroll position relative to new content height
      const maxAfter = Math.max(1, list.scrollHeight - list.clientHeight);
      const target = Math.min(maxAfter, Math.max(0, Math.round(prevRatio * maxAfter)));
      if (Number.isFinite(target)) list.scrollTop = target;
      // Enable container dragover to show placeholder and compute target (ensure single binding)
      // Remove previous handlers if any (avoid duplicates across re-renders)
      if (list._dndHandlers) {
        try { list.removeEventListener('dragover', list._dndHandlers.over, { passive:false }); } catch(_){}
        try { list.removeEventListener('drop', list._dndHandlers.drop); } catch(_){}
      }
      if (!_dndPlaceholder){ _dndPlaceholder = document.createElement('div'); _dndPlaceholder.className='drop-placeholder'; }
      const placeholder = _dndPlaceholder;
      const getDragAfterElement = (container, y)=>{
        const els = [...container.querySelectorAll('.item:not(.dragging)')];
        let after = null;
        for (const c of els){
          const box = c.getBoundingClientRect();
          const mid = box.top + box.height/2;
          if (y < mid) { after = c; break; }
        }
        return after;
      };
      const onDragOver = (e)=>{
        e.preventDefault();
        const dragging = list.querySelector('.item.dragging');
        if (!dragging) return;
        const after = getDragAfterElement(list, e.clientY);
        if (placeholder.parentElement && placeholder.parentElement !== list) { try { placeholder.parentElement.removeChild(placeholder); } catch(_){} }
        if (!after) { list.appendChild(placeholder); }
        else if (after !== placeholder) { list.insertBefore(placeholder, after); }
      };
      const onDrop = (e)=>{
        e.preventDefault();
        const dragging = list.querySelector('.item.dragging');
        if (!dragging) return;
        const fromIdx = Number(dragging.getAttribute('data-index'))||0;
        let toIdx;
        if (placeholder.parentElement === list){
          const sib = placeholder.nextElementSibling;
          if (sib && sib.classList && sib.classList.contains('item')){
            const j = Number(sib.getAttribute('data-index'))||0;
            toIdx = (fromIdx < j) ? (j - 1) : j; // compute target in new array space
          } else {
            toIdx = items.length - 1; // append at end
          }
        } else {
          return;
        }
        if (fromIdx !== toIdx){
          const arr = items.slice();
          const [moved] = arr.splice(fromIdx,1);
          arr.splice(toIdx,0,moved);
          items = arr;
          const keepUid = moved && moved.uid;
          // Î®ºÏ†Ä Î≥ÄÍ≤Ω ÌîåÎûòÍ∑∏Î•º Í∏∞Î°ùÌï¥ Ïû¨Î†åÎçî Ïãú Î∞∞ÏßÄÍ∞Ä Ï¶âÏãú ÌëúÏãúÎêòÎèÑÎ°ù
          if (moved) {
            const prev = modified.get(moved.rowIdx) || {};
            modified.set(moved.rowIdx, { ...prev });
          }
          renderList(document.getElementById('searchInput').value||'');
          const newIndex = items.findIndex(it=> it.uid===keepUid);
          if (newIndex>=0) selectIndex(newIndex);
          _orderDirty = true;
          updateTargetCount();
        }
        if (placeholder.parentElement) placeholder.parentElement.removeChild(placeholder);
      };
      list.addEventListener('dragover', onDragOver, { passive:false });
      list.addEventListener('drop', onDrop);
      list._dndHandlers = { over: onDragOver, drop: onDrop };
      
      // Update mobile badge count
      const mobileItemCount = document.getElementById('mobileItemCount');
      if (mobileItemCount) {
        const visibleCount = list.querySelectorAll('.item').length;
        mobileItemCount.textContent = String(visibleCount);
        mobileItemCount.style.display = visibleCount > 0 ? 'flex' : 'none';
      }
    }

    function selectIndex(idx) {
      activeIndex = idx;
      document.querySelectorAll('.item').forEach((el,i)=>{
        el.classList.toggle('active', i===idx);
      });
      if (idx < 0) return;
      const it = items[idx];
      document.getElementById('emptyStateLeft').style.display = 'none';
      document.getElementById('editorPanel').style.display = '';
      // reset any ongoing spell check and panel when switching rows
      try { if (_spellAbort) { _spellAbort.abort(); } } catch(_) {}
      _spellAbort = null; _spellState = { textSnapshot: '', matches: [] };
      (function(){ const sp=document.getElementById('spellPanel'); if (sp){ sp.style.display='none'; sp.innerHTML=''; } })();
      (function(){ const rp=document.getElementById('reviewPanel'); if (rp){ rp.style.display='none'; rp.innerHTML=''; } })();
      (function(){ const kp=document.getElementById('kwPanel'); if (kp){ kp.style.display='none'; kp.innerHTML=''; } })();
      (function(){
        const acc = String(it.confirm||'').trim();
        const base = `Ìñâ: ${it.rowIdx} | Ïπ¥ÌéòÎ™Ö: ${friendlyCafe(it.cafe, it.url)}`;
        document.getElementById('rowInfo').textContent = acc ? `${base} | Í≥ÑÏ†ï: ${acc}` : base;
      })();
      // Ïπ¥ÌéòÎ™Ö ÏûÖÎ†•Í∞í ÏÑ∏ÌåÖ(Îπà Í≤ΩÏö∞ URL Í∏∞Î∞ò Ïù¥Î¶Ñ ÌëúÏãú)
      (function(){
        const ciOld = document.getElementById('cafeInput');
        if (!ciOld) return;
        // Replace node to clear previous listeners
        const ciNew = ciOld.cloneNode(true);
        ciOld.replaceWith(ciNew);
        ciNew.value = String(it.cafe||friendlyCafe(it.cafe, it.url)||'');
        bindCafeInput();
      })();
      (function(){
        const mn = document.getElementById('myNickInput');
        if (mn) { mn.value = String(it.myNick||''); mn.disabled = true; }
        const btn = document.getElementById('nickEditBtn');
        if (btn) btn.onclick = ()=>{ const input=document.getElementById('myNickInput'); if (input){ input.disabled=false; input.focus(); const v=input.value||''; input.setSelectionRange(v.length, v.length);} };
        bindMyNickInput();
      })();
      // ensure dirty highlight reflects current row (fresh evaluation)
      updateModifiedForCurrent();
      (function(){
        const biOld = document.getElementById('brandInput');
        if (!biOld) return;
        const biNew = biOld.cloneNode(true);
        biOld.replaceWith(biNew);
        biNew.value = String(it.brand||'');
        bindBrandInput();
      })();
      const gptInput = document.getElementById('gptInput');
      const clearBtn = document.getElementById('clearGptBtn');
      if (gptInput) {
        gptInput.value = it.gpt || '';
        if (clearBtn) clearBtn.style.display = (it.gpt && it.gpt.trim()) ? 'block' : 'none';
      }
      document.getElementById('titleInput').value = it.title || '';
      document.getElementById('bodyInput').value = it.body || '';
      // Ï†úÏ∂ú ÏÉÅÌÉú ÏÑ∏Í∑∏Î®ºÌä∏ ÎèôÍ∏∞Ìôî
      setSubmitSeg(!!it.submit);
      document.getElementById('urlInfo').textContent = it.url || 'ÎØ∏Î¶¨Î≥¥Í∏∞';
      document.getElementById('openNewTab').href = it.url || '#';
      bindToolbox();
      try {
        const u = new URL(it.url);
        const isNaverCafe = /(^|\.)cafe\.naver\.com$/i.test(u.hostname);
        document.getElementById('blockNote').style.display = isNaverCafe ? '' : 'none';
      } catch(e) { document.getElementById('blockNote').style.display = 'none'; }
      // ÎØ∏Î¶¨Î≥¥Í∏∞ Ï†úÍ±∞ ‚Üí Ìà¥Î∞ïÏä§Îßå ÏÇ¨Ïö©
      // ÌîÑÎ¶¨ÏÖã Ï∂îÏ≤ú ÌÉ≠ ÌôúÏÑ± Ïãú, Ìñâ Î≥ÄÍ≤ΩÏóê Îî∞Îùº Ï∂îÏ≤ú Ï¶âÏãú Í∞±Ïã†
      try {
        if (activePresetBrand==='rec') { renderPresetTabs(); renderPresetList(); }
      } catch(_){ }
    }

    function applyChanges() {
      if (activeIndex < 0) return;
      const it = items[activeIndex];
      const gpt = document.getElementById('gptInput').value || '';
      const submit = getSubmitSeg();
      const cafeRaw = (document.getElementById('cafeInput') && document.getElementById('cafeInput').value) || '';
      const brandRaw = (document.getElementById('brandInput') && document.getElementById('brandInput').value) || '';
      // Î°úÏª¨ ÏÉÅÌÉú Í∞±Ïã†
      it.gpt = gpt; it.submit = submit; it.cafe = cafeRaw; it.brand = brandRaw;
      updateModifiedForCurrent();
      renderList(document.getElementById('searchInput').value || '');
      bindToolbox();
      updateTargetCount();
    }

    // Track GPT input live to avoid losing edits on auto-save
    function bindGptInput(){
      const ta=document.getElementById('gptInput'); if (!ta) return;
      const clearBtn = document.getElementById('clearGptBtn');
      ta.addEventListener('input', ()=>{
        if (activeIndex>=0){
          items[activeIndex].gpt = ta.value;
          updateModifiedForCurrent();
          bindToolbox();
          updateTargetCount();
        }
        // Show/hide clear button based on content
        if (clearBtn) clearBtn.style.display = ta.value.trim() ? 'block' : 'none';
      });
    }

    function updateModifiedForCurrent() {
      if (activeIndex < 0) return;
      const it = items[activeIndex];
      const gpt = String(it.gpt||'');
      const submit = Boolean(it.submit);
      const cafe = String(it.cafe||'');
      const brand = String(it.brand||'');
      const myn = String(it.myNick||'');
      const changed = (gpt !== String(it.initialGpt||'')) || (submit !== Boolean(it.initialSubmit)) || (cafe !== String(it.initialCafe||'')) || (brand !== String(it.initialBrand||'')) || (myn !== String(it.initialMyNick||''));
      if (changed) {
        modified.set(it.rowIdx, { gpt: it.gpt, submit: it.submit, cafe: it.cafe, brand: it.brand, myNick: it.myNick });
      } else {
        modified.delete(it.rowIdx);
      }
      // UI dirty highlight
      try {
        const setDirty = (el, on)=>{ if (!el) return; el.classList.toggle('input-dirty', !!on); };
        setDirty(document.getElementById('cafeInput'), cafe !== String(it.initialCafe||''));
        setDirty(document.getElementById('myNickInput'), myn !== String(it.initialMyNick||''));
        setDirty(document.getElementById('brandInput'), brand !== String(it.initialBrand||''));
        setDirty(document.getElementById('gptInput'), gpt !== String(it.initialGpt||''));
        const seg = document.getElementById('submitSeg'); if (seg) seg.classList.toggle('seg-dirty', submit !== Boolean(it.initialSubmit));
      } catch(_){}
    }

    function normalizeCafeName(raw) {
      try {
        let s = String(raw||'').replace(/\u200b/g,'').trim();
        if (!s) return '';
        s = s.replace(/^\s*[\(\)\[\]/{},<>:=Ôºö‚óÜ‚òÖ‚òÜ‚ô°‚ô•‚ô£‚ô™~\|‚îÇ„Ö£_\-‚Äì‚Äî‚Äª‚ñ∂‚ñ∑‚óÄ‚ñ≤‚ñº‚Ä¢¬∑‚àô,]+/g, '');
        const parts = s.split(/[\(\)\[\]/{},<>:=Ôºö‚óÜ‚òÖ‚òÜ‚ô°‚óÄ‚ô•‚ô™~‚Ä¢¬∑‚àô]+/).map(p=>p.trim()).filter(Boolean);
        let left = (parts[0]||s).trim();
        left = left.replace(/[\]\)\}‚óÜ‚òÖ‚òÜ‚ô°‚óÄ‚ô•‚ô™~‚Ä¢¬∑‚àô]+$/, '').trim();
        return left;
      } catch(e) { return String(raw||'').trim(); }
    }

    function bindCafeInput() {
      const ci = document.getElementById('cafeInput');
      if (!ci) return;
      // Unbind by replacement already done; now attach fresh listeners
      ci.addEventListener('input', ()=>{
        if (activeIndex>=0) {
          items[activeIndex].cafe = ci.value;
          updateModifiedForCurrent();
          renderList(document.getElementById('searchInput').value||'');
          bindToolbox();
          updateTargetCount();
        }
      });
      ci.addEventListener('keydown', (e)=>{
        if (e.key==='Enter') {
          e.preventDefault();
          ci.value = normalizeCafeName(ci.value||'');
          if (activeIndex>=0) {
            items[activeIndex].cafe = ci.value;
            updateModifiedForCurrent();
            renderList(document.getElementById('searchInput').value||'');
            bindToolbox();
            updateTargetCount();
          }
        }
      });
      ci.addEventListener('blur', ()=>{
        ci.value = normalizeCafeName(ci.value||'');
        if (activeIndex>=0) {
          items[activeIndex].cafe = ci.value;
          updateModifiedForCurrent();
          renderList(document.getElementById('searchInput').value || '');
          bindToolbox();
          updateTargetCount();
        }
      });
    }

    function bindBrandInput() {
      const bi = document.getElementById('brandInput');
      if (!bi) return;
      const sync = ()=>{
        if (activeIndex>=0) {
          items[activeIndex].brand = bi.value;
          updateModifiedForCurrent();
          renderList(document.getElementById('searchInput').value||'');
          bindToolbox();
          updateTargetCount();
        }
      };
      bi.addEventListener('input', sync);
      bi.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); sync(); bi.blur(); }});
      bi.addEventListener('blur', sync);
    }

    function bindMyNickInput(){
      const ni = document.getElementById('myNickInput'); if (!ni) return;
      const sync = ()=>{
        if (activeIndex>=0){ items[activeIndex].myNick = ni.value; updateModifiedForCurrent(); renderList(document.getElementById('searchInput').value||''); bindToolbox(); updateTargetCount(); }
      };
      ni.addEventListener('input', sync);
      ni.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); sync(); ni.blur(); }});
      ni.addEventListener('blur', sync);
    }

    function setSubmitSeg(val) {
      const seg = document.getElementById('submitSeg');
      if (!seg) return;
      const btns = seg.querySelectorAll('.seg-btn');
      btns.forEach(b => b.classList.remove('active'));
      const t = seg.querySelector('.seg-btn[data-val="true"]');
      const f = seg.querySelector('.seg-btn[data-val="false"]');
      (val ? t : f).classList.add('active');
      seg.setAttribute('data-value', String(!!val));
    }

    function getSubmitSeg() {
      const seg = document.getElementById('submitSeg');
      if (!seg) return false;
      const v = seg.getAttribute('data-value');
      return v === 'true';
    }

    function escapeHtml(s) {
      return String(s||"").replace(/[&<>"]+/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
    }

    function hasUnsavedChanges(){
      try { return (modified && modified.size>0) || (deletedRows && deletedRows.size>0); } catch(_) { return false; }
    }

    function openUnsavedModal(){ const ov=document.getElementById('unsavedModal'); if (ov) ov.classList.add('show'); }
    function closeUnsavedModal(){ const ov=document.getElementById('unsavedModal'); if (ov) ov.classList.remove('show'); }

    async function startFileOpen(){
      try { await ensureXLSX(); } catch(e){ console.error(e); alert('ÌååÏùº Ïó¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (XLSX Î°úÎìú)\n'+(e&&e.message?e.message:'')); return; }
      if (window.showOpenFilePicker) {
        const baseOpts = {
          id: 'excel-open',
          types: [{ description: 'Excel', accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'], 'application/vnd.ms-excel': ['.xls'] } }],
          multiple: false,
        };
        let handle;
        try {
          const opts = { ...baseOpts };
          if (fileHandle) opts.startIn = fileHandle; else opts.startIn = 'downloads';
          [handle] = await window.showOpenFilePicker(opts);
        } catch(e){
          // retry without startIn if not allowed
          [handle] = await window.showOpenFilePicker(baseOpts);
        }
        fileHandle = handle;
        const file = await handle.getFile();
        openedFilename = file.name;
        document.getElementById('fileLabel').textContent = file.name;
        const urlBtn=document.getElementById('urlManagerBtn'); if (urlBtn) urlBtn.disabled=false;
        const applyBtn=document.getElementById('applyConfirmBtn'); if (applyBtn) applyBtn.disabled=false;
        const subBtn=document.getElementById('submitConfirmBtn'); if (subBtn) subBtn.disabled=false;
        const asBtn=document.getElementById('autoSaveBtn'); if (asBtn) asBtn.disabled=false;
        const buf = await file.arrayBuffer();
        // reset states on open
        modified = new Map();
        deletedRows = new Set();
        selectedRows = new Set();
        undoStack.length = 0;
        loadWorkbook(buf);
      } else {
        document.getElementById('fileInput').click();
      }
    }

    async function openFromFile(file, handle){
      try {
        try { await ensureXLSX(); } catch(e){ console.error(e); alert('ÌååÏùº Ïó¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (XLSX Î°úÎìú)\n'+(e&&e.message?e.message:'')); return; }
        if (!file) return;
        openedFilename = file.name;
        if (typeof handle !== 'undefined') { fileHandle = handle; } else { fileHandle = null; }
        const label=document.getElementById('fileLabel'); if (label) label.textContent = openedFilename;
        const urlBtn=document.getElementById('urlManagerBtn'); if (urlBtn) urlBtn.disabled=false;
        const applyBtn=document.getElementById('applyConfirmBtn'); if (applyBtn) applyBtn.disabled=false;
        const subBtn=document.getElementById('submitConfirmBtn'); if (subBtn) subBtn.disabled=false;
        const asBtn=document.getElementById('autoSaveBtn'); if (asBtn) asBtn.disabled=false;
        const buf = await file.arrayBuffer();
        modified = new Map();
        deletedRows = new Set();
        selectedRows = new Set();
        undoStack.length = 0;
        loadWorkbook(buf);
      } catch(e){ console.error(e); alert('ÌååÏùº Ïó¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n'+(e&&e.message?e.message:'')); }
    }

    async function openFile() {
      try {
        if (hasUnsavedChanges()) { openUnsavedModal(); return; }
        await startFileOpen();
      } catch (e) {
        console.error(e);
        alert('ÌååÏùº Ïó¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }

    function loadWorkbook(arrayBuffer) {
      workbook = XLSX.read(arrayBuffer, { type: 'array' });
      worksheetName = pickSheetName(workbook);
      ws = workbook.Sheets[worksheetName];
      rows = sheetToAOA(ws);
      if (!rows.length) { alert('ÏãúÌä∏Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.'); return; }
      header = rows[0].map(v => String(v||'').trim());
      buildIndexMap();
      // ÌïÑÏàò Ïª¨Îüº Ï†êÍ≤Ä
      if (map.url < 0 || map.gpt < 0 || map.submit < 0) {
        alert('ÌïÑÏàò Ïª¨Îüº(URL, gpt ÎãµÎ≥Ä, ÎãµÎ≥Ä Ï†úÏ∂ú)ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
      }
      // reset states on load
      modified = new Map();
      deletedRows = new Set();
      selectedRows = new Set();
      undoStack.length = 0;
      const dh=document.getElementById('dropHint'); if (dh) dh.style.display='none';
      rebuildItems();
      renderList();
      updateTargetCount();
      selectIndex(-1);
    }

    function rebuildWorksheetForSave() {
      if (!rows || rows.length === 0) return;
      const newRows = [];
      newRows.push(rows[0].slice());
      // Build map from original Excel rowIdx -> row data
      const original = new Map();
      for (let r = 1; r < rows.length; r++) { original.set(r+1, rows[r] ? rows[r].slice() : []); }
      // Follow current items order to rebuild (respect deletions and modifications)
      for (const it of items){
        const rowIdxExcel = it.rowIdx;
        if (deletedRows.has(rowIdxExcel)) continue;
        const base = original.get(rowIdxExcel) ? original.get(rowIdxExcel).slice() : new Array(header.length).fill('');
        const m = modified.get(rowIdxExcel);
        if (m) {
          if (map.gpt >= 0 && typeof m.gpt !== 'undefined') base[map.gpt] = String(m.gpt || '');
          if (map.submit >= 0 && typeof m.submit !== 'undefined') base[map.submit] = m.submit ? 'TRUE' : 'FALSE';
          if (map.cafe >= 0 && typeof m.cafe !== 'undefined') base[map.cafe] = String(m.cafe||'');
          if (map.brand >= 0 && typeof m.brand !== 'undefined') base[map.brand] = String(m.brand||'');
          if (map.mynick >= 0 && typeof m.myNick !== 'undefined') base[map.mynick] = String(m.myNick||'');
        }
        newRows.push(base);
      }
      const newWs = XLSX.utils.aoa_to_sheet(newRows);
      workbook.Sheets[worksheetName] = newWs;
      ws = newWs;
      rows = newRows;
      rebuildItems();
    }

    async function saveFile(opts) {
      const o = opts||{}; const silent = !!o.silent; const isAuto = !!o.auto;
      if (!workbook || !ws) { if (!silent) alert('Î®ºÏ†Ä ÌååÏùºÏùÑ Ïó¨ÏÑ∏Ïöî.'); return false; }
      await ensureXLSX();
      // rebuild sheet from rows + modifications + deletions
      if (_isReordering) return false; // don't save mid-drag
      // Avoid stealing focus/selection side effects: snapshot active index, stable key, and GPT
      const prevActive = activeIndex;
      const prevItem = (prevActive>=0 && items[prevActive]) ? items[prevActive] : null;
      const prevKey = prevItem ? ((typeof normalizeUrl==='function' ? normalizeUrl(prevItem.url||'') : String(prevItem.url||'')) + '||' + String(prevItem.title||'')) : '';
      const prevGpt = prevItem ? String(prevItem.gpt||'') : '';
      rebuildWorksheetForSave();
      try {
        // File System Access API Ïö∞ÏÑ† ÏÇ¨Ïö©
        const outBuf = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        if (fileHandle && fileHandle.createWritable) {
          const writable = await fileHandle.createWritable();
          await writable.write(new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
          await writable.close();
          if (silent) { showToast(isAuto ? 'ÏûêÎèô Ï†ÄÏû• ÏôÑÎ£å' : 'Ï†ÄÏû• ÏôÑÎ£å'); } else { alert('Ï†ÄÏû• ÏôÑÎ£å: ÏõêÎ≥∏ ÌååÏùºÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.'); }
          // ÌîÑÎ¶¨ÏÖã ÏÇ¨Ïö© ÏßëÍ≥Ñ Î∞òÏòÅ
          try { processPendingPresetUses(); } catch(_){ }
          modified.clear();
          deletedRows.clear();
          selectedRows.clear();
          undoStack.length = 0;
          // Ï†ÄÏû• ÌõÑ Ï¢åÏ∏° Î≥ÄÍ≤ΩÌëúÏãú Ï¥àÍ∏∞Ìôî(Î¶¨Ïä§Ìä∏ Ïû¨Î†åÎçî), ÌòÑÏû¨ ÏÑ†ÌÉù/Ìé∏Ïßë ÎÇ¥Ïö© Ïú†ÏßÄ
          const q = document.getElementById('searchInput').value || '';
          renderList(q);
          let restoreIdx = -1;
          if (prevKey){
            for (let i=0;i<items.length;i++){
              const it=items[i];
              const key = ((typeof normalizeUrl==='function' ? normalizeUrl(it.url||'') : String(it.url||'')) + '||' + String(it.title||''));
              if (key===prevKey){ restoreIdx = i; break; }
            }
          }
          if (restoreIdx<0 && prevActive>=0 && prevActive<items.length) restoreIdx = prevActive;
          if (restoreIdx>=0){
            selectIndex(restoreIdx);
            const ta=document.getElementById('gptInput'); if (ta){ ta.value = prevGpt; }
          }
          updateTargetCount();
          // clear dirty highlights after successful save
          try {
            ['cafeInput','myNickInput','brandInput','gptInput'].forEach(id=>{ const el=document.getElementById(id); if (el) el.classList.remove('input-dirty'); });
            const seg=document.getElementById('submitSeg'); if (seg) seg.classList.remove('seg-dirty');
          } catch(_){ }
          return true;
        } else {
          await ensureFileSaver();
          if (silent) {
            // ÏûêÎèô Ï†ÄÏû• Ï§ë ÏõêÎ≥∏ ÎçÆÏñ¥Ïì∞Í∏∞ Î∂àÍ∞ÄÌïú ÌôòÍ≤Ω: Ï°∞Ïö©Ìûà Ìå®Ïä§ (Îã§Ïö¥Î°úÎìú ÎÇ®Î∞ú Î∞©ÏßÄ)
            return false;
          }
          
          // Î™®Î∞îÏùº: ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÌååÏùºÎ™Ö
          let name = openedFilename || 'list_extract_fix.xlsx';
          if (isIOS) {
            // Î™®Î∞îÏùºÏóêÏÑúÎßå ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä
            const now = new Date();
            const timestamp = now.getFullYear() + 
                            String(now.getMonth() + 1).padStart(2, '0') + 
                            String(now.getDate()).padStart(2, '0') + '_' +
                            String(now.getHours()).padStart(2, '0') + 
                            String(now.getMinutes()).padStart(2, '0') + 
                            String(now.getSeconds()).padStart(2, '0');
            const baseName = name.replace(/\.xlsx$/i, '');
            name = `${baseName}_mobile_${timestamp}.xlsx`;
          }
          
          saveAs(new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), name);
          
          // Î™®Î∞îÏùº: ÏïàÎÇ¥ Î©îÏãúÏßÄ
          if (isIOS) {
            alert('‚úÖ Ï†ÄÏû• ÏôÑÎ£å!\n\nüì• ÌååÏùºÎ™Ö: ' + name + '\n\nüìÇ Îã§Ïö¥Î°úÎìú Ìè¥ÎçîÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.\n\nüí° ÌååÏùº Ïï±ÏóêÏÑú ÏõêÌïòÎäî ÏúÑÏπòÎ°ú Ïù¥ÎèôÌïòÏÑ∏Ïöî.');
          } else {
            alert('Îã§Ïö¥Î°úÎìúÎ°ú Ï†ÄÏû•ÌñàÏäµÎãàÎã§.');
          }
          
          try { processPendingPresetUses(); } catch(_){ }
          modified.clear();
          deletedRows.clear();
          selectedRows.clear();
          undoStack.length = 0;
          const q2 = document.getElementById('searchInput').value || '';
          renderList(q2);
          let restoreIdx2 = -1;
          if (prevKey){
            for (let i=0;i<items.length;i++){
              const it=items[i];
              const key = ((typeof normalizeUrl==='function' ? normalizeUrl(it.url||'') : String(it.url||'')) + '||' + String(it.title||''));
              if (key===prevKey){ restoreIdx2 = i; break; }
            }
          }
          if (restoreIdx2<0 && prevActive>=0 && prevActive<items.length) restoreIdx2 = prevActive;
          if (restoreIdx2>=0){
            selectIndex(restoreIdx2);
            const ta2=document.getElementById('gptInput'); if (ta2){ ta2.value = prevGpt; }
          }
          updateTargetCount();
          try {
            ['cafeInput','myNickInput','brandInput','gptInput'].forEach(id=>{ const el=document.getElementById(id); if (el) el.classList.remove('input-dirty'); });
            const seg=document.getElementById('submitSeg'); if (seg) seg.classList.remove('seg-dirty');
          } catch(_){ }
          return true;
        }
      } catch (e) {
        console.error(e);
        if (!silent) alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'); else showToast('ÏûêÎèô Ï†ÄÏû• Ïã§Ìå®');
        return false;
      }
    }

    async function saveFileAs() {
      if (!workbook || !ws) { alert('Î®ºÏ†Ä ÌååÏùºÏùÑ Ïó¨ÏÑ∏Ïöî.'); return; }
      await ensureXLSX();
      // rebuild sheet for Save As as well
      rebuildWorksheetForSave();
      try {
        const outBuf = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        if (window.showSaveFilePicker) {
          const handle = await window.showSaveFilePicker({
            suggestedName: (openedFilename? openedFilename.replace(/\.xlsx$/i, '') : 'list_extract_fix') + '_edited.xlsx',
            types: [{ description: 'Excel', accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] } }],
          });
          const writable = await handle.createWritable();
          await writable.write(new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
          await writable.close();
          alert('Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû• ÏôÑÎ£å');
          try { processPendingPresetUses(); } catch(_){ }
          // Ï†ÄÏû• ÏôÑÎ£åÎ°ú Í∞ÑÏ£ºÌïòÍ≥† Î≥ÄÍ≤Ω ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
          modified.clear();
          deletedRows.clear();
          selectedRows.clear();
          undoStack.length = 0;
          renderList(document.getElementById('searchInput').value || '');
          updateTargetCount();
        } else {
          await ensureFileSaver();
          const name = (openedFilename? openedFilename.replace(/\.xlsx$/i, '') : 'list_extract_fix') + '_edited.xlsx';
          saveAs(new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), name);
          // Îã§Ïö¥Î°úÎìú Ï†ÄÏû• ÏãúÏóêÎèÑ ÌòÑÏû¨ Î≥ÄÍ≤ΩÏùÄ Ï†ÄÏû•Îêú Í≤ÉÏúºÎ°ú Î≥¥Í≥† Ï¥àÍ∏∞Ìôî
          try { processPendingPresetUses(); } catch(_){ }
          modified.clear();
          deletedRows.clear();
          selectedRows.clear();
          undoStack.length = 0;
          renderList(document.getElementById('searchInput').value || '');
          updateTargetCount();
        }
      } catch(e) {
        console.error(e);
        alert('Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }

    async function fetchReaderContent(url) {
      // ÌîÑÎ°ùÏãúÎ•º ÌÜµÌï¥ Markdown/ÌÖçÏä§Ìä∏Î•º Î∞õÏïÑ readerViewÎ°ú ÌëúÏãú
      const makeProxyUrl = (orig) => {
        try {
          const m = String(orig||'').match(/^(https?):\/\/(.*)$/i);
          if (!m) return orig;
          return 'https://r.jina.ai/' + m[1] + '://' + m[2];
        } catch(e) { return orig; }
      };
      const proxy = makeProxyUrl(url);
      const reader = document.getElementById('readerView');
      const iframe = document.getElementById('previewFrame');
      iframe.style.display = 'none';
      reader.style.display = '';
      reader.innerHTML = '<div class="hint">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
      try {
        const res = await fetch(proxy, { cache: 'no-store' });
        const txt = await res.text();
        // Í∞ÑÎã® Î†åÎçî: Ï§ÑÎ∞îÍøà/ÎßÅÌÅ¨ Í∞ïÏ°∞
        const esc = (s)=>String(s||'').replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
        const linkified = esc(txt)
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\[(.*?)\]\((https?:[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
          .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>')
          .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
          .replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
          .replace(/\n{2,}/g, '</p><p>')
          .replace(/^/, '<p>')
          .replace(/$/, '</p>');
        reader.innerHTML = linkified;
      } catch(e) {
        reader.innerHTML = '<div class="hint" style="color:#ef4444;">Î∂àÎü¨Ïò§Í∏∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî. ÏÉà ÌÉ≠ Ïó¥Í∏∞Î•º ÏÇ¨Ïö©Ìï¥ Ï£ºÏÑ∏Ïöî.</div>';
      }
    }

    function openInPane() {
      if (activeIndex < 0) return;
      const url = items[activeIndex].url || '';
      const iframe = document.getElementById('previewFrame');
      if (!url) return;
      try {
        const u = new URL(url);
        const isNaverCafe = /(^|\.)cafe\.naver\.com$/i.test(u.hostname);
        if (isNaverCafe) {
          fetchReaderContent(url); // ÌÖçÏä§Ìä∏ Í∏∞Î∞ò ÌîÑÎ°ùÏãú Î†åÎçî
        } else {
          document.getElementById('readerView').style.display = 'none';
          iframe.style.display = '';
          iframe.src = url;
        }
      } catch (e) {
        document.getElementById('readerView').style.display = 'none';
        iframe.style.display = '';
        iframe.src = url;
      }
    }

    // Event wiring
    document.getElementById('openBtn').addEventListener('click', openFile);
    document.getElementById('saveBtn').addEventListener('click', ()=>saveFile({ silent:false }));
    document.getElementById('saveAsBtn').addEventListener('click', saveFileAs);
    // Theme toggle (floating FAB - moon/sun)
    (function(){
      const btn = document.getElementById('themeFab');
      if (!btn) return;
      const root = document.documentElement;
      const key = 'doha_theme';
      const sun = document.getElementById('themeIconSun');
      const moon = document.getElementById('themeIconMoon');
      function reflect(theme){
        const isDark = theme === 'dark';
        btn.setAttribute('aria-pressed', String(isDark));
        if (sun && moon){ sun.style.display = isDark ? 'none' : ''; moon.style.display = isDark ? '' : 'none'; }
      }
      function applyTheme(theme){
        if (theme === 'dark') { root.setAttribute('data-theme','dark'); reflect('dark'); }
        else { root.removeAttribute('data-theme'); reflect('light'); }
      }
      const stored = localStorage.getItem(key);
      if (stored) applyTheme(stored);
      else {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
      }
      if (window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener && mq.addEventListener('change', (e)=>{
          const saved = localStorage.getItem(key);
          if (!saved) applyTheme(e.matches ? 'dark' : 'light');
        });
      }
      btn.addEventListener('click', ()=>{
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const next = isDark ? 'light' : 'dark';
        applyTheme(next);
        localStorage.setItem(key, next);
      });
    })();
    // Submit confirm wiring (CORS-free form POST)
    (function(){
      const btn=document.getElementById('submitConfirmBtn');
      const form=document.getElementById('submitForm');
      const sink=document.getElementById('submitSink');
      const tf=document.getElementById('submitToken');
      const rf=document.getElementById('submitRows');
      if (!btn || !form || !sink || !tf || !rf) return;
      const TOKEN = '';
      function buildSubmitRows(){
        const out=[];
        for (const it of items){
          if (deletedRows.has(it.rowIdx)) continue;
          const rm = String(it.remark||'').trim();
          const rmNoSpace = rm.replace(/\s+/g,'');
          // Ï†úÏô∏ ÎåÄÏÉÅ: ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å, Ïπ¥Ìéò Í∞ÄÏûÖÌïÑÏöî(ÎùÑÏñ¥Ïì∞Í∏∞ Ïú†Î¨¥ Î™®Îëê Ï≤òÎ¶¨)
          if (rm === 'ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å' || rmNoSpace === 'Ïπ¥ÌéòÍ∞ÄÏûÖÌïÑÏöî') continue;
          const g = String(it.gpt||'').trim();
          if (!g) continue;
          out.push([
            friendlyCafe(it.cafe, it.url),
            String(it.url||''),
            String(it.title||''),
            String(it.body||''),
            g,
          ]);
        }
        return out;
      }
      async function submitViaForm(){
        try {
          // üçé iOS Ìò∏Ìôò: Î®ºÏ†Ä ÎØ∏Ï†ÄÏû• Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï≤¥ÌÅ¨ (async Ìò∏Ï∂ú Ï†ÑÏóê)
          if (hasUnsavedChanges()){
            // iOS Safari: ÏÇ¨Ïö©Ïûê Ï†úÏä§Ï≤òÍ∞Ä ÎÅäÏñ¥ÏßÄÎ©¥ form.submit() Ï∞®Îã®Îê®
            // Ìï¥Í≤∞Ï±Ö: Ï†ÄÏû• ÏóÜÏù¥ Î∞îÎ°ú Ï†úÏ∂ú (Í≤ΩÍ≥† Î©îÏãúÏßÄ ÌëúÏãú)
            if (!confirm('‚ö†Ô∏è ÎØ∏Ï†ÄÏû• Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÏäµÎãàÎã§.\n\nÏ†ÄÏû•ÌïòÏßÄ ÏïäÍ≥† Ï†úÏ∂úÌïòÎ©¥ Ïù¥Ï†Ñ Ï†ÄÏû• ÏÉÅÌÉúÎ°ú Ï†úÏ∂úÎê©ÎãàÎã§.\n\nÍ∑∏ÎûòÎèÑ Ï†úÏ∂úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n(Í∂åÏû•: Ï∑®ÏÜå ‚Üí Ï†ÄÏû• Î≤ÑÌäº ÎàÑÎ•¥Í∏∞ ‚Üí Îã§Ïãú Ï†úÏ∂ú)')){
              return;
            }
          }
          
          btn.disabled = true;
          const origHtml = btn.innerHTML;
          btn.innerHTML = '<span class="spinner"></span>&nbsp;Ï†úÏ∂ú Ï§ë...';
          
          // 2) Build payload
          const rows = buildSubmitRows();
          if (!rows.length){ 
            showToast('Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥Ïöî'); 
            btn.disabled=false; 
            btn.innerHTML = origHtml;
            return; 
          }
          
          // 3) Submit via hidden form (CORS-free)
          // üçé ÏÇ¨Ïö©Ïûê Ï†úÏä§Ï≤ò ÎÇ¥ÏóêÏÑú Î∞îÎ°ú Ïã§Ìñâ (async ÏóÜÏù¥)
          tf.value = TOKEN;
          rf.value = JSON.stringify(rows);
          const onloadHandler = ()=>{ 
            showToast('Ï†úÏ∂úÏùÑ ÏöîÏ≤≠ÌñàÏñ¥Ïöî'); 
            btn.disabled=false; 
            btn.innerHTML = origHtml; 
            sink.removeEventListener('load', onloadHandler); 
          };
          sink.addEventListener('load', onloadHandler);
          
          // setTimeoutÏúºÎ°ú UI ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ï†úÏ∂ú (iOS Ìò∏ÌôòÏÑ± Ìñ•ÏÉÅ)
          setTimeout(()=>{ form.submit(); }, 50);
          
        } catch(e){ 
          console.error('Ï†úÏ∂ú Ïò§Î•ò:', e);
          btn.disabled=false; 
          try{ btn.innerHTML = origHtml; }catch(_){} 
          showToast('Ï†úÏ∂ú Ïã§Ìå®: ' + (e.message||'')); 
        }
      }
      btn.addEventListener('click', submitViaForm);
    })();
    // Î≥ÄÍ≤ΩÏùÄ ÏûÖÎ†• Î≥ÄÍ≤Ω Ïãú ÏûêÎèô Î∞òÏòÅ
    ['gptInput','titleInput','bodyInput','brandInput'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', applyChanges);
      el.addEventListener('change', applyChanges);
    });
    // TRUE/FALSE ÏÑ∏Í∑∏Î®ºÌä∏ ÌÅ¥Î¶≠
    (function(){
      const seg = document.getElementById('submitSeg');
      if (seg) {
        seg.addEventListener('click', (e)=>{
          const btn = e.target.closest && e.target.closest('.seg-btn');
          if (!btn) return;
          const val = btn.getAttribute('data-val') === 'true';
          setSubmitSeg(val);
          applyChanges();
        });
      }
    })();
    document.getElementById('searchInput').addEventListener('input', (e)=>{
      renderList(e.target.value||'');
    });
    // Clipboard helpers
    let _toastTimer=null;
    function showToast(msg){
      const t=document.getElementById('copyToast'); if(!t) return;
      t.textContent = msg || 'Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§';
      if (_toastTimer) { clearTimeout(_toastTimer); _toastTimer=null; }
      t.style.display='block';
      // force reflow to restart animation reliably across browsers
      void t.offsetWidth;
      t.classList.add('show');
      _toastTimer=setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>{ t.style.display='none'; }, 180); }, 1000);
    }
    async function copyText(text){
      try {
        await navigator.clipboard.writeText(text||'');
        showToast('ÌÅ¥Î¶ΩÎ≥¥ÎìúÎ°ú Î≥µÏÇ¨ÌñàÏñ¥Ïöî');
      } catch(e){
        const ta=document.createElement('textarea'); ta.value=text||''; document.body.appendChild(ta); let ok=false; try{ok=document.execCommand('copy');}catch(_){ok=false;} document.body.removeChild(ta);
        if (ok) showToast('ÌÅ¥Î¶ΩÎ≥¥ÎìúÎ°ú Î≥µÏÇ¨ÌñàÏñ¥Ïöî'); else showToast('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî');
      }
    }
    function buildAccountStats(){
      const accountData = {};
      for (const it of items){
        if (deletedRows.has(it.rowIdx)) continue;
        let account = String(it.confirm || it.myNick || '(Í≥ÑÏ†ï ÎØ∏ÏßÄÏ†ï)').trim();
        
        // (Í≥ÑÏ†ï ÎØ∏ÏßÄÏ†ï)ÏùÄ Ïπ¥ÌéòÎ™ÖÏù¥ ÏûàÍ≥† ÏûëÏóÖ ÏôÑÎ£åÏù∏ Í≤ÉÎßå Ïπ¥Ïö¥ÌåÖ
        if (account === '(Í≥ÑÏ†ï ÎØ∏ÏßÄÏ†ï)'){
          const hasCafe = String(it.cafe||'').trim().length > 0;
          const remarkTrim = String(it.remark||'').trim();
          const isCompleted = remarkTrim === 'ÏûëÏóÖ ÏôÑÎ£å' || remarkTrim === 'ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å';
          if (!hasCafe || !isCompleted) continue;
          account = 'Somun Í≥ÑÏ†ï'; // ÌëúÏãú Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
        }
        
        if (!accountData[account]){
          accountData[account] = { total: 0, completed: 0, remaining: 0, cafes: new Set() };
        }
        accountData[account].total++;
        const remarkTrim = String(it.remark||'').trim();
        if (remarkTrim === 'ÏûëÏóÖ ÏôÑÎ£å' || remarkTrim === 'ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å'){
          accountData[account].completed++;
        } else {
          accountData[account].remaining++;
        }
        const cafeUrl = extractCafeBaseUrl(it.url||'');
        if (cafeUrl) accountData[account].cafes.add(cafeUrl);
      }
      return accountData;
    }
    
    function buildCafeDistribution(){
      const cafeData = {};
      let total = 0;
      for (const it of items){
        if (deletedRows.has(it.rowIdx)) continue;
        const cafeUrl = extractCafeBaseUrl(it.url||'');
        if (!cafeUrl) continue;
        const cafeName = friendlyCafe(it.cafe, it.url);
        if (!cafeData[cafeUrl]){
          cafeData[cafeUrl] = { name: cafeName, count: 0 };
        }
        cafeData[cafeUrl].count++;
        total++;
      }
      return { cafeData, total };
    }
    
    function renderAccountStats(){
      const box = document.getElementById('accountStats');
      if (!box) return;
      const data = buildAccountStats();
      
      // Ï†ïÎ†¨: 'Somun Í≥ÑÏ†ï'ÏùÑ Îß® Îí§Î°ú, ÎÇòÎ®∏ÏßÄÎäî ÏïåÌååÎ≤≥ Ïàú
      const accounts = Object.keys(data).sort((a, b) => {
        if (a === 'Somun Í≥ÑÏ†ï') return 1;
        if (b === 'Somun Í≥ÑÏ†ï') return -1;
        return a.localeCompare(b);
      });
      
      if (!accounts.length){
        box.innerHTML = '<div class="hint" style="padding:8px; color:#9ca3af; font-size:12px;">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
        return;
      }
      let html = '';
      for (const account of accounts){
        const info = data[account];
        html += `<div style="padding:8px 0; border-bottom:1px solid #f3f4f6;">`;
        html += `<div style="font-weight:700; font-size:12px; color:#374151; margin-bottom:4px;">${escapeHtml(account)}</div>`;
        html += `<div style="display:flex; gap:12px; font-size:11px; color:#6b7280;">`;
        html += `<span>ÏûëÏóÖ: ${info.total}Í±¥</span>`;
        html += `<span>ÏôÑÎ£å: ${info.completed}Í±¥</span>`;
        html += `<span>ÎÇ®Ïùå: ${info.remaining}Í±¥</span>`;
        html += `<span>Ïπ¥Ìéò: ${info.cafes.size}Í≥≥</span>`;
        html += `</div>`;
        html += `</div>`;
      }
      box.innerHTML = html;
    }
    
    function renderCafeDistribution(){
      const box = document.getElementById('cafeDistribution');
      if (!box) return;
      const { cafeData, total } = buildCafeDistribution();
      const cafes = Object.entries(cafeData).sort((a,b)=> b[1].count - a[1].count).slice(0, 10);
      if (!cafes.length){
        box.innerHTML = '<div class="hint" style="padding:8px; color:#9ca3af; font-size:12px;">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
        return;
      }
      let html = '';
      for (const [cafeUrl, info] of cafes){
        const percent = total > 0 ? Math.round((info.count / total) * 100) : 0;
        const barWidth = percent;
        html += `<div style="margin-bottom:12px;">`;
        html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">`;
        html += `<a href="${escapeHtml(cafeUrl)}" target="_blank" rel="noopener" style="font-size:11px; font-weight:600; color:#374151; text-decoration:none; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(cafeUrl)}">${escapeHtml(info.name)}</a>`;
        html += `<span style="font-size:11px; color:#6b7280; margin-left:8px;">${info.count}Í±¥ (${percent}%)</span>`;
        html += `</div>`;
        html += `<div style="background:#f3f4f6; border-radius:4px; height:6px; overflow:hidden;">`;
        html += `<div style="background:#8b5cf6; height:100%; width:${barWidth}%; transition:width .3s;"></div>`;
        html += `</div>`;
        html += `</div>`;
      }
      if (Object.keys(cafeData).length > 10){
        html += `<div class="hint" style="padding:4px; font-size:11px; color:#9ca3af;">(ÏÉÅÏúÑ 10Í∞ú Ïπ¥ÌéòÎßå ÌëúÏãú)</div>`;
      }
      box.innerHTML = html;
    }
    
    function bindToolbox(){
      renderAccountStats();
      renderCafeDistribution();
      const it = (activeIndex>=0 ? items[activeIndex] : null);
      const url = it ? (it.url||'') : '';
      const a = document.getElementById('openNewTab'); if (a) a.href = url || '#';
    }
    // Initial bind (will be replaced on row select)
    bindCafeInput(); bindBrandInput(); bindMyNickInput();
    document.getElementById('fileInput').addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      
      // Î™®Î∞îÏùº: ÌååÏùºÎ™Ö Ï†ÄÏû• & ÌëúÏãú
      openedFilename = f.name; 
      document.getElementById('fileLabel').textContent = f.name;
      
      // Î™®Î∞îÏùºÏóêÏÑúÎäî fileHandle ÏóÜÏùå (ÎçÆÏñ¥Ïì∞Í∏∞ Î∂àÍ∞Ä)
      fileHandle = null;
      
      // Î≤ÑÌäº ÌôúÏÑ±Ìôî
      const urlBtn=document.getElementById('urlManagerBtn'); if (urlBtn) urlBtn.disabled=false;
      const applyBtn=document.getElementById('applyConfirmBtn'); if (applyBtn) applyBtn.disabled=false;
      const subBtn=document.getElementById('submitConfirmBtn'); if (subBtn) subBtn.disabled=false;
      const asBtn=document.getElementById('autoSaveBtn'); if (asBtn) asBtn.disabled=false;
      
      const buf = await f.arrayBuffer();
      try { await ensureXLSX(); } catch(e){
        console.error(e);
        alert('ÌååÏùº Ïó¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (XLSX Î°úÎìú)\n'+(e&&e.message?e.message:''));
        return;
      }
      
      // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      modified = new Map();
      deletedRows = new Set();
      selectedRows = new Set();
      undoStack.length = 0;
      
      loadWorkbook(buf);
      
      // Î™®Î∞îÏùº ÏïàÎÇ¥ (Ï≤òÏùå Ïó¥ ÎïåÎßå)
      if (isIOS && !localStorage.getItem('mobile_save_guide_shown')) {
        setTimeout(() => {
          alert('üì± Î™®Î∞îÏùº ÏïàÎÇ¥\n\nÏ†ÄÏû• Ïãú ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÍ∞Ä Ìè¨Ìï®Îêú ÏÉà ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìú Ìè¥ÎçîÏóê Ï†ÄÏû•Îê©ÎãàÎã§.\n\nüí° Îã§Ïö¥Î°úÎìúÎêú ÌååÏùºÏùÑ Îã§Ïãú ÏóÖÎ°úÎìúÌïòÏó¨ Í≥ÑÏÜç ÏûëÏóÖÌïòÍ±∞ÎÇò, ÌååÏùº Ïï±ÏóêÏÑú ÏõêÌïòÎäî ÏúÑÏπòÎ°ú Ïù¥ÎèôÌïòÏÑ∏Ïöî.');
          localStorage.setItem('mobile_save_guide_shown', 'true');
        }, 500);
      }
    });
    // sidebar toolbar icons removed
    
    // Drag & Drop open on left empty area (or entire left pane)
    ;(function(){
      const zone = document.getElementById('leftPane');
      if (!zone) return;
      const onEnterOver = (e)=>{ e.preventDefault(); e.stopPropagation(); if (!workbook) zone.classList.add('drop-active'); };
      const onLeave = (e)=>{ e.preventDefault(); e.stopPropagation(); zone.classList.remove('drop-active'); };
      const onDrop = async (e)=>{
        e.preventDefault(); e.stopPropagation(); zone.classList.remove('drop-active');
        const files = e.dataTransfer && e.dataTransfer.files; if (!files || !files.length) return;
        const file = files[0];
        const name = (file && file.name || '').toLowerCase();
        if (!name.endsWith('.xlsx') && !name.endsWith('.xls')) { showToast('ÏóëÏÖÄ ÌååÏùº(.xlsx/.xls)Îßå Ïó¥ Ïàò ÏûàÏñ¥Ïöî'); return; }
        // Try to capture a writable handle from DataTransferItem (Chrome/Edge)
        let handle = null;
        try {
          const dti = e.dataTransfer && e.dataTransfer.items && e.dataTransfer.items[0];
          if (dti && typeof dti.getAsFileSystemHandle === 'function') {
            const h = await dti.getAsFileSystemHandle();
            if (h && h.kind === 'file') handle = h;
          }
        } catch(_) {}
        if (hasUnsavedChanges()) { pendingDroppedFile = file; pendingDroppedHandle = handle; openUnsavedModal(); return; }
        await openFromFile(file, handle);
      };
      ['dragenter','dragover'].forEach(ev=>zone.addEventListener(ev, onEnterOver));
      ;['dragleave','dragend'].forEach(ev=>zone.addEventListener(ev, onLeave));
      zone.addEventListener('drop', onDrop);
    })();

    function softDeleteRow(rowIdx) {
      if (!rowIdx) return;
      if (!deletedRows.has(rowIdx)) {
        deletedRows.add(rowIdx);
        undoStack.push({ type: 'delete', rows: [rowIdx] });
        if (activeIndex >= 0 && items[activeIndex] && items[activeIndex].rowIdx === rowIdx) {
          selectIndex(-1);
        }
        renderList(document.getElementById('searchInput').value || '');
        updateTargetCount();
      }
    }

    function deleteActive() {
      if (activeIndex < 0) return;
      const it = items[activeIndex];
      if (!it) return;
      softDeleteRow(it.rowIdx);
    }
    
    function undoLast() {
      const op = undoStack.pop();
      if (!op) return;
      if (op.type === 'delete') {
        op.rows.forEach(r => deletedRows.delete(r));
        renderList(document.getElementById('searchInput').value || '');
        updateTargetCount();
      }
    }

    function undoDeleteRow(rowIdx){
      if (deletedRows.has(rowIdx)) {
        deletedRows.delete(rowIdx);
        renderList(document.getElementById('searchInput').value || '');
      }
    }

    function updateTargetCount() {
      try {
        const numEl = document.getElementById('targetCountNum');
        const totalEl = document.getElementById('totalCountNum');
        const changedEl = document.getElementById('changedCountNum');
        // TRUE and not remark==ÏûëÏóÖ ÏôÑÎ£å nor ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å
        let cnt = 0;
        let total = 0;
        let changed = 0;
        for (const it of items) {
          const rm = String(it.remark||'').trim();
          const gptHas = String(it.gpt||'').trim().length > 0;
          if (gptHas && !deletedRows.has(it.rowIdx)) total++;
          if (it.submit && rm !== 'ÏûëÏóÖ ÏôÑÎ£å' && rm !== 'ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å' && rm.replace(/\s+/g,'') !== 'Ïπ¥ÌéòÍ∞ÄÏûÖÌïÑÏöî') cnt++;
          if (modified.has(it.rowIdx)) changed++;
        }
        if (numEl) numEl.textContent = String(cnt);
        if (totalEl) totalEl.textContent = String(total);
        if (changedEl) changedEl.textContent = String(changed);
      } catch(e) {}
    }

    // Global save shortcut (Cmd/Ctrl+S)
    window.addEventListener('keydown', (e)=>{
      const isSave = (e.key && e.key.toLowerCase() === 's') && (e.metaKey || e.ctrlKey);
      if (isSave) {
        e.preventDefault();
        saveFile({ silent:false });
      }
    });

    // Safer auto-save: only when fileHandle is writable and permission granted
    async function canAutoSave(){
      try {
        if (!fileHandle || !fileHandle.queryPermission) return false;
        const perm = await fileHandle.queryPermission({ mode: 'readwrite' });
        if (perm === 'granted') return true;
        // do not prompt automatically to avoid popup; just skip
        return false;
      } catch(_) { return false; }
    }

    async function ensureWritableHandleForAutoSave(){
      try {
        if (!fileHandle) return false;
        if (fileHandle.requestPermission) {
          const res = await fileHandle.requestPermission({ mode: 'readwrite' });
          return res === 'granted';
        }
        return false;
      } catch(_) { return false; }
    }

    // Auto Save Toggle
    (function(){
      const btn = document.getElementById('autoSaveBtn');
      if (!btn) return;
      const setPressed = (on)=>{ btn.setAttribute('aria-pressed', String(!!on)); };
      const stop = ()=>{ if (autoSaveTimer){ clearInterval(autoSaveTimer); autoSaveTimer=null; } };
      const start = ()=>{
        stop();
        autoSaveTimer = setInterval(async ()=>{
          try {
            if (!workbook || !ws) return;
            if (!hasUnsavedChanges()) return;
            if (!(await canAutoSave())) return; // skip quietly if cannot write
            await saveFile({ silent:true, auto:true });
          } catch(_) {}
        }, 60*1000);
      };
      btn.addEventListener('click', async ()=>{
        const on = btn.getAttribute('aria-pressed') === 'true';
        if (on){ setPressed(false); stop(); showToast('ÏûêÎèô Ï†ÄÏû• Í∫ºÏßê'); }
        else {
          let ok = await canAutoSave();
          if (!ok) ok = await ensureWritableHandleForAutoSave();
          if (!ok) {
            showToast('ÏûêÎèô Ï†ÄÏû• Í∂åÌïúÏù¥ ÏóÜÏñ¥Ïöî (ÌååÏùº Ïó¥Í∏∞ ÏÇ¨Ïö©)');
            // Í∂åÌïú ÏóÜÏñ¥ÎèÑ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏõêÌïòÎ©¥ ÌÜ†Í∏Ä On Ïú†ÏßÄÌïòÎêò, Ï°∞Í±¥ Î∂ÄÌï© ÏãúÏóêÎßå Ïã§Ìñâ
          }
          setPressed(true); start(); showToast('ÏûêÎèô Ï†ÄÏû• ÏºúÏßê (1Î∂Ñ)');
        }
      });
      window.addEventListener('beforeunload', ()=>{ stop(); });
    })();

    // URL Manager Modal logic
    let currentUrlTab = 'list'; // 'list' or 'account'
    
    function getFilteredUrls(submitFilter, excludeDone, requireGpt) {
      // submitFilter: 'all' | 'true' | 'false'
      const out=[]; const doneSet=new Set(['ÏûëÏóÖ ÏôÑÎ£å','ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å']);
      for (const it of items) {
        if (deletedRows.has(it.rowIdx)) continue;
        // Ï†úÏ∂ú ÏÉÅÌÉú ÌïÑÌÑ∞
        if (submitFilter === 'true' && !it.submit) continue;
        if (submitFilter === 'false' && it.submit) continue;
        // submitFilter === 'all'Ïù¥Î©¥ Î™®Îëê Ìè¨Ìï®
        if (excludeDone && doneSet.has(String(it.remark||'').trim())) continue;
        if (requireGpt && !String(it.gpt||'').trim()) continue;
        const u = String(it.url||'').trim(); if (u) out.push(u);
      }
      return out;
    }
    
    function extractCafeBaseUrl(url){
      try {
        const s = String(url||'').trim();
        if (!s) return '';
        // https://cafe.naver.com/mom79/1413536 ‚Üí https://cafe.naver.com/mom79
        const m = s.match(/^(https?:\/\/[^\/]+\/[^\/]+)/i);
        return m ? m[1] : s;
      } catch(_){ return String(url||''); }
    }
    
    function buildAccountCafeData(){
      // { account: { cafeUrl: {count, cafeName} } }
      const data = {};
      for (const it of items){
        if (deletedRows.has(it.rowIdx)) continue;
        let account = String(it.confirm || it.myNick || '(Í≥ÑÏ†ï ÎØ∏ÏßÄÏ†ï)').trim();
        if (account === '(Í≥ÑÏ†ï ÎØ∏ÏßÄÏ†ï)') account = 'Somun Í≥ÑÏ†ï'; // ÌëúÏãú Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
        const url = String(it.url||'').trim();
        if (!url) continue;
        const cafeUrl = extractCafeBaseUrl(url);
        if (!cafeUrl) continue;
        const cafeName = friendlyCafe(it.cafe, it.url); // Ïπ¥ÌéòÎ™Ö Ï∂îÏ∂ú
        if (!data[account]) data[account] = {};
        if (!data[account][cafeUrl]) {
          data[account][cafeUrl] = { count: 0, cafeName: cafeName };
        }
        data[account][cafeUrl].count += 1;
      }
      return data;
    }
    
    function renderDeletePendingView(){
      const box = document.getElementById('deletePendingBox');
      const cntNum = document.getElementById('deletePendingCountNum');
      if (!box) return;
      
      const deletedUrls = [];
      for (const it of items){
        if (deletedRows.has(it.rowIdx)){
          const url = String(it.url||'').trim();
          if (url) deletedUrls.push(url);
        }
      }
      
      if (cntNum) cntNum.textContent = String(deletedUrls.length);
      
      if (deletedUrls.length === 0){
        box.innerHTML = '<div class="hint" style="text-align:center; padding:20px; color:#ef4444;">ÏÇ≠Ï†ú ÎåÄÍ∏∞ Ï§ëÏù∏ Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§</div>';
        return;
      }
      
      // URL Î™©Î°ù ÌëúÏãú (Í∞Å Ï§ÑÏóê ÌïòÎÇòÏî©)
      box.textContent = deletedUrls.join('\n');
    }
    
    function renderAccountCafeView(){
      const box = document.getElementById('accountCafeBox');
      if (!box) return;
      const data = buildAccountCafeData();
      
      // Ï†ïÎ†¨: 'Somun Í≥ÑÏ†ï'ÏùÑ Îß® Îí§Î°ú, ÎÇòÎ®∏ÏßÄÎäî ÏïåÌååÎ≤≥ Ïàú
      const accounts = Object.keys(data).sort((a, b) => {
        if (a === 'Somun Í≥ÑÏ†ï') return 1;
        if (b === 'Somun Í≥ÑÏ†ï') return -1;
        return a.localeCompare(b);
      });
      if (!accounts.length){
        box.innerHTML = '<div class="hint" style="text-align:center; padding:20px; color:#6b7280;">Í≥ÑÏ†ïÎ≥Ñ Ïπ¥Ìéò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
        return;
      }
      let html = '';
      for (const account of accounts){
        const cafes = data[account];
        const cafeEntries = Object.entries(cafes).sort((a,b)=> b[1].count - a[1].count); // Í±¥Ïàò ÎßéÏùÄ Ïàú
        html += `<div class="account-section">`;
        html += `<div class="account-header">üìå Í≥ÑÏ†ï: ${escapeHtml(account)}</div>`;
        for (const [cafeUrl, info] of cafeEntries){
          const warnClass = info.count >= 5 ? ' warn' : '';
          html += `<a href="${escapeHtml(cafeUrl)}" target="_blank" rel="noopener" class="cafe-link">`;
          html += `<div style="display:flex; align-items:center; gap:8px;">`;
          html += `<span style="font-weight:700; color:#374151;">${escapeHtml(info.cafeName)}</span>`;
          html += `<span class="cafe-url">${escapeHtml(cafeUrl)}</span>`;
          html += `</div>`;
          html += `<span class="cafe-count${warnClass}">${info.count}Í±¥</span>`;
          html += `</a>`;
        }
        html += `</div>`;
      }
      box.innerHTML = html;
    }
    
    function switchUrlTab(tab){
      currentUrlTab = tab;
      const listTab = document.getElementById('urlListTab');
      const accountTab = document.getElementById('accountCafeTab');
      const deleteTab = document.getElementById('deletePendingTab');
      const listView = document.getElementById('urlListView');
      const accountView = document.getElementById('accountCafeView');
      const deleteView = document.getElementById('deletePendingView');
      const copyBtn = document.getElementById('copyUrlListBtn');
      
      // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
      if (listTab) listTab.classList.remove('active');
      if (accountTab) accountTab.classList.remove('active');
      if (deleteTab) deleteTab.classList.remove('active');
      
      // Î™®Îì† Î∑∞ Ïà®ÍπÄ
      if (listView) listView.style.display = 'none';
      if (accountView) accountView.style.display = 'none';
      if (deleteView) deleteView.style.display = 'none';
      
      if (tab === 'list'){
        if (listTab) listTab.classList.add('active');
        if (listView) listView.style.display = '';
        if (copyBtn) copyBtn.style.display = ''; // Î≥µÏÇ¨ Î≤ÑÌäº ÌëúÏãú
        refreshUrlModal();
      } else if (tab === 'account') {
        if (accountTab) accountTab.classList.add('active');
        if (accountView) accountView.style.display = '';
        if (copyBtn) copyBtn.style.display = ''; // Î≥µÏÇ¨ Î≤ÑÌäº ÌëúÏãú
        renderAccountCafeView();
      } else if (tab === 'delete') {
        if (deleteTab) deleteTab.classList.add('active');
        if (deleteView) deleteView.style.display = '';
        if (copyBtn) copyBtn.style.display = ''; // Î≥µÏÇ¨ Î≤ÑÌäº ÌëúÏãú
        renderDeletePendingView();
      }
    }
    
    function openUrlModal(){
      const ov=document.getElementById('urlModal'); if (!ov) return;
      ov.classList.add('show');
      switchUrlTab('list'); // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú URL Ï†ïÎ¶¨ ÌÉ≠ ÌëúÏãú
    }
    function closeUrlModal(){ const ov=document.getElementById('urlModal'); if (ov) ov.classList.remove('show'); }
    function refreshUrlModal(){
      // Ï†úÏ∂ú ÏÉÅÌÉú ÌïÑÌÑ∞ Í≤∞Ï†ï
      let submitFilter = 'all';
      if (document.getElementById('ufTrue')?.classList.contains('active')) submitFilter = 'true';
      else if (document.getElementById('ufFalse')?.classList.contains('active')) submitFilter = 'false';
      else if (document.getElementById('ufAll')?.classList.contains('active')) submitFilter = 'all';
      
      const excludeOn = document.getElementById('exChip')?.classList.contains('active');
      const hasGptOn = document.getElementById('hasGptChip')?.classList.contains('active');
      const urls = getFilteredUrls(submitFilter, excludeOn, hasGptOn);
      const box = document.getElementById('urlListBox'); const cntNum=document.getElementById('urlCountNum');
      if (cntNum) cntNum.textContent = String(urls.length);
      if (box) box.textContent = urls.join('\n');
    }
    (function(){
      const b=document.getElementById('urlManagerBtn'); if (b) b.addEventListener('click', openUrlModal);
      const c2=document.getElementById('urlModalClose2'); if (c2) c2.addEventListener('click', closeUrlModal);
      const listTab = document.getElementById('urlListTab');
      const accountTab = document.getElementById('accountCafeTab');
      const deleteTab = document.getElementById('deletePendingTab');
      if (listTab) listTab.addEventListener('click', ()=> switchUrlTab('list'));
      if (accountTab) accountTab.addEventListener('click', ()=> switchUrlTab('account'));
      if (deleteTab) deleteTab.addEventListener('click', ()=> switchUrlTab('delete'));
      
      const ufAll=document.getElementById('ufAll');
      const ufTrue=document.getElementById('ufTrue'); 
      const ufFalse=document.getElementById('ufFalse');
      if (ufAll) ufAll.addEventListener('click', ()=>{ 
        ufAll.classList.add('active'); 
        if (ufTrue) ufTrue.classList.remove('active'); 
        if (ufFalse) ufFalse.classList.remove('active'); 
        refreshUrlModal(); 
      });
      if (ufTrue) ufTrue.addEventListener('click', ()=>{ 
        ufTrue.classList.add('active'); 
        if (ufAll) ufAll.classList.remove('active'); 
        if (ufFalse) ufFalse.classList.remove('active'); 
        refreshUrlModal(); 
      });
      if (ufFalse) ufFalse.addEventListener('click', ()=>{ 
        ufFalse.classList.add('active'); 
        if (ufAll) ufAll.classList.remove('active'); 
        if (ufTrue) ufTrue.classList.remove('active'); 
        refreshUrlModal(); 
      });
      const exChip=document.getElementById('exChip'); if (exChip) exChip.addEventListener('click', ()=>{ exChip.classList.toggle('active'); refreshUrlModal(); });
      const gChip=document.getElementById('hasGptChip'); if (gChip) gChip.addEventListener('click', ()=>{ gChip.classList.toggle('active'); refreshUrlModal(); });
      const copyBtn=document.getElementById('copyUrlListBtn');
      if (copyBtn) copyBtn.addEventListener('click', ()=>{
        if (currentUrlTab === 'delete'){
          // ÏÇ≠Ï†ú ÎåÄÍ∏∞ URL Î≥µÏÇ¨ (Íµ¨Í∏Ä ÏãúÌä∏ Ï†ïÍ∑úÏãùÏö©: url1|url2|url3)
          const deletedUrls = [];
          for (const it of items){
            if (deletedRows.has(it.rowIdx)){
              const url = String(it.url||'').trim();
              if (url) deletedUrls.push(url);
            }
          }
          if (!deletedUrls.length){ showToast('ÏÇ≠Ï†ú ÎåÄÍ∏∞ Ï§ëÏù∏ URLÏù¥ ÏóÜÏäµÎãàÎã§'); return; }
          
          const searchQuery = deletedUrls.join('|');
          copyText(searchQuery);
          showToast(`${deletedUrls.length}Í±¥ Íµ¨Í∏ÄÏãúÌä∏ Í≤ÄÏÉâÏö© Î≥µÏÇ¨ ÏôÑÎ£å`);
        } else if (currentUrlTab === 'account'){
          // Í≥ÑÏ†ïÎ≥Ñ Ïπ¥Ìéò Î≥µÏÇ¨
          const data = buildAccountCafeData();
          const accounts = Object.keys(data).sort();
          let text = '';
          for (const account of accounts){
            text += `üìå Í≥ÑÏ†ï: ${account}\n`;
            const cafes = data[account];
            const cafeEntries = Object.entries(cafes).sort((a,b)=> b[1].count - a[1].count);
            for (const [cafeUrl, info] of cafeEntries){
              text += `  ${info.cafeName} - ${cafeUrl} (${info.count}Í±¥)\n`;
            }
            text += '\n';
          }
          if (!text.trim()){ showToast('Î≥µÏÇ¨Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§'); return; }
          copyText(text);
          showToast('Í≥ÑÏ†ïÎ≥Ñ Ïπ¥Ìéò Î™©Î°ù Î≥µÏÇ¨ ÏôÑÎ£å');
        } else {
          // URL Î™©Î°ù Î≥µÏÇ¨
          let submitFilter = 'all';
          if (document.getElementById('ufTrue')?.classList.contains('active')) submitFilter = 'true';
          else if (document.getElementById('ufFalse')?.classList.contains('active')) submitFilter = 'false';
          else if (document.getElementById('ufAll')?.classList.contains('active')) submitFilter = 'all';
          
          const excludeOn = document.getElementById('exChip')?.classList.contains('active');
          const hasGptOn = document.getElementById('hasGptChip')?.classList.contains('active');
          const urls = getFilteredUrls(submitFilter, excludeOn, hasGptOn);
          if (!urls.length){ showToast('Î≥µÏÇ¨Ìï† URLÏù¥ ÏóÜÏäµÎãàÎã§'); return; }
          copyText(urls.join('\n'));
          showToast(`${urls.length}Í±¥ Î≥µÏÇ¨ÌñàÏñ¥Ïöî`);
        }
      });
      // Overlay click close
      const ov=document.getElementById('urlModal');
      if (ov) ov.addEventListener('click', (e)=>{ if (e.target===ov) closeUrlModal(); });
      // Esc close
      window.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ closeUrlModal(); }});
      // Unsaved modal wiring
      const um=document.getElementById('unsavedModal');
      const sBtn=document.getElementById('unsavedSaveBtn');
      const saBtn=document.getElementById('unsavedSaveAsBtn');
      const cBtn=document.getElementById('unsavedCancelBtn');
      if (sBtn) sBtn.addEventListener('click', async ()=>{ await saveFile(); if (!hasUnsavedChanges()){ closeUnsavedModal(); if (pendingDroppedFile){ const f=pendingDroppedFile; const h=pendingDroppedHandle; pendingDroppedFile=null; pendingDroppedHandle=null; await openFromFile(f, h); } else { await startFileOpen(); } } });
      if (saBtn) saBtn.addEventListener('click', async ()=>{ await saveFileAs(); if (!hasUnsavedChanges()){ closeUnsavedModal(); if (pendingDroppedFile){ const f=pendingDroppedFile; const h=pendingDroppedHandle; pendingDroppedFile=null; pendingDroppedHandle=null; await openFromFile(f, h); } else { await startFileOpen(); } } });
      if (cBtn) cBtn.addEventListener('click', ()=>{ closeUnsavedModal(); });
      if (um) um.addEventListener('click', (e)=>{ if (e.target===um) closeUnsavedModal(); });
    })();

    function hideAllActionPanels(){
      ['spellPanel','reviewPanel','kwPanel'].forEach(id=>{ const el=document.getElementById(id); if (el){ el.style.display='none'; }});
    }
    function showOnlyPanel(id){ hideAllActionPanels(); const el=document.getElementById(id); if (el){ el.style.display='block'; }}

    // LanguageTool spellcheck integration with robust parsing/fallback
    async function spellCheck(){
      const ta=document.getElementById('gptInput'); const panel=document.getElementById('spellPanel'); const btn=document.getElementById('spellCheckBtn');
      if (!ta || !panel) return;
      const text = String(ta.value||'');
      if (!text.trim()) { showOnlyPanel('spellPanel'); panel.innerHTML = '<div class="hint">Í≤ÄÏÇ¨Ìï† ÎÇ¥Ïö©Ïù¥ ÏóÜÏñ¥Ïöî</div>'; return; }
      if (btn) { btn.disabled = true; }
      showOnlyPanel('spellPanel'); panel.innerHTML = '<div class="hint">Í≤ÄÏÇ¨ Ï§ë...</div>';
      const hasKorean = /[\u3131-\u318E\uAC00-\uD7A3]/.test(text);
      // If Korean detected, use PNU directly to avoid LT errors/rate limits
      if (hasKorean) {
        try { if (_spellAbort) { _spellAbort.abort(); } } catch(_) {}
        _spellAbort = null;
        const matches = buildHeuristicMatches(text);
        if (btn) { btn.disabled = false; }
        if (matches && matches.length){ _spellState.textSnapshot = text; _spellState.matches = matches; renderSpellPanel(); }
        else { showOnlyPanel('spellPanel'); panel.innerHTML = '<div class="hint">Ïò§Î•òÍ∞Ä Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏñ¥Ïöî.</div>'; }
        return;
      }
      // Non-Korean: try LanguageTool (English/etc.)
      const endpoints = ['https://api.languagetool.org/v2/check','https://languagetool.org/api/v2/check'];
      const lang = 'en-US';
      let matches = null; let lastErrorText = '';
      try { if (_spellAbort) { _spellAbort.abort(); } } catch(_) {}
      _spellAbort = (typeof AbortController!=='undefined' ? new AbortController() : null);
      try {
        for (const url of endpoints){
          try {
            const params = new URLSearchParams(); params.set('text', text); params.set('language', lang);
            const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded', 'Accept':'application/json' }, body: params.toString(), signal: _spellAbort ? _spellAbort.signal : undefined });
            if (!res.ok){ lastErrorText = await res.text().catch(()=>String(res.status)); continue; }
            let data = null;
            try { data = await res.json(); }
            catch(_){ const t = await res.text(); try { data = JSON.parse(t); } catch(e){ lastErrorText = t; data=null; } }
            if (data && Array.isArray(data.matches)) { matches = data.matches; break; }
          } catch(e){ if (e && e.name==='AbortError') { return; } lastErrorText = (e && e.message)||'unknown error'; }
        }
      } finally {
        if (btn) { btn.disabled = false; }
      }
      if (!matches || !matches.length){
        showOnlyPanel('spellPanel');
        panel.innerHTML = `<div class=\"hint\" style=\"color:#ef4444;\">Í≤ÄÏÇ¨Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî${lastErrorText?`: ${escapeHtml(String(lastErrorText)).slice(0,140)}`:''}</div>`;
        return;
      }
      _spellState.textSnapshot = text; _spellState.matches = matches; renderSpellPanel();
    }

    function renderSpellPanel(){
      const panel=document.getElementById('spellPanel'); if (!panel) return;
      const matches = _spellState.matches||[]; const text=_spellState.textSnapshot||'';
      if (!matches.length){ showOnlyPanel('spellPanel'); panel.innerHTML = '<div class="hint">Ïò§Î•òÍ∞Ä Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏñ¥Ïöî.</div>'; return; }
      const frag = document.createDocumentFragment();
      const top = document.createElement('div'); top.className='hint'; top.textContent = `Î∞úÍ≤¨Îêú Ï†úÏïà: ${matches.length}Í±¥`; frag.appendChild(top);
      matches.forEach((m, idx)=>{
        const off = Math.max(0, m.offset|0); const len = Math.max(0, m.length|0);
        const found = text.slice(off, off+len) || m.found || '';
        const repl = (m.replacements && m.replacements[0] && m.replacements[0].value) || m.repl || '';
        const wrap = document.createElement('div'); wrap.className='spell-item';
        const left = document.createElement('div');
        const msg = document.createElement('div'); msg.className='spell-msg'; msg.textContent = m.message || 'Ï†úÏïà';
        const ctx = document.createElement('div'); ctx.className='spell-context'; const suffix = repl ? ' ‚Üí Ï†úÏïà: ' + repl : ''; ctx.textContent = 'Î¨∏Íµ¨: ' + found + suffix;
        left.appendChild(msg); left.appendChild(ctx);
        const right = document.createElement('div');
        const btn = document.createElement('button'); btn.className='spell-apply'; btn.textContent = repl? 'Ï†ÅÏö©' : 'Î¨¥Ïãú';
        btn.addEventListener('click', ()=>applySpellSuggestion(idx));
        right.appendChild(btn);
        wrap.appendChild(left); wrap.appendChild(right);
        frag.appendChild(wrap);
      });
      panel.style.display=''; panel.innerHTML=''; panel.appendChild(frag);
    }

    async function applySpellSuggestion(index){
      try {
        const m = (_spellState.matches||[])[index]; if (!m) return;
        const ta=document.getElementById('gptInput'); if (!ta) return;
        const current = String(ta.value||'');
        if (current !== _spellState.textSnapshot){ showToast('ÎÇ¥Ïö©Ïù¥ Î≥ÄÍ≤ΩÎêòÏñ¥ Îã§Ïãú Í≤ÄÏÇ¨Ìï¥ Ï£ºÏÑ∏Ïöî'); return; }
        const repl = (m.replacements && m.replacements[0] && m.replacements[0].value) || m.repl || '';
        if (!repl){ _spellState.matches.splice(index,1); renderSpellPanel(); return; }
        let off = (typeof m.offset==='number') ? m.offset : -1;
        let len = (typeof m.length==='number') ? m.length : -1;
        if (off<0 || len<0){
          const needle = m.found || '';
          off = needle ? current.indexOf(needle) : -1;
          len = (off>=0) ? needle.length : 0;
        }
        if (off<0){ showToast('ÏúÑÏπòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏñ¥Ïöî'); return; }
        const next = current.slice(0, off) + repl + current.slice(off+len);
        ta.value = next; applyChanges(); showToast('ÏàòÏ†ï Ï†ÅÏö©'); await spellCheck();
      } catch(e){ console.error(e); showToast('Ï†ÅÏö© Ï§ë Ïò§Î•ò'); }
    }

    // Fallback: PNU Korean Speller via proxy (chunked to avoid 422)
    async function fetchPNUSpellerMatches(text){
      try {
        const clean = String(text||'');
        const maxLen = 170; // safe margin
        const chunks = [];
        let i=0; const n=clean.length;
        function isBoundary(ch){ return ch==='.'||ch==='!'||ch==='?'||ch==='~'||ch==='\n'; }
        while (i<n){
          let end = Math.min(n, i+maxLen);
          let cut = end;
          for (let j=end-1; j>i; j--){ if (isBoundary(clean[j])){ cut=j+1; break; } }
          if (cut===i) cut = end;
          const part = clean.slice(i, cut);
          if (part.trim()) chunks.push({ start:i, text: part });
          i = cut;
        }
        const out = [];
        for (const ch of chunks){
          const url = 'https://r.jina.ai/https://speller.cs.pusan.ac.kr/results?text=' + encodeURIComponent(ch.text);
          let res, html;
          try { res = await fetch(url, { cache:'no-store' }); if (!res.ok) continue; html = await res.text(); } catch(_){ continue; }
          const m = html.match(/var\s+data\s*=\s*(\[.*?\]);/s); if (!m) continue;
          let data=[]; try { data = JSON.parse(m[1]); } catch(_){ continue; }
          for (const block of data){
            const errata = block && (block.errata || block.errInfo || block.errors || []);
            if (!Array.isArray(errata)) continue;
            for (const err of errata){
              const found = String(err.orgStr||err.error||'');
              const cand = String(err.candWord||err.candidates||'');
              const repl = (cand.split('|')[0]||'').trim();
              const start = (typeof err.start==='number') ? err.start : (typeof err.startPos==='number'? err.startPos : -1);
              const end = (typeof err.end==='number') ? err.end : (typeof err.endPos==='number'? err.endPos : -1);
              const relOffset = (start>=0) ? start : (found ? ch.text.indexOf(found) : -1);
              const globalOffset = (relOffset>=0 ? ch.start + relOffset : -1);
              const len = (relOffset>=0 && end>=0 && start>=0) ? (end - start) : (found ? found.length : undefined);
              const msg = String(err.help||err.helpMessage||'ÎßûÏ∂§Î≤ï Ï†úÏïà');
              out.push({ offset: (globalOffset>=0?globalOffset:undefined), length: (typeof len==='number'?len:undefined), found, repl, message: msg, replacements: repl? [{value:repl}] : [] });
            }
          }
        }
        return out;
      } catch(e){ return []; }
    }

    const scb=document.getElementById('spellCheckBtn'); if (scb) scb.addEventListener('click', spellCheck);
    // Hide outdated suggestions when GPT text changes
    (function(){ const ta=document.getElementById('gptInput'); if (ta){ ta.addEventListener('input', ()=>{ try{ if (_spellAbort){ _spellAbort.abort(); } }catch(_){ } _spellAbort=null; _spellState={ textSnapshot:'', matches:[] }; const sp=document.getElementById('spellPanel'); if (sp){ sp.style.display='none'; sp.innerHTML=''; } }); }})();

    // ---- Keyword review
    function normalizeTextForMatch(s){
      return String(s||'').replace(/[\t\r\n]+/g,' ').replace(/\s{2,}/g,' ').trim();
    }
    function countKeywordInText(text, keyword){
      if (!text || !keyword) return 0;
      const t = normalizeTextForMatch(text);
      const k = normalizeTextForMatch(keyword);
      if (!k) return 0;
      // Exact phrase match count (allow punctuation/space boundaries around)
      const esc = k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const re = new RegExp(esc, 'g');
      let m, c=0; while ((m = re.exec(t))){ c++; }
      return c;
    }
    function getCurrentUsedKeywords(){
      if (activeIndex < 0) return [];
      const gpt = String(items[activeIndex].gpt||'');
      const list = getKeywordList();
      const used = [];
      for (const kw of list){
        const cnt = countKeywordInText(gpt, kw);
        if (cnt > 0) used.push({ keyword: kw, countInCurrent: cnt });
      }
      // sort by count desc then keyword asc
      used.sort((a,b)=> (b.countInCurrent - a.countInCurrent) || a.keyword.localeCompare(b.keyword));
      return used;
    }
    function countKeywordInAll(kw){
      let total=0;
      for (const it of items){
        if (!it || !it.submit) continue; // Ï†úÏ∂ú TRUEÎßå ÏßëÍ≥Ñ
        const g = String(it.gpt||'').trim();
        if (!g) continue;               // GPT ÎãµÎ≥Ä ÏóÜÎäî Ìñâ Ï†úÏô∏
        total += countKeywordInText(g, kw);
      }
      return total;
    }
    function openKeywordReview(){
      const panel = document.getElementById('kwPanel'); if (!panel) return;
      showOnlyPanel('kwPanel');
      if (activeIndex < 0){ panel.innerHTML = '<div class="hint">Ï¢åÏ∏°ÏóêÏÑú ÌñâÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.</div>'; return; }
      const used = getCurrentUsedKeywords();
      if (used.length === 0){ panel.innerHTML = '<div class="hint">ÌòÑÏû¨ ÎãµÎ≥ÄÏóê ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>'; return; }
      const rows = used.map(u=>{
        const total = countKeywordInAll(u.keyword);
        const left = `<div class=\"rev-left\"><span>${escapeHtml(u.keyword)}</span></div>`;
        const cls = (total>=5) ? 'rev-fail' : 'rev-pass';
        const pill = `<span class=\"rev-pill ${cls}\">Ï†ÑÏ≤¥ ${total}Ìöå</span>`;
        return `<div class=\"rev-row\">${left}${pill}</div>`;
      }).join('');
      panel.innerHTML = `<div class=\"hint\" style=\"margin-bottom:6px;\">ÎÇ¥ ÎãµÎ≥ÄÏóê ÏÇ¨Ïö©Îêú ÌÇ§ÏõåÎìú</div>` + rows;
      panel.style.display = 'block';
    }
    (function(){ const b=document.getElementById('kwBtn'); if (b) b.addEventListener('click', openKeywordReview); })();

    // ---- Apply confirmed comments (JSONP fetch)
    (function(){
      const btn = document.getElementById('applyConfirmBtn');
      if (!btn) return;
      const WEB_APP_URL = document.getElementById('submitForm')?.getAttribute('action') || '';
      function extractCafeArticleId(str){
        try {
          const s = String(str||'');
          // try query param first (case-insensitive key search)
          try {
            const url = new URL(s);
            let qid = '';
            for (const [k,v] of url.searchParams.entries()){
              const key = String(k||'').toLowerCase();
              if (key.includes('article') && /\d+/.test(String(v||''))){ qid = String(v||''); break; }
            }
            if (qid && /\d+/.test(qid)) return qid.match(/\d+/)[0];
            // then last numeric segment in path (prefer '/articles/{id}')
            const path = url.pathname || '';
            let m = path.match(/\/articles\/(\d+)/i);
            if (m) return m[1];
            const nums = path.match(/\d+/g);
            if (nums && nums.length) return nums[nums.length-1];
          } catch(_){
            // not a full URL; find first number sequence
            const nums2 = s.match(/\d{3,}/g);
            if (nums2 && nums2.length) return nums2[nums2.length-1];
          }
        } catch(_){ }
        return null;
      }
      function normalizeUrl(u){
        try {
          const s = String(u||'').trim();
          if (!s) return '';
          try {
            const url = new URL(s);
            // unify host (mobile -> desktop) for naver cafe
            let host = (url.hostname||'').toLowerCase();
            if (host === 'm.cafe.naver.com') host = 'cafe.naver.com';
            if (host.endsWith('cafe.naver.com')){
              const id = extractCafeArticleId(s);
              if (id) return host + '/id:' + id;
            }
            let path = url.pathname || '/';
            if (path.length>1 && path.endsWith('/')) path = path.slice(0,-1);
            return host + path;
          } catch(_) {
            // not a full URL; best-effort
            const low = s.replace(/\/$/,'').toLowerCase();
            if (low.includes('cafe.naver.com')){
              const id = extractCafeArticleId(low);
              if (id) return 'cafe.naver.com/id:' + id;
            }
            return low;
          }
        } catch(_) { return String(u||''); }
      }
      function applyConfirmedRows(rows){
        // rows: array of objects or arrays; support state: 'T'|'F'|'D' and optional comment
        // Accept shapes:
        // 1) [{ url, state, comment }]
        // 2) [[NO, cafe, url, url2, body, comment, state], ...]
        // 3) Legacy: confirm boolean instead of state(T/F)
        const mapState = new Map(); // url -> { state, comment }
        for (const r of (rows||[])){
          if (Array.isArray(r)){
            const url = normalizeUrl(r[2] || r[3] || '');
            const comment = r[5] != null ? String(r[5]) : '';
            let state = r[6];
            if (typeof state === 'string') state = state.trim().toUpperCase().charAt(0);
            if (state === true) state = 'T';
            if (state === false) state = 'F';
            if (!url || !state || !('TFD'.includes(state))) continue;
            mapState.set(url, { state, comment });
          } else if (r && typeof r === 'object'){
            const url = normalizeUrl(r.url||r.URL||'');
            const comment = r.comment!=null ? String(r.comment) : (r.ÎåìÍ∏Ä!=null ? String(r.ÎåìÍ∏Ä) : '');
            let state = r.state || r.Status || r.status;
            if (typeof state === 'string') state = state.trim().toUpperCase().charAt(0);
            if (!url || !state || !('TFD'.includes(state))) continue; // ÏÉÅÌÉú ÏóÜÏúºÎ©¥ Ïä§ÌÇµ(Î†àÍ±∞Ïãú confirm ÎØ∏ÏÇ¨Ïö©)
            mapState.set(url, { state, comment });
          }
        }
        if (!mapState.size){ showToast('Î∞òÏòÅÌï† Ìï≠Î™©Ïù¥ ÏóÜÏñ¥Ïöî'); return; }
        let t=0,f=0,d=0, miss=0;
        const seen = new Set();
        for (const it of items){
          const url = normalizeUrl(it.url||'');
          if (!url) continue;
          // Î°úÏª¨ Ï†úÏô∏ Í∑úÏπô: ÎπÑÍ≥†Í∞Ä 'ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å'Ïù∏ ÌñâÏùÄ Î∞òÏòÅ ÎåÄÏÉÅÏóêÏÑú Ï†úÏô∏
          const remarkTrim = String(it.remark||'').trim();
          if (remarkTrim === 'ÎåìÍ∏ÄÏûëÏÑ±ÏôÑÎ£å') continue;
          const pack = mapState.get(url);
          if (!pack) continue;
          const state = String(pack.state||'').trim().toUpperCase().charAt(0);
          const comment = String(pack.comment||'');
          if (state==='T'){
            if (comment) it.gpt = comment;
            // auto brand detect from new comment
            const detected = detectBrandFromTextClient(comment);
            if (detected){ it.brand = detected; }
            it.submit = true;
            modified.set(it.rowIdx, { gpt: it.gpt, submit: it.submit, cafe: it.cafe, brand: it.brand, myNick: it.myNick });
            t++; seen.add(url);
          } else if (state==='F'){
            // ÏöîÍµ¨ÏÇ¨Ìï≠ Î≥ÄÍ≤Ω: FÎäî Î∞òÏòÅÌïòÏßÄ ÏïäÏùå(ÌòÑ ÏÉÅÌÉú Ïú†ÏßÄ)
            f++; seen.add(url);
          } else if (state==='D'){
            if (!deletedRows.has(it.rowIdx)) deletedRows.add(it.rowIdx);
            modified.set(it.rowIdx, { gpt: it.gpt, submit: it.submit, cafe: it.cafe, brand: it.brand, myNick: it.myNick });
            d++; seen.add(url);
          }
        }
        miss = mapState.size - seen.size;
        renderList(document.getElementById('searchInput').value||'');
        bindToolbox();
        if (activeIndex>=0){
          const it=items[activeIndex];
          document.getElementById('gptInput').value = it.gpt||'';
          setSubmitSeg(!!it.submit);
        }
        updateTargetCount();
        showToast(`T:${t} ¬∑ F:${f} ¬∑ D:${d}${miss>0?` ¬∑ miss:${miss}`:''} (ÎØ∏Ï†ÄÏû•)`);
      }
      function jsonp(url, params, callback){
        const cbName = `cb_${Date.now()}_${Math.floor(Math.random()*1e6)}`;
        const q = new URLSearchParams(params||{});
        q.set('callback', cbName);
        const s = document.createElement('script');
        s.src = url + (url.includes('?')?'&':'?') + q.toString();
        window[cbName] = (data)=>{ try{ callback(null, data); } finally { delete window[cbName]; document.body.removeChild(s); } };
        s.onerror = ()=>{ try{ callback(new Error('load error')); } finally { delete window[cbName]; try{ document.body.removeChild(s);}catch(_){}} };
        document.body.appendChild(s);
      }
      function asArray(payload){
        if (Array.isArray(payload)) return payload;
        if (payload && Array.isArray(payload.rows)) return payload.rows;
        if (payload && Array.isArray(payload.data)) return payload.data;
        return [];
      }
      async function handleApply(){
        if (!WEB_APP_URL){ 
          alert('‚ö†Ô∏è ÏõπÏï± URLÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\n\nHTML ÌååÏùºÏóêÏÑú submitFormÏùò action ÏÜçÏÑ±ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.'); 
          console.error('WEB_APP_URLÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§. submitFormÏùò actionÏùÑ ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.');
          return; 
        }
        
        btn.disabled = true;
        const orig = btn.innerHTML;
        btn.innerHTML = '<span class="spinner"></span>&nbsp;Î∂àÎü¨Ïò§Îäî Ï§ë...';
        
        console.log('üçé [Ïª®Ìéå Î∞òÏòÅ] JSONP ÏöîÏ≤≠ ÏãúÏûë:', WEB_APP_URL);
        
        // States Ï†ÑÏö© Î∞òÏòÅ(Ìè¥Î∞± ÏóÜÏùå). rowsÍ∞Ä ÎπÑÎ©¥ ÏïÑÎ¨¥ Í≤ÉÎèÑ Î∞òÏòÅÌïòÏßÄ ÏïäÏùå
        jsonp(WEB_APP_URL, { mode: 'states' }, (err, data)=>{
          btn.disabled=false; btn.innerHTML = orig;
          
          if (err){ 
            console.error('üçé [Ïª®Ìéå Î∞òÏòÅ] JSONP Ïò§Î•ò:', err);
            alert('‚ùå Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®\n\n' + (err.message || err)); 
            return; 
          }
          
          console.log('üçé [Ïª®Ìéå Î∞òÏòÅ] ÏÑúÎ≤Ñ ÏùëÎãµ:', data);
          
          const rows = asArray(data);
          
          // ÎîîÎ≤ÑÍ∑∏ ÌÜ†Ïä§Ìä∏: ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÏÉÅÌÉú Í±¥Ïàò ÌëúÏãú
          try {
            const cT = rows.filter(r=> String((r.state||r.Status||r.status||'')).trim().toUpperCase().charAt(0)==='T').length;
            const cF = rows.filter(r=> String((r.state||r.Status||r.status||'')).trim().toUpperCase().charAt(0)==='F').length;
            const cD = rows.filter(r=> String((r.state||r.Status||r.status||'')).trim().toUpperCase().charAt(0)==='D').length;
            console.log(`üçé [Ïª®Ìéå Î∞òÏòÅ] ÏÑúÎ≤Ñ rows T:${cT} F:${cF} D:${cD}`);
            showToast(`ÏÑúÎ≤Ñ rows T:${cT} F:${cF} D:${cD}`);
          } catch(e){ 
            console.error('üçé [Ïª®Ìéå Î∞òÏòÅ] ÏÉÅÌÉú Ïπ¥Ïö¥Ìä∏ Ïò§Î•ò:', e);
          }
          
          if (!rows.length){ 
            alert('ÏÉÅÌÉú(T/F/D) Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.\n\nÏÑúÎ≤ÑÏóêÏÑú Î∞òÌôòÎêú Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.'); 
            console.warn('üçé [Ïª®Ìéå Î∞òÏòÅ] Îπà rows Î∞∞Ïó¥');
            return; 
          }
          
          applyConfirmedRows(rows);
        });
      }
      btn.addEventListener('click', handleApply);
    })();

    function openPNUSpeller(text){
      try {
        const form = document.createElement('form');
        form.action = 'https://speller.cs.pusan.ac.kr/results';
        form.method = 'POST';
        form.target = '_blank';
        const ta = document.createElement('textarea');
        ta.name = 'text1';
        ta.value = String(text||'');
        form.appendChild(ta);
        form.style.display = 'none';
        document.body.appendChild(form);
        form.submit();
        setTimeout(()=>{ document.body.removeChild(form); }, 1000);
        showToast('ÏÉà ÌÉ≠ÏóêÏÑú ÎßûÏ∂§Î≤ï Í≤ÄÏÇ¨Î•º Ïó¥ÏóàÏñ¥Ïöî');
      } catch(e){ showToast('ÏÉà ÌÉ≠ Ïó¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî'); }
    }

    // Local heuristic matcher for common Korean mistakes
    function applyTemplate(tpl, m){ return String(tpl||'').replace(/\$(\d)/g, (_,d)=> String(m[parseInt(d,10)]||'')); }
    function collectProtectedRanges(s){
      const ranges=[];
      const regs=[
        /ÏóòÎ¶¨.{0,6}ÌÇ§Ï¶à/gi,
        /Ïó†\s*Î≤†?.{0,4}(?:Ïä§|„ÖÖ)?\s*Ìä∏/gi,
        /ÏóòÎ¶¨.{0,4}Ìïò.?Ïù¥/gi,
      ];
      for (const r of regs){
        let m; while ((m = r.exec(s))){ ranges.push([m.index, m.index + m[0].length]); if (!r.global) break; }
      }
      return ranges;
    }
    function overlaps(ranges, start, end){ for (const [a,b] of ranges){ if (start < b && end > a) return true; } return false; }
    function buildHeuristicMatches(text){
      const t = String(text||'');
      const protectedRanges = collectProtectedRanges(t);
      const rules = [
        { re: /(Îê¨)/g, repl: 'Îêê', msg: '"Îê¨" ‚Üí "Îêê"' },
        { re: /(ÎêòÏöî)/g, repl: 'ÎèºÏöî', msg: '"ÎêòÏöî" ‚Üí "ÎèºÏöî"' },
        { re: /(ÎêòÏïº)/g, repl: 'ÎèºÏïº', msg: '"ÎêòÏïº" ‚Üí "ÎèºÏïº"' },
        { re: /(ÎêòÏïºÍ≤†)/g, repl: 'ÎèºÏïºÍ≤†', msg: '"ÎêòÏïºÍ≤†~" ‚Üí "ÎèºÏïºÍ≤†~"' },
        { re: /(ÎêòÏïºÏßÄ)/g, repl: 'ÎèºÏïºÏßÄ', msg: '"ÎêòÏïºÏßÄ" ‚Üí "ÎèºÏïºÏßÄ"' },
        { re: /(ÎêòÏïºÏ£†)/g, repl: 'ÎèºÏïºÏ£†', msg: '"ÎêòÏïºÏ£†" ‚Üí "ÎèºÏïºÏ£†"' },
        { re: /(ÎêòÏÑú)/g, repl: 'ÎèºÏÑú', msg: '"ÎêòÏÑú" ‚Üí "ÎèºÏÑú"' },
        { re: /(ÎêòÎèÑ)/g, repl: 'ÎèºÎèÑ', msg: '"ÎêòÎèÑ" ‚Üí "ÎèºÎèÑ"' },
        { re: /(ÎèºÍ≤†)/g, repl: 'ÎêòÍ≤†', msg: '"ÎèºÍ≤†~" ‚Üí "ÎêòÍ≤†~"' },
        { re: /(Îêò(Î≤ÑÎ†∏|Î≤ÑÎ¶¨))/g, repl: 'Îèº$2', msg: '"ÎêòÎ≤ÑÎ¶¨~" ‚Üí "ÎèºÎ≤ÑÎ¶¨~"' },
        { re: /(ÏïàÎèº)([Í∞Ä-Ìû£]*)/g, repl: 'Ïïà Îèº$2', msg: '"ÏïàÎèº"Îäî ÎùÑÏñ¥Ïç®ÏÑú "Ïïà Îèº"' },
        { re: /(ÏïàÎê©ÎãàÎã§)/g, repl: 'Ïïà Îê©ÎãàÎã§', msg: '"ÏïàÎê©ÎãàÎã§" ‚Üí "Ïïà Îê©ÎãàÎã§"' },
        { re: /(ÏïäÎêò)([Í∞Ä-Ìû£]*)/g, repl: 'Ïïà Îêò$2', msg: '"ÏïäÎêò~" ‚Üí "Ïïà Îêò~"' },
        { re: /(ÏïàÏ¢ã)/g, repl: 'Ïïà Ï¢ã', msg: '"ÏïàÏ¢ã~" ‚Üí "Ïïà Ï¢ã~"' },
        { re: /\b(Ïàò)(?=(Ïûà|ÏóÜ))/g, repl: '$1 ', msg: '"ÏàòÏûà/ÏàòÏóÜ" ‚Üí "Ïàò Ïûà/Ïàò ÏóÜ"' },
        { re: /(Ìï†|Í∞à|Ïò¨)ÍªòÏöî/g, repl: '$1Í≤åÏöî', msg: '"~ÍªòÏöî" ‚Üí "~Í≤åÏöî"' },
        { re: /(Í∞ôÏï†)/g, repl: 'Í∞ôÏïÑ', msg: '"Í∞ôÏï†" ‚Üí "Í∞ôÏïÑ"' },
        { re: /(Ïñ¥ÎñªÌï¥)/g, repl: 'Ïñ¥ÎñªÍ≤å', msg: '"Ïñ¥ÎñªÌï¥" ‚Üí "Ïñ¥ÎñªÍ≤å"' },
        { re: /(Ïõ¨ÏßÄ)/g, repl: 'Ïô†ÏßÄ', msg: '"Ïõ¨ÏßÄ" ‚Üí "Ïô†ÏßÄ(ÏôúÏù∏ÏßÄ)"' },
        { re: /(Ïô†Ïùº)/g, repl: 'Ïõ¨Ïùº', msg: '"Ïô†Ïùº" ‚Üí "Ïõ¨Ïùº"' },
        { re: /(Ïô†Îßå)/g, repl: 'Ïõ¨Îßå', msg: '"Ïõ¨Îßå" ‚Üí "Ïõ¨Îßå"' },
        { re: /(Í±∞)(?=\s*Í∞ô)/g, repl: 'Í≤É', msg: '"Í±∞ Í∞ô" ‚Üí "Í≤É Í∞ô"' },
        { re: /(ÎÇ¥Í∫º)/g, repl: 'ÎÇ¥ Í≤É', msg: '"ÎÇ¥Í∫º" ‚Üí "ÎÇ¥ Í≤É"' },
        { re: /(ÎãàÍ∞Ä)/g, repl: 'ÎÑ§Í∞Ä', msg: '"ÎãàÍ∞Ä" ‚Üí "ÎÑ§Í∞Ä"' },
        { re: /(Í∑∏ÎïåÎ¨∏Ïóê)/g, repl: 'Í∑∏ ÎïåÎ¨∏Ïóê', msg: '"Í∑∏ÎïåÎ¨∏Ïóê" ‚Üí "Í∑∏ ÎïåÎ¨∏Ïóê"' },
        { re: /(Îïå)\s*(Î¨∏Ïóê)/g, repl: '$1$2', msg: '"Îïå Î¨∏Ïóê" ‚Üí "ÎïåÎ¨∏Ïóê"' },
        { re: /(Îïå)\s*(ÎßàÎã§)/g, repl: '$1$2', msg: '"Îïå ÎßàÎã§" ‚Üí "ÎïåÎßàÎã§"' },
        { re: /(Ìó∏Ïñ¥Ïöî)/g, repl: 'ÌñàÏñ¥Ïöî', msg: '"Ìó∏Ïñ¥Ïöî" ‚Üí "ÌñàÏñ¥Ïöî"' },
        { re: /(ÏïàÎêò)([Í∞Ä-Ìû£]*)/g, repl: 'Ïïà Îèº$2', msg: '"ÏïàÎêò~" ‚Üí "Ïïà Îèº~"' },
        { re: /(Ïàò)\s*(Î∞ñÏóê)/g, repl: '$1$2', msg: '"Ïàò Î∞ñÏóê" ‚Üí "ÏàòÎ∞ñÏóê"' },
        { re: /(Í∏àÏÉà)/g, repl: 'Í∏àÏÑ∏', msg: '"Í∏àÏÉà" ‚Üí "Í∏àÏÑ∏"' },
        { re: /(Ïò§Îû´Îßå)/g, repl: 'Ïò§ÎûúÎßå', msg: '"Ïò§Îû´Îßå" ‚Üí "Ïò§ÎûúÎßå"' },
        { re: /(Ïò§ÎûòÎèôÏïà)/g, repl: 'Ïò§Îû´ÎèôÏïà', msg: '"Ïò§ÎûòÎèôÏïà" ‚Üí "Ïò§Îû´ÎèôÏïà"' },
        { re: /(Í∞ÄÎ•¥ÌÇ§)/g, repl: 'Í∞ÄÎ¶¨ÌÇ§', msg: '"Í∞ÄÎ•¥ÌÇ§~" ‚Üí "Í∞ÄÎ¶¨ÌÇ§~"' },
        { re: /(ÎßûÏ≥ê)/g, repl: 'ÎßûÏ∂∞', msg: '"ÎßûÏ≥ê" ‚Üí "ÎßûÏ∂∞"' },
        { re: /(ÎßûÏ≤ò)/g, repl: 'ÎßûÏ∂∞', msg: '"ÎßûÏ≤ò" ‚Üí "ÎßûÏ∂∞"' },
        { re: /(Ïñ¥ÏùòÏóÜ)/g, repl: 'Ïñ¥Ïù¥ÏóÜ', msg: '"Ïñ¥ÏùòÏóÜ~" ‚Üí "Ïñ¥Ïù¥ÏóÜ~"' },
        { re: /(ÎêòÏòÄ)/g, repl: 'Îêê', msg: '"ÎêòÏòÄ~" ‚Üí "Îêê~"' },
        { re: /(ÎøêÎßåÏïÑÎãàÎùº)/g, repl: 'ÎøêÎßå ÏïÑÎãàÎùº', msg: '"ÎøêÎßåÏïÑÎãàÎùº" ‚Üí "ÎøêÎßå ÏïÑÎãàÎùº"' },
        { re: /(ÏùçÎãàÎã§)/g, repl: 'ÏäµÎãàÎã§', msg: '"ÏùçÎãàÎã§" ‚Üí "ÏäµÎãàÎã§"' },
        { re: /(ÎìúÎùºÍ≥†Ïöî)/g, repl: 'ÎçîÎùºÍ≥†Ïöî', msg: '"ÎìúÎùºÍ≥†Ïöî" ‚Üí "ÎçîÎùºÍ≥†Ïöî"' },
        { re: /(ÌïòÎØÄÎ°úÏÑú)/g, repl: 'Ìï®ÏúºÎ°úÏç®', msg: '"ÌïòÎØÄÎ°úÏÑú" ‚Üí "Ìï®ÏúºÎ°úÏç®"' },
        // Í≥µÎ∞± ÏùºÎ∞òÌôî: "ÏïàÏ¢ã"Î•òÎäî ÏúÑÏóêÏÑú Ï≤òÎ¶¨, Í∑∏ Ïô∏ ÏùºÎ∂Ä Í¥ÄÏö© Íµ¨Î∂Ñ Ï∂îÍ∞Ä Í∞ÄÎä•
        { re: /(ÏûáÏñ¥)/g, repl: 'ÏûàÏñ¥', msg: '"ÏûáÏñ¥" ‚Üí "ÏûàÏñ¥"' },
        { re: /(ÏûáÏùÑ)/g, repl: 'ÏûàÏùÑ', msg: '"ÏûáÏùÑ" ‚Üí "ÏûàÏùÑ"' },
        { re: /(ÏûáÏùå)/g, repl: 'ÏûàÏùå', msg: '"ÏûáÏùå" ‚Üí "ÏûàÏùå"' },
        { re: /(ÏûáÎäî)/g, repl: 'ÏûàÎäî', msg: '"ÏûáÎäî" ‚Üí "ÏûàÎäî"' },
        { re: /(ÏûáÎçò)/g, repl: 'ÏûàÎçò', msg: '"ÏûáÎçò" ‚Üí "ÏûàÎçò"' },
        { re: /(Îê¨Îã§)/g, repl: 'ÎêêÎã§', msg: '"Îê¨Îã§" ‚Üí "ÎêêÎã§"' },
        { re: /(Îê¨Ïñ¥)/g, repl: 'ÎêêÏñ¥', msg: '"Îê¨Ïñ¥" ‚Üí "ÎêêÏñ¥"' },
        { re: /(Îê¨ÏùÑ)/g, repl: 'ÎêêÏùÑ', msg: '"Îê¨ÏùÑ" ‚Üí "ÎêêÏùÑ"' },
        { re: /(Îê¨ÎÑ§Ïöî)/g, repl: 'ÎêêÎÑ§Ïöî', msg: '"Îê¨ÎÑ§Ïöî" ‚Üí "ÎêêÎÑ§Ïöî"' },
        { re: /(ÏïàÎê¨)/g, repl: 'Ïïà Îêê', msg: '"ÏïàÎê¨~" ‚Üí "Ïïà Îêê~"' },
        { re: /(ÏïäÎèºÏöî)/g, repl: 'Ïïà ÎèºÏöî', msg: '"ÏïäÎèºÏöî" ‚Üí "Ïïà ÎèºÏöî"' },
        { re: /(ÏïäÎê¨)/g, repl: 'Ïïà Îêê', msg: '"ÏïäÎê¨~" ‚Üí "Ïïà Îêê~"' },
        { re: /(ÎêòÏûà)([Í∞Ä-Ìû£ ]*)/g, repl: 'Îèº Ïûà$2', msg: '"ÎêòÏûà~" ‚Üí "Îèº Ïûà~"' },
        { re: /(ÎêòÏòÄÏñ¥)/g, repl: 'ÎêêÏñ¥', msg: '"ÎêòÏòÄÏñ¥" ‚Üí "ÎêêÏñ¥"' },
        { re: /(ÎêòÏòÄÎãà)/g, repl: 'ÎêêÎãà', msg: '"ÎêòÏòÄÎãà" ‚Üí "ÎêêÎãà"' },
        { re: /(ÎêòÏòÄÎçò)/g, repl: 'ÎêêÎçò', msg: '"ÎêòÏòÄÎçò" ‚Üí "ÎêêÎçò"' },
        { re: /(ÎêòÏòÄÏùÑ)/g, repl: 'ÎêêÏùÑ', msg: '"ÎêòÏòÄÏùÑ" ‚Üí "ÎêêÏùÑ"' },
        { re: /(Îê´)/g, repl: 'Îêê', msg: '"Îê´~" ‚Üí "Îêê~"' },
        { re: /(ÏïàÏïÑÏöî)/g, repl: 'ÏïäÏïÑÏöî', msg: '"ÏïàÏïÑÏöî" ‚Üí "ÏïäÏïÑÏöî"' },
        { re: /(ÏïàÏïò)/g, repl: 'ÏïäÏïò', msg: '"ÏïàÏïò~" ‚Üí "ÏïäÏïò~"' },
        { re: /(ÏïäÏùÑÍªòÏöî)/g, repl: 'ÏïäÏùÑÍ≤åÏöî', msg: '"ÏïäÏùÑÍªòÏöî" ‚Üí "ÏïäÏùÑÍ≤åÏöî"' },
        { re: /(Ìï†Íªò)/g, repl: 'Ìï†Í≤å', msg: '"Ìï†Íªò" ‚Üí "Ìï†Í≤å"' },
        { re: /(Í∞àÍªò)/g, repl: 'Í∞àÍ≤å', msg: '"Í∞àÍªò" ‚Üí "Í∞àÍ≤å"' },
        { re: /(Ïò¨Íªò)/g, repl: 'Ïò¨Í≤å', msg: '"Ïò¨Íªò" ‚Üí "Ïò¨Í≤å"' },
        { re: /(Î®∏Î¶¨ÏÜç)/g, repl: 'Î®∏Î¶øÏÜç', msg: '"Î®∏Î¶¨ÏÜç" ‚Üí "Î®∏Î¶øÏÜç"' },
        { re: /(Î™áÏùº)/g, repl: 'Î©∞Ïπ†', msg: '"Î™áÏùº" ‚Üí "Î©∞Ïπ†"' },
        { re: /(Ïô†)/g, repl: 'Ïõ¨', msg: '"Ïô†~" ‚Üí "Ïõ¨~" (Î¨∏Îß• ÌïúÏ†ï)', },
        // Í≥µÎ∞± ÏùºÎ∞òÌôî: "ÏïàÏ¢ã"Î•òÎäî ÏúÑÏóêÏÑú Ï≤òÎ¶¨, Í∑∏ Ïô∏ ÏùºÎ∂Ä Í¥ÄÏö© Íµ¨Î∂Ñ Ï∂îÍ∞Ä Í∞ÄÎä•
        { re: /\s{2,}/g, repl: ' ', msg: 'Ïó∞ÏÜç Í≥µÎ∞± ‚Üí Ìïú Ïπ∏' },
        { re: /(„Öã){3,}/g, repl: '„Öã„Öã', msg: '"„Öã" 3Ìöå Ïù¥ÏÉÅ ‚Üí "„Öã„Öã"' },
        { re: /(„Öé){3,}/g, repl: '„Öé„Öé', msg: '"„Öé" 3Ìöå Ïù¥ÏÉÅ ‚Üí "„Öé„Öé"' },
        { re: /(„Ö†){3,}/g, repl: '„Ö†„Ö†', msg: '"„Ö†" 3Ìöå Ïù¥ÏÉÅ ‚Üí "„Ö†„Ö†"' },
        { re: /([Í∞Ä-Ìû£])[A-Za-z]+([Í∞Ä-Ìû£])/g, repl: '', msg: 'ÌïúÍ∏Ä ÏÇ¨Ïù¥ ÏòÅÎ¨∏ ÌòºÏûÖ (ÏàòÎèô ÌôïÏù∏ Í∂åÏû•)' },
      ];
      const out=[];
      for (const rule of rules){
        const re = new RegExp(rule.re.source, rule.re.flags);
        let m; while ((m = re.exec(t))){
          const found = m[0];
          const repl = applyTemplate(rule.repl, m);
          const start = m.index; const end = start + found.length;
          if (overlaps(protectedRanges, start, end)) { if (!re.global) break; else continue; }
          out.push({ offset: start, length: found.length, found, repl, message: rule.msg, replacements: [{ value: repl }] });
          if (!re.global) break;
        }
      }
      return out;
    }

    // ---- Inline review for 4 checks ----
    function _countNoSpace(v){ return String(v||'').replace(/\s+/g,'').length; }
    function _hasMiddleDot(v){ return /\u00B7/.test(v); }
    function _forbiddenSymbolHits(v){
      const s=String(v||'');
      const hits=[]; if (/\u00B7/.test(s)) hits.push('¬∑'); if (/-/.test(s)) hits.push('-'); if (/\//.test(s)) hits.push('/');
      return hits;
    }
    function _bannedHits(v){ const banned=['Í∑†Ìòï','Í≤åÏûÑ','ÌùêÎ¶Ñ','Í∏∞Î∞ò']; return banned.filter(w=>v.includes(w)); }
    function _wordCheckHits(v){
      const s=String(v||'');
      const pairs=[ ['Î¨∏Ïû¨','Î¨∏Ï†ú'], ['Ï†ÑÍ≥ºÎ™©','ÌÜµÌï©Í≥ºÎ™©'], ['Ïì∞Í≥†','ÌïòÍ≥†'] ];
      const hits=[];
      for (const [bad,good] of pairs){ if (s.includes(bad)) hits.push(`${bad}‚Üí${good}`); }
      return hits;
    }
    function _brandPlainFound(v){ return /(ÏóòÎ¶¨ÌïòÏù¥ÌÇ§Ï¶à|ÏóòÎ¶¨ÌïòÏù¥|Ïó†Î≤†Ïä§Ìä∏)/g.test(String(v||'')); }
    function _brandAllowedMaskedFound(v){
      const s=String(v||'');
      return /(ÏóòÎ¶¨Ìïò.ÌÇ§Ï¶à|ÏóòÎ¶¨.Ïù¥ÌÇ§Ï¶à|ÏóòÎ¶¨XÏù¥ÌÇ§Ï¶à|ÏóòÎ¶¨ÌïòXÌÇ§Ï¶à|ÏóòÎ¶¨„ÖéÏù¥ÌÇ§Ï¶à)/g.test(s)
          || /(ÏóòÎ¶¨Ìïò.|ÏóòÎ¶¨.Ïù¥|ÏóòÎ¶¨XÏù¥|ÏóòÎ¶¨ÌïòX|ÏóòÎ¶¨„ÖéÏù¥)(?!ÌÇ§Ï¶à)/g.test(s)
          || /(Ïó†Î≤†.Ìä∏|Ïó†.Ïä§Ìä∏|Ïó†Î≤†XÌä∏|Ïó†Î≤†„ÖÖÌä∏|Ïó†Î≤†Ïä§X)/g.test(s);
    }
    function _brandMalformedFound(v){
      const s=String(v||'');
      // Ï†ÑÎ∞òÏ†Å Ïñ∏Í∏â ÌÉêÏßÄ
      const kidsAny=/ÏóòÎ¶¨.{0,4}?ÌÇ§Ï¶à/g; const elAny=/ÏóòÎ¶¨.{0,3}?Ïù¥(?![Í∞Ä-Ìû£]*ÌÇ§Ï¶à)/g; const mbAny=/Ïó†.{0,3}?Ìä∏/g;
      const kidsMention=kidsAny.test(s); kidsAny.lastIndex=0; const elMention=elAny.test(s); elAny.lastIndex=0; const mbMention=mbAny.test(s); mbAny.lastIndex=0;
      const allowed=_brandAllowedMaskedFound(s);
      // ÎπÑÌóàÏö© Î∞òÏ™Ω/Î≥ÄÌòï
      const partialBad=/(ÏóòÎ¶¨Ìïò(?![\*X„Öé]|Ïù¥|ÌÇ§Ï¶à))|(ÏóòÎ¶¨Ïù¥ÌÇ§Ï¶à)|(Ïó†Î≤†Ïä§(?![X„ÖÖ]|Ìä∏))|(Ïó†Ïä§Ìä∏)/g;
      if (partialBad.test(s)) { partialBad.lastIndex=0; return true; }
      if ((kidsMention||elMention||mbMention) && !allowed) return true;
      return false;
    }
    // Brand detection (client) similar to backend sheet_tabs.detect_brand_from_text
    function detectBrandFromTextClient(text){
      try {
        let s = String(text||'');
        // remove spaces and common noise chars but keep Hangul jamo for mapping
        s = s.replace(/\s+/g,'');
        s = s.replace(/[¬∑\-_*xX~|\/\.,`'\u200b]+/g,'');
        // normalize frequent masking variants
        s = s.replace(/ÌÇ§Ï•¨/g,'ÌÇ§Ï¶à');
        s = s.replace(/Ïóò„Ñπ/g,'ÏóòÎ¶¨');       // Ïóò„Ñπ ‚Üí ÏóòÎ¶¨
        s = s.replace(/„Öé„Öá/g,'ÌïòÏù¥');       // „Öé„Öá ‚Üí ÌïòÏù¥
        s = s.replace(/Ìïò„Öá/g,'ÌïòÏù¥');       // Ìïò„Öá ‚Üí ÌïòÏù¥
        s = s.replace(/ÏóòÎ¶¨[\*xX]Ïù¥/g,'ÏóòÎ¶¨ÌïòÏù¥'); // ÏóòÎ¶¨*Ïù¥, ÏóòÎ¶¨xÏù¥ ‚Üí ÏóòÎ¶¨ÌïòÏù¥
        s = s.replace(/ÏóòÎ¶¨Ìïò[\*xX]/g,'ÏóòÎ¶¨ÌïòÏù¥'); // ÏóòÎ¶¨Ìïò*, ÏóòÎ¶¨ÌïòX ‚Üí ÏóòÎ¶¨ÌïòÏù¥
        s = s.replace(/„ÖÖÌä∏/g,'Ïä§Ìä∏');       // „ÖÖÌä∏ ‚Üí Ïä§Ìä∏ (Ïó†Î≤†„ÖÖÌä∏ Îì±)
        // broad matching
        if (/ÏóòÎ¶¨.{0,6}ÌÇ§Ï¶à/.test(s)) return 'ÏóòÎ¶¨ÌïòÏù¥ÌÇ§Ï¶à';
        // ÏóòÎ¶¨ÌïòÏù¥Î•º Ïó†Î≤†Î≥¥Îã§ Ïö∞ÏÑ† ÌåêÎã® ("Ïó†Î≤†ÍπåÏßÄ" Í∞ôÏùÄ Î∂ÄÍ∞Ä Ïñ∏Í∏â ÏºÄÏù¥Ïä§ Ïö∞ÏÑ†ÏàúÏúÑ)
        if (/ÏóòÎ¶¨.{0,4}Ìïò.?Ïù¥/.test(s)) return 'ÏóòÎ¶¨ÌïòÏù¥';
        if (s.includes('Ïó†Î≤†Ïä§Ìä∏') || /Ïó†\s*Î≤†?.{0,4}(?:Ïä§|„ÖÖ)?\s*Ìä∏/.test(s)) return 'Ïó†Î≤†Ïä§Ìä∏';
      } catch(_){ }
      return '';
    }
    function openReview(){
      const panel=document.getElementById('reviewPanel'); const ta=document.getElementById('gptInput'); if (!panel||!ta) return;
      showOnlyPanel('reviewPanel');
      const v=ta.value||''; const len=_countNoSpace(v);
      const rows=[
        {name:'Í∏àÏßÄ Í∏∞Ìò∏ ÏóÜÏùå(¬∑ - /)', pass: _forbiddenSymbolHits(v).length===0, desc: _forbiddenSymbolHits(v).join(' ') },
        {name:'Í∏àÏßÄÏñ¥ ÏóÜÏùå', pass: _bannedHits(v).length===0, desc: _bannedHits(v).join(', ') },
        {name:'Îã®Ïñ¥ ÍµêÏ†ï Ï†úÏïà', pass: _wordCheckHits(v).length===0, desc: _wordCheckHits(v).join(', ') },
        {name:'Î∏åÎûúÎìú ÏõêÎ¨∏ ÏßÅÌëúÍ∏∞ Í∏àÏßÄ', pass: !_brandPlainFound(v)},
        {name:'Î∏åÎûúÎìú ÎßàÏä§ÌÇπ Ï§ÄÏàò', pass: !_brandPlainFound(v) ? (_brandAllowedMaskedFound(v) || !/(ÏóòÎ¶¨|Ïó†Î≤†)/.test(v)) : false },
        {name:'Î∏åÎûúÎìú ÎπÑÏ†ïÏÉÅ ÌëúÍ∏∞ Í∏àÏßÄ', pass: !_brandMalformedFound(v)},
      ];
      panel.innerHTML = rows.map(ch=>{
        const dot = `<span class=\"rev-dot\" style=\"background:${ch.pass?'#10b981':'#ef4444'}\"></span>`;
        const detail = ch.desc ? ` Î∞úÍ≤¨: ${escapeHtml(String(ch.desc))}` : '';
        const left = `<div class=\"rev-left\">${dot}<span>${ch.name}${detail}</span></div>`;
        const pill = `<span class=\"rev-pill ${ch.pass?'rev-pass':'rev-fail'}\">${ch.pass?'OK':'FIX'}</span>`;
        return `<div class=\"rev-row\">${left}${pill}</div>`;
      }).join('');
      panel.style.display='block';
    }
    (function(){ const b=document.getElementById('reviewBtn'); if (b) b.addEventListener('click', openReview); })();
    
    // ---- Navigation guards: block back/close when unsaved changes exist ----
    (function(){
      try {
        // Native leave guard (close/refresh/navigation)
        const beforeUnloadHandler = (e) => {
          try { if (!hasUnsavedChanges()) return; } catch(_) { return; }
          e.preventDefault();
          e.returnValue = 'Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ Ï†ÄÏû•ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ï†ïÎßê ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?';
          return e.returnValue;
        };
        
        window.addEventListener('beforeunload', beforeUnloadHandler);
        
        // üçé iOS Safari Ï∂îÍ∞Ä ÏßÄÏõê (iOSÏóêÏÑú beforeunloadÍ∞Ä Ï†úÌïúÏ†ÅÏù¥ÎØÄÎ°ú)
        if (isIOS || isSafari) {
          // pagehide Ïù¥Î≤§Ìä∏ (iOSÏóêÏÑú Îçî Ïã†Î¢∞Ìï† Ïàò ÏûàÏùå)
          window.addEventListener('pagehide', beforeUnloadHandler, { capture: true });
          
          // visibilitychange Ïù¥Î≤§Ìä∏ (ÌéòÏù¥ÏßÄ Ïà®ÍπÄ Ïãú)
          document.addEventListener('visibilitychange', () => {
            try {
              if (document.visibilityState === 'hidden' && hasUnsavedChanges()) {
                // Î∞±Í∑∏ÎùºÏö¥ÎìúÎ°ú Í∞à Îïå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏûÑÏãú Ï†ÄÏû•
                try {
                  const tempData = {
                    modified: Array.from(modified.entries()),
                    deletedRows: Array.from(deletedRows),
                    timestamp: Date.now()
                  };
                  localStorage.setItem('doha_temp_changes', JSON.stringify(tempData));
                  console.log('üì¶ ÏûÑÏãú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï†ÄÏû•Îê®');
                } catch(_) {}
              }
            } catch(_) { }
          });
        }
        
        // Back/forward guard via history sentinel; cancels back when dirty
        history.pushState({ doha_guard: 1 }, '', location.href);
        window.addEventListener('popstate', (ev)=>{
          try {
            if (hasUnsavedChanges()){
              history.pushState({ doha_guard: 1 }, '', location.href);
              try { showToast('ÎØ∏Ï†ÄÏû• Î≥ÄÍ≤ΩÏù¥ ÏûàÏñ¥ Îí§Î°úÍ∞ÄÍ∏∞Í∞Ä Ï∑®ÏÜåÎêòÏóàÏñ¥Ïöî'); } catch(_){ }
              try { openUnsavedModal(); } catch(_){ }
            }
          } catch(_) { /* ignore */ }
        });
      } catch(_) { /* ignore */ }
    })();
    
    // üçé Mobile Menu Modal
    (function(){
      const menuBtn = document.getElementById('mobileMenuBtn');
      const menuModal = document.getElementById('mobileMenuModal');
      const closeBtn = document.getElementById('closeMobileMenu');
      
      if (!menuBtn || !menuModal || !closeBtn) return;
      
      // Show menu button only on mobile
      const updateMenuVisibility = ()=>{
        if (window.innerWidth <= 768){
          menuBtn.style.display = 'flex';
        } else {
          menuBtn.style.display = 'none';
          menuModal.style.display = 'none';
        }
      };
      
      updateMenuVisibility();
      window.addEventListener('resize', updateMenuVisibility);
      
      // Open menu
      menuBtn.addEventListener('click', ()=>{
        menuModal.style.display = 'block';
      });
      
      // Close menu
      const closeMenu = ()=>{
        menuModal.style.display = 'none';
      };
      
      closeBtn.addEventListener('click', closeMenu);
      menuModal.addEventListener('click', (e)=>{
        if (e.target === menuModal) closeMenu();
      });
      
      // Menu item actions
      document.getElementById('mobileOpenBtn').addEventListener('click', ()=>{
        closeMenu();
        document.getElementById('openBtn').click();
      });
      
      document.getElementById('mobileSaveBtn').addEventListener('click', ()=>{
        closeMenu();
        document.getElementById('saveBtn').click();
      });
      
      document.getElementById('mobileSaveAsBtn').addEventListener('click', ()=>{
        closeMenu();
        document.getElementById('saveAsBtn').click();
      });
      
      document.getElementById('mobileUrlBtn').addEventListener('click', ()=>{
        closeMenu();
        document.getElementById('urlManagerBtn').click();
      });
    })();
    
    // Mobile sidebar toggle
    (function(){
      const sidebar = document.querySelector('.sidebar');
      const toggle = document.getElementById('mobileSidebarToggle');
      const overlay = document.getElementById('mobileOverlay');
      if (!sidebar || !toggle || !overlay) return;

      // Show toggle button only on mobile
      const updateToggleVisibility = ()=>{
        if (window.innerWidth <= 768){
          toggle.style.display = 'block';
        } else {
          toggle.style.display = 'none';
          sidebar.classList.remove('mobile-open');
          overlay.classList.remove('show');
        }
      };
      
      updateToggleVisibility();
      window.addEventListener('resize', updateToggleVisibility);

      // Toggle sidebar
      toggle.addEventListener('click', ()=>{
        const isOpen = sidebar.classList.toggle('mobile-open');
        overlay.classList.toggle('show', isOpen);
      });

      // ‚úÖ Close on overlay click (Î¨∏Ï†ú Ìï¥Í≤∞!)
      overlay.addEventListener('click', ()=>{
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('show');
      });

      // Close sidebar when item is clicked (mobile only)
      sidebar.addEventListener('click', (e)=>{
        if (window.innerWidth <= 768 && e.target.closest('.item')){
          sidebar.classList.remove('mobile-open');
          overlay.classList.remove('show');
        }
      });
    })();

    // Tool card collapse/expand functionality
    (function(){
      const toolbox = document.getElementById('toolbox');
      if (!toolbox) return;
      
      // Load collapsed state from localStorage
      const loadCollapsedState = ()=>{
        try {
          const saved = localStorage.getItem('doha_collapsed_cards');
          return saved ? JSON.parse(saved) : {};
        } catch(_){ return {}; }
      };
      
      // Save collapsed state to localStorage
      const saveCollapsedState = (state)=>{
        try {
          localStorage.setItem('doha_collapsed_cards', JSON.stringify(state));
        } catch(_){}
      };
      
      const collapsedState = loadCollapsedState();
      
      // Initialize all tool cards
      const cards = toolbox.querySelectorAll('.tool-card');
      cards.forEach((card, idx)=>{
        const h4 = card.querySelector('h4');
        const body = card.querySelector('.tool-card-body');
        if (!h4 || !body) return;
        
        const cardKey = `card_${idx}`;
        
        // Apply saved state
        if (collapsedState[cardKey]){
          card.classList.add('collapsed');
          body.style.maxHeight = '0';
        } else {
          body.style.maxHeight = body.scrollHeight + 'px';
        }
        
        // Toggle on click
        h4.addEventListener('click', (e)=>{
          e.preventDefault();
          e.stopPropagation();
          
          const isCollapsed = card.classList.toggle('collapsed');
          
          if (isCollapsed){
            body.style.maxHeight = '0';
            collapsedState[cardKey] = true;
          } else {
            body.style.maxHeight = body.scrollHeight + 'px';
            delete collapsedState[cardKey];
          }
          
          saveCollapsedState(collapsedState);
        });
        
        // Update max-height when content changes (for dynamic content like stats)
        const updateMaxHeight = ()=>{
          if (!card.classList.contains('collapsed')){
            body.style.maxHeight = body.scrollHeight + 'px';
          }
        };
        
        // Observe content changes
        const observer = new MutationObserver(updateMaxHeight);
        observer.observe(body, { childList: true, subtree: true, characterData: true });
      });
    })();
  </script>
</body>
</html>


